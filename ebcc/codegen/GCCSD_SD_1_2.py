# Code generated by qwick.

import numpy as np
from pyscf import lib
from types import SimpleNamespace
from ebcc.util import pack_2e

def energy(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, **kwargs):
    # Energy
    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += einsum("jiba->ijab", t2)
    x0 += einsum("ia,jb->ijab", t1, t1) * 2
    e_cc = 0
    e_cc += einsum("ijab,ijab->", v.oovv, x0) * 0.25
    del x0
    x1 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x1 += einsum("sia->sia", u11)
    x1 += einsum("s,ia->sia", s1, t1)
    e_cc += einsum("sia,sia->", g.bov, x1)
    del x1
    e_cc += einsum("ia,ia->", f.ov, t1)
    e_cc += einsum("s,s->", G, s1)

    return e_cc

def update_amps(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    # T1, T2, S1, S2, U11 and U12 amplitudes
    x0 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x0 += einsum("jc,klbc->jklb", t1, v.oovv)
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += einsum("jlkb->jklb", x0) * -1
    x30 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x30 += einsum("kmbc,jmlc->jklb", t2, x0)
    x31 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x31 -= einsum("jlkb->jklb", x30)
    del x30
    x65 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x65 += einsum("kb,jmlb->jklm", t1, x0)
    x66 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x66 += einsum("mljk->jklm", x65) * -1
    x67 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x67 += einsum("mljk->jklm", x65) * -1
    del x65
    x107 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x107 += einsum("lkjb->jklb", x0)
    del x0
    x1 += einsum("lkjb->jklb", v.ooov)
    t1new = np.zeros((nocc, nvir), dtype=np.float64)
    t1new += einsum("klcb,jklc->jb", t2, x1) * -0.5
    del x1
    x2 = np.zeros((nocc, nvir), dtype=np.float64)
    x2 += einsum("u,ujb->jb", s1, g.bov)
    x4 = np.zeros((nocc, nvir), dtype=np.float64)
    x4 += einsum("jb->jb", x2)
    x11 = np.zeros((nocc, nvir), dtype=np.float64)
    x11 += einsum("jb->jb", x2)
    del x2
    x3 = np.zeros((nocc, nvir), dtype=np.float64)
    x3 += einsum("kc,jkbc->jb", t1, v.oovv)
    x4 += einsum("jb->jb", x3)
    x11 += einsum("jb->jb", x3)
    del x3
    x4 += einsum("jb->jb", f.ov)
    x38 = np.zeros((nocc, nocc), dtype=np.float64)
    x38 += einsum("jb,kb->jk", t1, x4)
    x39 = np.zeros((nocc, nocc), dtype=np.float64)
    x39 += einsum("jk->jk", x38)
    del x38
    x52 = np.zeros((nvir, nvir), dtype=np.float64)
    x52 += einsum("jb,jc->bc", t1, x4)
    x53 = np.zeros((nvir, nvir), dtype=np.float64)
    x53 += einsum("bc->bc", x52)
    del x52
    x90 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x90 += einsum("kb,ujb->ujk", x4, u11)
    x93 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x93 += einsum("ukj->ujk", x90)
    del x90
    t1new += einsum("kc,kjcb->jb", x4, t2)
    s1new = np.zeros((nbos), dtype=np.float64)
    s1new += einsum("jb,ujb->u", x4, u11)
    s2new = np.zeros((nbos, nbos), dtype=np.float64)
    s2new += einsum("jb,xujb->ux", x4, u12)
    del x4
    x5 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x5 += einsum("kb,ujb->ujk", t1, g.bov)
    x6 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x6 += einsum("ujk->ujk", x5)
    del x5
    x6 += einsum("ujk->ujk", g.boo)
    x25 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x25 += einsum("kb,ukj->ujb", t1, x6)
    x26 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x26 -= einsum("ujb->ujb", x25)
    del x25
    t1new -= einsum("ukb,ukj->jb", u11, x6)
    u11new = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    u11new -= einsum("xkj,xukb->ujb", x6, u12)
    del x6
    x7 = np.zeros((nocc, nocc), dtype=np.float64)
    x7 += einsum("u,ujk->jk", s1, g.boo)
    x13 = np.zeros((nocc, nocc), dtype=np.float64)
    x13 += einsum("jk->jk", x7) * 2
    x39 += einsum("kj->jk", x7)
    del x7
    x8 = np.zeros((nocc, nocc), dtype=np.float64)
    x8 += einsum("ujb,ukb->jk", g.bov, u11)
    x13 += einsum("jk->jk", x8) * 2
    x41 = np.zeros((nocc, nocc), dtype=np.float64)
    x41 += einsum("jk->jk", x8)
    del x8
    x9 = np.zeros((nocc, nocc), dtype=np.float64)
    x9 -= einsum("lb,ljkb->jk", t1, v.ooov)
    x13 += einsum("jk->jk", x9) * 2
    x41 += einsum("jk->jk", x9)
    del x9
    x42 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x42 += einsum("lk,ljbc->jkbc", x41, t2)
    del x41
    x43 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x43 -= einsum("jkcb->jkbc", x42)
    del x42
    x10 = np.zeros((nocc, nocc), dtype=np.float64)
    x10 -= einsum("jlcb,lkcb->jk", t2, v.oovv)
    x13 += einsum("kj->jk", x10)
    x45 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x45 += einsum("kl,jlbc->jkbc", x10, t2)
    del x10
    x46 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x46 += einsum("jkcb->jkbc", x45) * -0.5
    del x45
    x11 += einsum("jb->jb", f.ov)
    x12 = np.zeros((nocc, nocc), dtype=np.float64)
    x12 += einsum("jb,kb->jk", t1, x11) * 2
    x13 += einsum("kj->jk", x12)
    del x12
    x77 = np.zeros((nvir, nvir), dtype=np.float64)
    x77 += einsum("jb,jc->bc", t1, x11) * 2
    del x11
    x78 = np.zeros((nvir, nvir), dtype=np.float64)
    x78 += einsum("bc->bc", x77)
    del x77
    x13 += einsum("jk->jk", f.oo) * 2
    t1new += einsum("kb,kj->jb", t1, x13) * -0.5
    u11new += einsum("kj,ukb->ujb", x13, u11) * -0.5
    u12new = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    u12new += einsum("kj,xukb->uxjb", x13, u12) * -0.5
    del x13
    x14 = np.zeros((nvir, nvir), dtype=np.float64)
    x14 += einsum("u,ubc->bc", s1, g.bvv)
    x16 = np.zeros((nvir, nvir), dtype=np.float64)
    x16 += einsum("bc->bc", x14)
    x53 -= einsum("bc->bc", x14)
    x54 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x54 += einsum("cd,jkdb->jkbc", x53, t2)
    del x53
    x58 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x58 -= einsum("kjcb->jkbc", x54)
    del x54
    x78 += einsum("bc->bc", x14) * -2
    del x14
    x15 = np.zeros((nvir, nvir), dtype=np.float64)
    x15 -= einsum("jd,jbdc->bc", t1, v.ovvv)
    x16 -= einsum("bc->bc", x15)
    x56 = np.zeros((nvir, nvir), dtype=np.float64)
    x56 += einsum("bc->bc", x15)
    x78 += einsum("bc->bc", x15) * 2
    del x15
    x16 += einsum("bc->bc", f.vv)
    t1new += einsum("jc,bc->jb", t1, x16)
    del x16
    x17 = np.zeros((nbos), dtype=np.float64)
    x17 += einsum("jb,ujb->u", t1, g.bov)
    x18 = np.zeros((nbos), dtype=np.float64)
    x18 += einsum("u->u", x17)
    del x17
    x18 += einsum("u->u", G)
    t1new += einsum("u,ujb->jb", x18, u11)
    s1new += einsum("x,xu->u", x18, s2)
    u11new += einsum("x,xujb->ujb", x18, u12)
    del x18
    x19 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x19 += einsum("je,bcde->jbcd", t1, v.vvvv)
    t2new = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    t2new -= einsum("jd,kcbd->jkbc", t1, x19)
    del x19
    x20 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x20 += einsum("jlbd,lckd->jkbc", t2, v.ovov)
    x33 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x33 -= einsum("jkbc->jkbc", x20)
    del x20
    x21 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x21 += einsum("jd,kbcd->jkbc", t1, v.ovvv)
    x22 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x22 -= einsum("klbd,jlcd->jkbc", t2, x21)
    x33 += einsum("jkbc->jkbc", x22)
    del x22
    x48 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x48 -= einsum("kc,jlbc->jklb", t1, x21)
    x49 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x49 -= einsum("lb,kjlc->jkbc", t1, x48)
    del x48
    x58 += einsum("jkbc->jkbc", x49)
    del x49
    x106 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x106 -= einsum("kjbc->jkbc", x21)
    del x21
    x23 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x23 += einsum("jc,ubc->ujb", t1, g.bvv)
    x26 += einsum("ujb->ujb", x23)
    del x23
    x24 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x24 += einsum("ukc,jkbc->ujb", g.bov, t2)
    x26 += einsum("ujb->ujb", x24)
    del x24
    x26 += einsum("ubj->ujb", g.bvo)
    x27 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x27 += einsum("ujb,ukc->jkbc", u11, x26)
    del x26
    x33 += einsum("kjcb->jkbc", x27)
    del x27
    x28 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x28 += einsum("jc,kblc->jklb", t1, v.ovov)
    x31 += einsum("jklb->jklb", x28)
    del x28
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 -= einsum("jmbc,mklc->jklb", t2, v.ooov)
    x31 += einsum("jklb->jklb", x29)
    del x29
    x32 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x32 += einsum("lb,jlkc->jkbc", t1, x31)
    del x31
    x33 += einsum("jkbc->jkbc", x32)
    del x32
    t2new += einsum("jkbc->jkbc", x33)
    t2new -= einsum("jkcb->jkbc", x33)
    t2new -= einsum("kjbc->jkbc", x33)
    t2new += einsum("kjcb->jkbc", x33)
    del x33
    x34 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x34 += einsum("jd,bckd->jkbc", t1, v.vvov)
    x43 += einsum("jkcb->jkbc", x34)
    del x34
    x35 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x35 += einsum("jb,klmb->jklm", t1, v.ooov)
    x36 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x36 += einsum("mb,jkml->jklb", t1, x35)
    x37 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x37 -= einsum("lc,jlkb->jkbc", t1, x36)
    del x36
    x43 += einsum("jkcb->jkbc", x37)
    del x37
    x44 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x44 += einsum("mlbc,jmlk->jkbc", t2, x35)
    del x35
    x46 += einsum("jkcb->jkbc", x44) * -0.5
    del x44
    t2new += einsum("jkbc->jkbc", x46) * -1
    t2new += einsum("kjbc->jkbc", x46)
    del x46
    x39 += einsum("kj->jk", f.oo)
    x40 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x40 += einsum("kl,ljbc->jkbc", x39, t2)
    del x39
    x43 += einsum("kjcb->jkbc", x40)
    del x40
    t2new += einsum("jkbc->jkbc", x43)
    t2new -= einsum("kjbc->jkbc", x43)
    del x43
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += einsum("bd,jkcd->jkbc", f.vv, t2)
    t2new += einsum("kjbc->jkbc", x47)
    t2new -= einsum("kjcb->jkbc", x47)
    del x47
    x50 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x50 += einsum("jlbd,lkdc->jkbc", t2, v.oovv)
    x51 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x51 += einsum("jlbd,klcd->jkbc", t2, x50)
    del x50
    x58 -= einsum("jkbc->jkbc", x51)
    del x51
    x55 = np.zeros((nvir, nvir), dtype=np.float64)
    x55 += einsum("ujb,ujc->bc", g.bov, u11)
    x56 += einsum("cb->bc", x55)
    x57 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x57 += einsum("cd,jkdb->jkbc", x56, t2)
    del x56
    x58 += einsum("kjbc->jkbc", x57)
    del x57
    t2new -= einsum("jkbc->jkbc", x58)
    t2new += einsum("jkcb->jkbc", x58)
    del x58
    x78 += einsum("cb->bc", x55) * 2
    del x55
    x59 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x59 += einsum("jkdc,lbdc->jklb", t2, v.ovvv)
    x60 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x60 += einsum("lb,jklc->jkbc", t1, x59)
    del x59
    x63 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x63 += einsum("jkbc->jkbc", x60) * 0.5
    del x60
    x61 = np.zeros((nvir, nvir), dtype=np.float64)
    x61 -= einsum("kjbd,kjdc->bc", t2, v.oovv)
    x62 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x62 += einsum("cd,jkbd->jkbc", x61, t2)
    x63 += einsum("jkbc->jkbc", x62) * 0.5
    del x62
    t2new += einsum("jkbc->jkbc", x63) * -1
    t2new += einsum("jkcb->jkbc", x63)
    del x63
    x78 += einsum("bc->bc", x61)
    del x61
    x64 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x64 += einsum("jkcb,lmcb->jklm", t2, v.oovv)
    x66 += einsum("mlkj->jklm", x64) * 0.49999999999999967
    x67 += einsum("mlkj->jklm", x64) * 0.5000000000000003
    del x64
    x66 += einsum("kjml->jklm", v.oooo) * 0.9999999999999993
    t2new += einsum("lmcb,lmkj->jkbc", t2, x66) * 0.5000000000000003
    del x66
    x67 += einsum("kjml->jklm", v.oooo)
    x68 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x68 += einsum("mb,mlkj->jklb", t1, x67)
    del x67
    x68 += einsum("lbkj->jklb", v.ovoo)
    t2new += einsum("lb,jklc->jkbc", t1, x68)
    del x68
    x69 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x69 += einsum("ukc,kjcb->ujb", u11, v.oovv)
    x76 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x76 += einsum("ujb->ujb", x69)
    x99 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x99 += einsum("jb,ujc->ubc", t1, x69)
    x100 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x100 += einsum("ucb->ubc", x99)
    del x99
    x102 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x102 += einsum("jb,ukb->ujk", t1, x69)
    x103 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x103 += einsum("ukj->ujk", x102)
    del x102
    s2new += einsum("ujb,xjb->ux", u11, x69)
    del x69
    x70 = np.zeros((nbos, nbos), dtype=np.float64)
    x70 += einsum("ujb,xjb->ux", gc.bov, u11)
    x74 = np.zeros((nbos, nbos), dtype=np.float64)
    x74 += einsum("ux->ux", x70)
    del x70
    x71 = np.zeros((nbos, nbos), dtype=np.float64)
    x71 += einsum("ujb,xjb->ux", g.bov, u11)
    x72 = np.zeros((nbos, nbos), dtype=np.float64)
    x72 += einsum("xu->ux", x71)
    x89 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x89 += einsum("yu,xyjb->uxjb", x71, u12)
    del x71
    x105 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x105 -= einsum("uxjb->uxjb", x89)
    del x89
    x72 += einsum("ux->ux", w)
    x73 = np.zeros((nbos, nbos), dtype=np.float64)
    x73 += einsum("yu,xy->ux", s2, x72)
    x74 += einsum("ux->ux", x73)
    del x73
    s2new += einsum("ux->ux", x74)
    s2new += einsum("xu->ux", x74)
    del x74
    u11new += einsum("ux,xjb->ujb", x72, u11)
    del x72
    x75 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x75 += einsum("ux,xjb->ujb", s2, g.bov)
    x76 += einsum("ujb->ujb", x75)
    x91 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x91 += einsum("ujb->ujb", x75)
    del x75
    x76 += einsum("ujb->ujb", gc.bov)
    x82 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x82 += einsum("kb,ujb->ujk", t1, x76)
    u11new += einsum("ukc,kjcb->ujb", x76, t2)
    del x76
    x78 += einsum("bc->bc", f.vv) * -2
    u11new += einsum("bc,ujc->ujb", x78, u11) * -0.5
    u12new += einsum("bc,xujc->uxjb", x78, u12) * -0.5
    del x78
    x79 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x79 += einsum("ux,xjk->ujk", s2, g.boo)
    x82 += einsum("ujk->ujk", x79)
    x93 += einsum("ujk->ujk", x79)
    del x79
    x80 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x80 += einsum("xjb,uxkb->ujk", g.bov, u12)
    x82 += einsum("ujk->ujk", x80)
    x103 += einsum("ujk->ujk", x80)
    del x80
    x81 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x81 -= einsum("ulb,ljkb->ujk", u11, v.ooov)
    x82 += einsum("ujk->ujk", x81)
    x103 += einsum("ujk->ujk", x81)
    del x81
    x104 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x104 += einsum("ukb,xkj->uxjb", u11, x103)
    del x103
    x105 += einsum("uxjb->uxjb", x104)
    del x104
    x82 += einsum("ujk->ujk", gc.boo)
    u11new -= einsum("kb,ukj->ujb", t1, x82)
    del x82
    x83 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x83 += einsum("ux,xbc->ubc", s2, g.bvv)
    x85 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x85 += einsum("ubc->ubc", x83)
    x96 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x96 += einsum("ubc->ubc", x83)
    del x83
    x84 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x84 -= einsum("ujd,jbdc->ubc", u11, v.ovvv)
    x85 -= einsum("ubc->ubc", x84)
    x100 += einsum("ucb->ubc", x84)
    del x84
    x85 += einsum("ubc->ubc", gc.bvv)
    u11new += einsum("jc,ubc->ujb", t1, x85)
    del x85
    x86 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x86 += einsum("uxkc,kjcb->uxjb", u12, v.oovv)
    u12new += einsum("jkbc,xukc->uxjb", t2, x86)
    del x86
    x87 = np.zeros((nbos, nbos, nbos), dtype=np.float64)
    x87 += einsum("ujb,xyjb->uxy", g.bov, u12)
    u12new += einsum("yjb,yxu->uxjb", u11, x87)
    del x87
    x88 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x88 += einsum("xy,uyjb->uxjb", w, u12)
    x105 -= einsum("uxjb->uxjb", x88)
    del x88
    x91 += einsum("ujb->ujb", gc.bov)
    x92 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x92 += einsum("jb,ukb->ujk", t1, x91)
    x93 += einsum("ukj->ujk", x92)
    del x92
    x95 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x95 += einsum("jb,ujc->ubc", t1, x91)
    del x91
    x96 -= einsum("ubc->ubc", x95)
    del x95
    x93 += einsum("ujk->ujk", gc.boo)
    x94 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x94 += einsum("ukb,xkj->uxjb", u11, x93)
    del x93
    x105 += einsum("xujb->uxjb", x94)
    del x94
    x96 += einsum("ubc->ubc", gc.bvv)
    x97 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x97 += einsum("ujc,xbc->uxjb", u11, x96)
    del x96
    x105 -= einsum("xujb->uxjb", x97)
    del x97
    x98 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x98 += einsum("xjb,uxjc->ubc", g.bov, u12)
    x100 += einsum("ubc->ubc", x98)
    del x98
    x101 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x101 += einsum("ujc,xcb->uxjb", u11, x100)
    del x100
    x105 += einsum("uxjb->uxjb", x101)
    del x101
    u12new -= einsum("uxjb->uxjb", x105)
    u12new -= einsum("xujb->uxjb", x105)
    del x105
    x106 += einsum("jbkc->jkbc", v.ovov)
    u12new -= einsum("xukc,kjbc->uxjb", u12, x106)
    del x106
    x107 -= einsum("kjlb->jklb", v.ooov)
    x108 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x108 -= einsum("xulb,ljkb->uxjk", u12, x107)
    del x107
    u12new -= einsum("kb,xukj->uxjb", t1, x108)
    del x108
    t1new -= einsum("kc,kbjc->jb", t1, v.ovov)
    t1new += einsum("u,ubj->jb", s1, g.bvo)
    t1new += einsum("jkdc,kbdc->jb", t2, v.ovvv) * -0.5
    t1new += einsum("bj->jb", f.vo)
    t1new += einsum("ubc,ujc->jb", g.bvv, u11)
    t2new += einsum("kjed,cbed->jkbc", t2, v.vvvv) * 0.5
    t2new -= einsum("lc,lbkj->jkbc", t1, v.ovoo)
    t2new += einsum("cbkj->jkbc", v.vvoo)
    s1new += einsum("jb,ujb->u", t1, gc.bov)
    s1new += einsum("u->u", G)
    s1new += einsum("xjb,uxjb->u", g.bov, u12)
    s1new += einsum("x,ux->u", s1, w)
    u11new -= einsum("ukc,kbjc->ujb", u11, v.ovov)
    u11new += einsum("xbc,uxjc->ujb", g.bvv, u12)
    u11new += einsum("ubj->ujb", gc.bvo)
    u11new += einsum("ux,xbj->ujb", s2, g.bvo)

    return {"t1new": t1new, "t2new": t2new, "s1new": s1new, "s2new": s2new, "u11new": u11new, "u12new": u12new}

def update_lams(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    # L1, L2, LS1, LS2, LU11 and LU12 amplitudes
    x0 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x0 -= einsum("VpB,BAop->VoA", u11, l2)
    x86 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x86 += einsum("pA,VoA->Vop", t1, x0) * 2
    x118 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x118 += einsum("VoA->VoA", x0)
    l1new = np.zeros((nvir, nocc), dtype=np.float64)
    l1new += einsum("VBA,VoB->Ao", g.bvv, x0)
    x1 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x1 += einsum("BAop,IJBA->opIJ", l2, t2)
    x18 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x18 += einsum("poJI->opIJ", x1) * -1
    x147 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x147 += einsum("poJI->opIJ", x1) * -0.5
    l1new += einsum("JIpA,opJI->Ao", v.ooov, x1) * -0.25
    del x1
    x2 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x2 += einsum("IB,ABop->opIA", t1, l2)
    x3 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x3 += einsum("IA,opJA->opIJ", t1, x2)
    x18 += einsum("opJI->opIJ", x3) * 2.0000000000000013
    x19 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x19 += einsum("JA,JoIp->opIA", t1, x18) * 0.25
    del x18
    x147 += einsum("opJI->opIJ", x3)
    l2new = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    l2new += einsum("IJBA,poIJ->ABop", v.oovv, x147) * -0.5
    del x147
    l1new += einsum("IpJA,oJpI->Ao", v.ooov, x3) * 0.5
    del x3
    x19 += einsum("IJAB,oJpB->opIA", t2, x2) * -1
    x56 = np.zeros((nocc, nvir), dtype=np.float64)
    x56 += einsum("IpBA,IpoB->oA", t2, x2)
    x65 = np.zeros((nocc, nvir), dtype=np.float64)
    x65 += einsum("oA->oA", x56)
    del x56
    l2new += einsum("ICBA,poIC->ABop", v.ovvv, x2)
    x4 = np.zeros((nocc, nocc), dtype=np.float64)
    x4 += einsum("Ao,pA->op", l1, t1)
    x63 = np.zeros((nocc, nocc), dtype=np.float64)
    x63 += einsum("op->op", x4) * 2
    x88 = np.zeros((nocc, nocc), dtype=np.float64)
    x88 += einsum("op->op", x4) * 2
    x125 = np.zeros((nocc, nocc), dtype=np.float64)
    x125 += einsum("op->op", x4)
    x154 = np.zeros((nocc, nocc), dtype=np.float64)
    x154 += einsum("op->op", x4)
    x5 = np.zeros((nocc, nvir), dtype=np.float64)
    x5 += einsum("V,VoA->oA", s1, g.bov)
    x10 = np.zeros((nocc, nvir), dtype=np.float64)
    x10 += einsum("oA->oA", x5)
    x74 = np.zeros((nocc, nvir), dtype=np.float64)
    x74 += einsum("oA->oA", x5)
    x100 = np.zeros((nocc, nvir), dtype=np.float64)
    x100 += einsum("oA->oA", x5)
    l1new -= einsum("op,pA->Ao", x4, x5)
    del x4
    del x5
    x6 = np.zeros((nocc, nocc), dtype=np.float64)
    x6 += einsum("BAIo,IpBA->op", l2, t2)
    x19 += einsum("IA,op->opIA", t1, x6) * 0.5
    x63 += einsum("op->op", x6)
    x85 = np.zeros((nocc, nocc), dtype=np.float64)
    x85 += einsum("op->op", x6) * 0.5
    x132 = np.zeros((nocc, nocc), dtype=np.float64)
    x132 += einsum("op->op", x6)
    x154 += einsum("op->op", x6) * 0.5
    l1new += einsum("pA,op->Ao", f.ov, x6) * -0.5
    del x6
    x7 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x7 += einsum("oB,pIAB->opIA", t1, v.oovv)
    x8 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x8 += einsum("oIpA->opIA", x7) * -1
    x12 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x12 += einsum("IpoA->opIA", x7) * 0.5000000000000003
    x23 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x23 += einsum("IpoA->opIA", x7)
    x115 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x115 -= einsum("oIpA->opIA", x7)
    x145 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x145 += einsum("IpoA->opIA", x7) * 0.5
    x8 += einsum("IpoA->opIA", v.ooov)
    x16 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x16 += einsum("JIBA,pJoB->opIA", t2, x8) * 1.9999999999999987
    x32 = np.zeros((nocc, nvir), dtype=np.float64)
    x32 += einsum("pIBA,opIB->oA", t2, x8)
    x51 = np.zeros((nocc, nvir), dtype=np.float64)
    x51 += einsum("oA->oA", x32)
    del x32
    x168 = np.zeros((nocc, nvir), dtype=np.float64)
    x168 += einsum("pIBA,opIB->oA", t2, x8) * 0.5
    del x8
    x9 = np.zeros((nocc, nvir), dtype=np.float64)
    x9 += einsum("pB,opAB->oA", t1, v.oovv)
    x10 += einsum("oA->oA", x9)
    x74 += einsum("oA->oA", x9)
    x89 = np.zeros((nocc, nvir), dtype=np.float64)
    x89 += einsum("oA->oA", x9)
    x106 = np.zeros((nvir, nvir), dtype=np.float64)
    x106 += einsum("oA,oB->AB", t1, x9)
    x107 = np.zeros((nvir, nvir), dtype=np.float64)
    x107 += einsum("AB->AB", x106)
    del x106
    x120 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x120 += einsum("Ao,pB->opAB", l1, x9)
    x127 = np.zeros((nocc, nocc), dtype=np.float64)
    x127 += einsum("oA,pA->op", t1, x9)
    del x9
    x128 = np.zeros((nocc, nocc), dtype=np.float64)
    x128 += einsum("po->op", x127)
    del x127
    x10 += einsum("oA->oA", f.ov)
    x16 += einsum("oB,IpBA->opIA", x10, t2) * -0.9999999999999993
    x27 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x27 += einsum("oA,WVpA->VWop", x10, u12) * 0.5
    x33 = np.zeros((nocc, nvir), dtype=np.float64)
    x33 += einsum("pB,poBA->oA", x10, t2) * 2
    x51 += einsum("oA->oA", x33) * -1
    del x33
    x41 = np.zeros((nocc, nocc), dtype=np.float64)
    x41 += einsum("oA,pA->op", t1, x10)
    x42 = np.zeros((nocc, nocc), dtype=np.float64)
    x42 += einsum("po->op", x41)
    del x41
    x84 = np.zeros((nbos, nbos), dtype=np.float64)
    x84 += einsum("oA,WVoA->VW", x10, u12) * 0.5
    x148 = np.zeros((nvir, nvir), dtype=np.float64)
    x148 += einsum("oA,oB->AB", t1, x10)
    x149 = np.zeros((nvir, nvir), dtype=np.float64)
    x149 += einsum("AB->AB", x148)
    del x148
    x168 += einsum("pB,poBA->oA", x10, t2) * -1
    lu11new = np.zeros((nbos, nvir, nocc), dtype=np.float64)
    lu11new += einsum("V,oA->VAo", ls1, x10) * 2
    lu12new = np.zeros((nbos, nbos, nvir, nocc), dtype=np.float64)
    lu12new += einsum("WV,oA->VWAo", ls2, x10) * 2
    del x10
    x11 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x11 += einsum("opBA,IJBA->opIJ", t2, v.oovv)
    x13 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x13 += einsum("JIpo->opIJ", x11)
    x146 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x146 += einsum("JIpo->opIJ", x11)
    del x11
    x12 += einsum("poIA->opIA", v.ooov) * -1
    x13 += einsum("JA,poIA->opIJ", t1, x12) * -4
    del x12
    x13 += einsum("poJI->opIJ", v.oooo) * 2
    x16 += einsum("JA,JoIp->opIA", t1, x13) * -0.49999999999999967
    del x13
    x14 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x14 += einsum("oC,pABC->opAB", t1, v.ovvv)
    x15 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x15 += einsum("poAB->opAB", x14) * -0.5
    x22 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x22 -= einsum("poAB->opAB", x14)
    x113 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x113 += einsum("opAB->opAB", x14)
    del x14
    x15 += einsum("oApB->opAB", v.ovov)
    x16 += einsum("pB,oIAB->opIA", t1, x15) * -1.9999999999999987
    del x15
    x16 += einsum("oAIp->opIA", v.ovoo) * -0.9999999999999993
    x16 += einsum("IpCB,oACB->opIA", t2, v.ovvv) * -0.49999999999999967
    l1new += einsum("BApI,opIB->Ao", l2, x16) * 0.5000000000000003
    del x16
    x17 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x17 += einsum("pA,VWAo->VWop", t1, lu12)
    x19 += einsum("WVIA,WVop->opIA", u12, x17) * 0.5
    x55 = np.zeros((nocc, nvir), dtype=np.float64)
    x55 += einsum("WVpA,WVpo->oA", u12, x17)
    x65 += einsum("oA->oA", x55)
    del x55
    x159 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x159 += einsum("WpA,VWpo->VoA", u11, x17)
    x160 = np.zeros((nbos, nbos), dtype=np.float64)
    x160 += einsum("VoA,WoA->VW", g.bov, x159)
    del x159
    x167 = np.zeros((nbos, nbos), dtype=np.float64)
    x167 -= einsum("VW->VW", x160)
    del x160
    lu12new += einsum("opIA,WVIp->VWAo", v.ooov, x17)
    lu12new -= einsum("WVpI,poIA->VWAo", x17, x7)
    del x17
    del x7
    x19 += einsum("Bo,IpAB->opIA", l1, t2) * 0.5
    l1new += einsum("pIBA,opIB->Ao", v.oovv, x19)
    del x19
    x20 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x20 += einsum("WVAo,WVpB->opAB", lu12, u12)
    x20 += einsum("CAoI,pIBC->opAB", l2, t2) * -2
    l1new += einsum("pBCA,opBC->Ao", v.ovvv, x20) * 0.5
    del x20
    x21 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x21 += einsum("BAoC->oABC", v.vvov) * -1
    x21 += einsum("oD,BACD->oABC", t1, v.vvvv)
    l1new += einsum("BCpo,pBCA->Ao", l2, x21) * 0.5
    del x21
    x22 += einsum("oApB->opAB", v.ovov)
    l1new += einsum("poIB,IpBA->Ao", x2, x22)
    lu12new -= einsum("WVBp,opBA->VWAo", lu12, x22)
    del x22
    x23 += einsum("poIA->opIA", v.ooov) * -1
    x27 += einsum("WVIA,IopA->VWop", u12, x23) * -0.5
    del x23
    x24 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x24 += einsum("WV,WoA->VoA", s2, g.bov)
    x26 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x26 += einsum("VoA->VoA", x24)
    x75 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x75 += einsum("VoA->VoA", x24)
    del x24
    x25 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x25 += einsum("VpB,opAB->VoA", u11, v.oovv)
    x26 += einsum("VoA->VoA", x25)
    x75 += einsum("VoA->VoA", x25)
    x81 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x81 += einsum("VoA->VoA", x25) * 0.5
    x111 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x111 += einsum("VAo,VpB->opAB", lu11, x25)
    del x25
    x120 += einsum("opAB->opAB", x111)
    del x111
    x26 += einsum("VoA->VoA", gc.bov)
    x27 += einsum("VpA,WoA->VWop", u11, x26)
    l1new += einsum("VWAp,VWop->Ao", lu12, x27) * -1
    del x27
    x150 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x150 += einsum("pA,VoA->Vop", t1, x26)
    x152 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x152 += einsum("VpB,poBA->VoA", x26, t2)
    del x26
    x28 = np.zeros((nocc, nvir), dtype=np.float64)
    x28 += einsum("V,VAo->oA", s1, g.bvo)
    x51 += einsum("oA->oA", x28) * -2
    x168 += einsum("oA->oA", x28) * -1
    del x28
    x29 = np.zeros((nocc, nvir), dtype=np.float64)
    x29 += einsum("VAB,VoB->oA", g.bvv, u11)
    x51 += einsum("oA->oA", x29) * -2
    x168 += einsum("oA->oA", x29) * -1
    del x29
    x30 = np.zeros((nocc, nvir), dtype=np.float64)
    x30 += einsum("pB,pAoB->oA", t1, v.ovov)
    x51 += einsum("oA->oA", x30) * 2
    x168 += einsum("oA->oA", x30)
    del x30
    x31 = np.zeros((nocc, nvir), dtype=np.float64)
    x31 -= einsum("poCB,pACB->oA", t2, v.ovvv)
    x51 += einsum("oA->oA", x31)
    x168 += einsum("oA->oA", x31) * 0.5
    del x31
    x34 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x34 += einsum("pA,VoA->Vop", t1, g.bov)
    x35 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x35 += einsum("Vop->Vop", x34)
    x87 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x87 += einsum("Vop->Vop", x34)
    del x34
    x35 += einsum("Vop->Vop", g.boo)
    x36 = np.zeros((nocc, nvir), dtype=np.float64)
    x36 += einsum("VpA,Vpo->oA", u11, x35) * 2
    x51 += einsum("oA->oA", x36)
    del x36
    x152 += einsum("Wpo,WVpA->VoA", x35, u12) * -1
    x168 += einsum("VpA,Vpo->oA", u11, x35)
    del x35
    x37 = np.zeros((nocc, nocc), dtype=np.float64)
    x37 += einsum("V,Vop->op", s1, g.boo)
    x42 += einsum("op->op", x37)
    x123 = np.zeros((nocc, nocc), dtype=np.float64)
    x123 += einsum("op->op", x37)
    del x37
    x38 = np.zeros((nocc, nocc), dtype=np.float64)
    x38 += einsum("VoA,VpA->op", g.bov, u11)
    x42 += einsum("op->op", x38)
    x123 += einsum("op->op", x38)
    del x38
    x39 = np.zeros((nocc, nocc), dtype=np.float64)
    x39 -= einsum("IA,IopA->op", t1, v.ooov)
    x42 += einsum("op->op", x39)
    x128 += einsum("op->op", x39)
    del x39
    x129 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x129 += einsum("pI,ABIo->opAB", x128, l2)
    del x128
    x130 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x130 -= einsum("opBA->opAB", x129)
    del x129
    x40 = np.zeros((nocc, nocc), dtype=np.float64)
    x40 += einsum("IoBA,IpBA->op", t2, v.oovv)
    x42 += einsum("po->op", x40) * 0.5
    x131 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x131 += einsum("Ip,ABoI->opAB", x40, l2)
    del x40
    x134 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x134 += einsum("opBA->opAB", x131) * -0.5
    del x131
    x42 += einsum("op->op", f.oo)
    x43 = np.zeros((nocc, nvir), dtype=np.float64)
    x43 += einsum("pA,po->oA", t1, x42) * 2
    x51 += einsum("oA->oA", x43)
    del x43
    x152 += einsum("po,VpA->VoA", x42, u11) * -1
    x168 += einsum("pA,po->oA", t1, x42)
    l1new += einsum("Ap,op->Ao", l1, x42) * -1
    lu12new += einsum("op,WVAp->VWAo", x42, lu12) * -1
    del x42
    x44 = np.zeros((nvir, nvir), dtype=np.float64)
    x44 += einsum("V,VAB->AB", s1, g.bvv)
    x46 = np.zeros((nvir, nvir), dtype=np.float64)
    x46 += einsum("AB->AB", x44)
    x97 = np.zeros((nvir, nvir), dtype=np.float64)
    x97 += einsum("AB->AB", x44)
    x102 = np.zeros((nvir, nvir), dtype=np.float64)
    x102 -= einsum("AB->AB", x44)
    x149 += einsum("AB->AB", x44) * -1
    del x44
    x45 = np.zeros((nvir, nvir), dtype=np.float64)
    x45 += einsum("oC,oABC->AB", t1, v.ovvv)
    x46 += einsum("AB->AB", x45) * -1
    x97 -= einsum("AB->AB", x45)
    x107 += einsum("AB->AB", x45)
    x108 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x108 += einsum("CB,CAop->opAB", x107, l2)
    del x107
    x109 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x109 -= einsum("poAB->opAB", x108)
    del x108
    x149 += einsum("AB->AB", x45)
    del x45
    x46 += einsum("AB->AB", f.vv)
    x47 = np.zeros((nocc, nvir), dtype=np.float64)
    x47 += einsum("oB,AB->oA", t1, x46) * 2
    x51 += einsum("oA->oA", x47) * -1
    del x47
    x168 += einsum("oB,AB->oA", t1, x46) * -1
    del x46
    x48 = np.zeros((nbos), dtype=np.float64)
    x48 += einsum("oA,VoA->V", t1, g.bov)
    x49 = np.zeros((nbos), dtype=np.float64)
    x49 += einsum("V->V", x48)
    x94 = np.zeros((nbos), dtype=np.float64)
    x94 += einsum("V->V", x48)
    del x48
    x49 += einsum("V->V", G)
    x50 = np.zeros((nocc, nvir), dtype=np.float64)
    x50 += einsum("V,VoA->oA", x49, u11) * 2
    x51 += einsum("oA->oA", x50) * -1
    del x50
    x152 += einsum("W,WVoA->VoA", x49, u12)
    x168 += einsum("V,VoA->oA", x49, u11) * -1
    del x49
    x51 += einsum("Ao->oA", f.vo) * -2
    l1new += einsum("pB,BApo->Ao", x51, l2) * -0.5
    ls1new = np.zeros((nbos), dtype=np.float64)
    ls1new += einsum("oA,VAo->V", x51, lu11) * -0.5
    del x51
    x52 = np.zeros((nocc, nvir), dtype=np.float64)
    x52 += einsum("V,VoA->oA", ls1, u11)
    x65 += einsum("oA->oA", x52) * -2
    del x52
    x53 = np.zeros((nocc, nvir), dtype=np.float64)
    x53 += einsum("WV,WVoA->oA", ls2, u12)
    x65 += einsum("oA->oA", x53) * -1
    del x53
    x54 = np.zeros((nocc, nvir), dtype=np.float64)
    x54 += einsum("Bp,opAB->oA", l1, t2)
    x65 += einsum("oA->oA", x54) * -2
    del x54
    x57 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x57 += einsum("pA,VAo->Vop", t1, lu11)
    x59 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x59 += einsum("Vop->Vop", x57)
    x77 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x77 += einsum("Vop->Vop", x57)
    del x57
    x58 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x58 += einsum("WpA,WVAo->Vop", u11, lu12)
    x59 += einsum("Vop->Vop", x58)
    x60 = np.zeros((nocc, nvir), dtype=np.float64)
    x60 += einsum("VpA,Vpo->oA", u11, x59) * 2
    del x59
    x65 += einsum("oA->oA", x60)
    del x60
    x77 += einsum("Vop->Vop", x58)
    x176 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x176 += einsum("VpA,Wop->VWoA", g.bov, x77)
    x177 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x177 += einsum("VWoA->VWoA", x176)
    del x176
    x61 = np.zeros((nocc, nocc), dtype=np.float64)
    x61 += einsum("VAo,VpA->op", lu11, u11)
    x63 += einsum("op->op", x61) * 2
    x85 += einsum("op->op", x61)
    x88 += einsum("op->op", x61) * 2
    x125 += einsum("op->op", x61)
    x126 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x126 += einsum("pI,IoAB->opAB", x125, v.oovv)
    del x125
    x130 += einsum("poBA->opAB", x126)
    del x126
    x154 += einsum("op->op", x61)
    del x61
    x62 = np.zeros((nocc, nocc), dtype=np.float64)
    x62 += einsum("WVAo,WVpA->op", lu12, u12)
    x63 += einsum("op->op", x62)
    x64 = np.zeros((nocc, nvir), dtype=np.float64)
    x64 += einsum("pA,po->oA", t1, x63)
    x65 += einsum("oA->oA", x64)
    del x64
    l1new += einsum("Ip,poIA->Ao", x63, v.ooov) * -0.5
    del x63
    x85 += einsum("op->op", x62) * 0.5
    x86 += einsum("V,op->Vop", s1, x85) * 2
    del x85
    x88 += einsum("op->op", x62)
    x132 += einsum("op->op", x62)
    x133 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x133 += einsum("pI,IoAB->opAB", x132, v.oovv) * 0.5
    del x132
    x134 += einsum("poBA->opAB", x133) * -1
    del x133
    l2new += einsum("opAB->ABop", x134) * -1
    l2new += einsum("poAB->ABop", x134)
    del x134
    x154 += einsum("op->op", x62) * 0.5
    del x62
    ls1new += einsum("po,Vop->V", x154, g.boo) * -1
    del x154
    x65 += einsum("oA->oA", t1) * -2
    l1new += einsum("pB,poBA->Ao", x65, v.oovv) * -0.5
    ls1new += einsum("oA,VoA->V", x65, g.bov) * -0.5
    del x65
    x66 = np.zeros((nvir, nvir), dtype=np.float64)
    x66 += einsum("Ao,oB->AB", l1, t1)
    x70 = np.zeros((nvir, nvir), dtype=np.float64)
    x70 += einsum("AB->AB", x66)
    x104 = np.zeros((nvir, nvir), dtype=np.float64)
    x104 += einsum("AB->AB", x66)
    ls1new += einsum("AB,VAB->V", x66, g.bvv)
    del x66
    x67 = np.zeros((nvir, nvir), dtype=np.float64)
    x67 += einsum("VAo,VoB->AB", lu11, u11)
    x70 += einsum("AB->AB", x67)
    x104 += einsum("AB->AB", x67)
    x105 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x105 += einsum("BC,opCA->opAB", x104, v.oovv)
    del x104
    x109 += einsum("poBA->opAB", x105)
    del x105
    x153 = np.zeros((nvir, nvir), dtype=np.float64)
    x153 += einsum("AB->AB", x67) * 2
    del x67
    x68 = np.zeros((nvir, nvir), dtype=np.float64)
    x68 += einsum("WVAo,WVoB->AB", lu12, u12)
    x70 += einsum("AB->AB", x68) * 0.5
    x137 = np.zeros((nvir, nvir), dtype=np.float64)
    x137 += einsum("AB->AB", x68)
    x153 += einsum("AB->AB", x68)
    del x68
    x69 = np.zeros((nvir, nvir), dtype=np.float64)
    x69 += einsum("CApo,poCB->AB", l2, t2)
    x70 += einsum("AB->AB", x69) * 0.5
    l1new += einsum("BC,oBCA->Ao", x70, v.ovvv) * -1
    del x70
    x137 += einsum("AB->AB", x69)
    x138 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x138 += einsum("BC,opCA->opAB", x137, v.oovv) * 0.5
    del x137
    x139 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x139 += einsum("poBA->opAB", x138) * -1
    del x138
    x153 += einsum("AB->AB", x69)
    del x69
    ls1new += einsum("AB,VAB->V", x153, g.bvv) * 0.5
    del x153
    x71 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x71 += einsum("WV,Wop->Vop", s2, g.boo)
    x76 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x76 += einsum("Vop->Vop", x71)
    x150 += einsum("Vop->Vop", x71)
    del x71
    x72 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x72 += einsum("WoA,WVpA->Vop", g.bov, u12)
    x76 += einsum("Vop->Vop", x72)
    x150 += einsum("Vop->Vop", x72)
    del x72
    x73 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x73 += einsum("VIA,oIpA->Vop", u11, v.ooov)
    x76 += einsum("Vop->Vop", x73)
    x150 += einsum("Vop->Vop", x73)
    del x73
    x74 += einsum("oA->oA", f.ov)
    x76 += einsum("oA,VpA->Vop", x74, u11)
    x93 = np.zeros((nbos), dtype=np.float64)
    x93 += einsum("oA,VoA->V", x74, u11)
    del x74
    x96 = np.zeros((nbos), dtype=np.float64)
    x96 += einsum("V->V", x93)
    del x93
    x75 += einsum("VoA->VoA", gc.bov)
    x76 += einsum("pA,VoA->Vop", t1, x75)
    l1new -= einsum("VpA,Vop->Ao", x75, x77)
    del x75
    del x77
    x76 += einsum("Vop->Vop", gc.boo)
    l1new -= einsum("VAp,Vop->Ao", lu11, x76)
    del x76
    x78 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x78 += einsum("WV,WAB->VAB", s2, g.bvv)
    x80 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x80 += einsum("VAB->VAB", x78)
    x151 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x151 += einsum("VAB->VAB", x78)
    del x78
    x79 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x79 += einsum("VoC,oABC->VAB", u11, v.ovvv)
    x80 -= einsum("VAB->VAB", x79)
    x151 += einsum("VAB->VAB", x79) * -1
    del x79
    x80 += einsum("VAB->VAB", gc.bvv)
    l1new += einsum("VBo,VBA->Ao", lu11, x80)
    del x80
    x81 += einsum("VoA->VoA", gc.bov)
    x84 += einsum("WoA,VoA->VW", u11, x81)
    del x81
    x82 = np.zeros((nbos, nbos), dtype=np.float64)
    x82 += einsum("VoA,WoA->VW", g.bov, u11)
    x83 = np.zeros((nbos, nbos), dtype=np.float64)
    x83 += einsum("WV->VW", x82)
    x156 = np.zeros((nbos, nbos), dtype=np.float64)
    x156 += einsum("WX,VX->VW", ls2, x82)
    x167 += einsum("VW->VW", x156)
    del x156
    x174 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x174 += einsum("VX,XWAo->VWoA", x82, lu12)
    del x82
    x177 -= einsum("VWoA->VWoA", x174)
    del x174
    x83 += einsum("VW->VW", w)
    x84 += einsum("XV,WX->VW", s2, x83)
    l1new += einsum("WV,VWAo->Ao", x84, lu12)
    del x84
    x152 += einsum("VW,WoA->VoA", x83, u11)
    del x83
    x86 += einsum("Ao,VpA->Vop", l1, u11) * 2
    x86 += einsum("WAo,WVpA->Vop", lu11, u12) * 2
    l1new += einsum("VpA,Vop->Ao", g.bov, x86) * -0.5
    del x86
    x87 += einsum("Vop->Vop", g.boo)
    x163 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x163 += einsum("pA,Vpo->VoA", t1, x87)
    x164 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x164 -= einsum("VoA->VoA", x163)
    del x163
    x166 = np.zeros((nbos, nbos), dtype=np.float64)
    x166 += einsum("Vop,Wpo->VW", x58, x87)
    del x58
    x167 -= einsum("WV->VW", x166)
    del x166
    x175 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x175 += einsum("VAp,Wop->VWoA", lu11, x87)
    x177 += einsum("WVoA->VWoA", x175)
    del x175
    l1new -= einsum("VpA,Vop->Ao", x0, x87)
    del x0
    del x87
    x89 += einsum("oA->oA", f.ov)
    l1new += einsum("op,pA->Ao", x88, x89) * -0.5
    del x88
    del x89
    x90 = np.zeros((nbos), dtype=np.float64)
    x90 += einsum("W,VW->V", s1, w)
    x96 += einsum("V->V", x90)
    del x90
    x91 = np.zeros((nbos), dtype=np.float64)
    x91 += einsum("oA,VoA->V", t1, gc.bov)
    x96 += einsum("V->V", x91)
    del x91
    x92 = np.zeros((nbos), dtype=np.float64)
    x92 += einsum("WoA,WVoA->V", g.bov, u12)
    x96 += einsum("V->V", x92)
    del x92
    x94 += einsum("V->V", G)
    x95 = np.zeros((nbos), dtype=np.float64)
    x95 += einsum("W,WV->V", x94, s2)
    x96 += einsum("V->V", x95)
    del x95
    x167 += einsum("W,V->VW", ls1, x94)
    del x94
    x96 += einsum("V->V", G)
    l1new += einsum("V,VAo->Ao", x96, lu11)
    ls1new += einsum("W,WV->V", x96, ls2)
    del x96
    x97 += einsum("AB->AB", f.vv)
    l1new += einsum("Bo,BA->Ao", l1, x97)
    del x97
    x98 = np.zeros((nbos), dtype=np.float64)
    x98 += einsum("V->V", s1)
    x98 += einsum("W,VW->V", ls1, s2)
    x98 += einsum("Ao,VoA->V", l1, u11)
    x98 += einsum("WAo,WVoA->V", lu11, u12)
    l1new += einsum("V,VoA->Ao", x98, g.bov)
    del x98
    x99 = np.zeros((nvir, nvir), dtype=np.float64)
    x99 += einsum("VoA,VoB->AB", g.bov, u11)
    x102 += einsum("BA->AB", x99)
    x149 += einsum("BA->AB", x99)
    del x99
    x100 += einsum("oA->oA", f.ov)
    x101 = np.zeros((nvir, nvir), dtype=np.float64)
    x101 += einsum("oA,oB->AB", t1, x100)
    x102 += einsum("AB->AB", x101)
    del x101
    x103 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x103 += einsum("CB,CAop->opAB", x102, l2)
    del x102
    x109 += einsum("poBA->opAB", x103)
    del x103
    l2new += einsum("opAB->ABop", x109)
    l2new -= einsum("opBA->ABop", x109)
    del x109
    x120 += einsum("Bp,oA->opAB", l1, x100)
    x122 = np.zeros((nocc, nocc), dtype=np.float64)
    x122 += einsum("oA,pA->op", t1, x100)
    del x100
    x123 += einsum("po->op", x122)
    del x122
    x110 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x110 += einsum("VoA,VBp->opAB", gc.bov, lu11)
    x120 += einsum("opAB->opAB", x110)
    del x110
    x112 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x112 -= einsum("IoCA,IpBC->opAB", t2, v.oovv)
    x113 += einsum("opAB->opAB", x112)
    del x112
    x113 -= einsum("pAoB->opAB", v.ovov)
    x114 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x114 += einsum("CAIo,IpCB->opAB", l2, x113)
    del x113
    x120 += einsum("opAB->opAB", x114)
    del x114
    x115 += einsum("IpoA->opIA", v.ooov)
    x116 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x116 += einsum("IJpB,IoJA->opAB", x115, x2)
    del x2
    del x115
    x120 -= einsum("opAB->opAB", x116)
    del x116
    x117 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x117 += einsum("VW,WAo->VoA", s2, lu11)
    x118 += einsum("VoA->VoA", x117)
    del x117
    x119 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x119 += einsum("VoA,VpB->opAB", g.bov, x118)
    del x118
    x120 += einsum("opAB->opAB", x119)
    del x119
    l2new += einsum("opAB->ABop", x120)
    l2new -= einsum("opBA->ABop", x120)
    l2new -= einsum("poAB->ABop", x120)
    l2new += einsum("poBA->ABop", x120)
    del x120
    x121 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x121 += einsum("Co,pCAB->opAB", l1, v.ovvv)
    x130 += einsum("opBA->opAB", x121)
    del x121
    x123 += einsum("op->op", f.oo)
    x124 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x124 += einsum("pI,ABIo->opAB", x123, l2)
    del x123
    x130 += einsum("poBA->opAB", x124)
    del x124
    l2new += einsum("opAB->ABop", x130)
    l2new -= einsum("poAB->ABop", x130)
    del x130
    x135 = np.zeros((nvir, nvir), dtype=np.float64)
    x135 += einsum("poCA,poCB->AB", t2, v.oovv)
    x136 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x136 -= einsum("CB,ACpo->opAB", x135, l2)
    x139 += einsum("opAB->opAB", x136) * 0.5
    del x136
    l2new += einsum("opAB->ABop", x139) * -1
    l2new += einsum("opBA->ABop", x139)
    del x139
    x149 += einsum("AB->AB", x135) * 0.5
    del x135
    x140 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x140 += einsum("VWpB,opAB->VWoA", u12, v.oovv)
    x141 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x141 += einsum("WVAo,WVpB->opAB", lu12, x140)
    del x140
    l2new += einsum("opAB->ABop", x141) * 0.5
    l2new += einsum("opBA->ABop", x141) * -0.5
    l2new += einsum("poAB->ABop", x141) * -0.5
    l2new += einsum("poBA->ABop", x141) * 0.5
    del x141
    x142 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x142 += einsum("AI,opIB->opAB", l1, v.ooov)
    x144 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x144 -= einsum("poAB->opAB", x142)
    del x142
    x143 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x143 += einsum("CA,BCop->opAB", f.vv, l2)
    x144 -= einsum("poAB->opAB", x143)
    del x143
    l2new -= einsum("opAB->ABop", x144)
    l2new += einsum("opBA->ABop", x144)
    del x144
    x145 += einsum("poIA->opIA", v.ooov) * -1
    x146 += einsum("JA,poIA->opIJ", t1, x145) * -4
    del x145
    x146 += einsum("poJI->opIJ", v.oooo) * 2
    l2new += einsum("BAIJ,poIJ->ABop", l2, x146) * 0.25
    del x146
    x149 += einsum("AB->AB", f.vv) * -1
    x152 += einsum("AB,VoB->VoA", x149, u11) * -1
    lu12new += einsum("BA,WVBo->VWAo", x149, lu12) * -1
    del x149
    x150 += einsum("Vop->Vop", gc.boo)
    x152 += einsum("pA,Vpo->VoA", t1, x150) * -1
    del x150
    x151 += einsum("VAB->VAB", gc.bvv)
    x152 += einsum("oB,VAB->VoA", t1, x151)
    del x151
    x152 += einsum("VAo->VoA", gc.bvo)
    x152 += einsum("WV,WAo->VoA", s2, g.bvo)
    x152 += einsum("WAB,WVoB->VoA", g.bvv, u12)
    x152 += einsum("VpB,pAoB->VoA", u11, v.ovov) * -1
    ls1new += einsum("WoA,WVAo->V", x152, lu12)
    del x152
    x155 = np.zeros((nbos, nbos), dtype=np.float64)
    x155 += einsum("VX,XW->VW", ls2, w)
    x167 += einsum("VW->VW", x155)
    del x155
    x157 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x157 += einsum("WoB,WVAo->VAB", u11, lu12)
    x158 = np.zeros((nbos, nbos), dtype=np.float64)
    x158 += einsum("VAB,WAB->VW", g.bvv, x157)
    x167 += einsum("VW->VW", x158)
    del x158
    x173 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x173 += einsum("VoB,WAB->VWoA", g.bov, x157)
    del x157
    x177 += einsum("VWoA->VWoA", x173)
    del x173
    x161 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x161 += einsum("oB,VAB->VoA", t1, g.bvv)
    x164 += einsum("VoA->VoA", x161)
    del x161
    x162 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x162 += einsum("VpB,opAB->VoA", g.bov, t2)
    x164 += einsum("VoA->VoA", x162)
    del x162
    x164 += einsum("VAo->VoA", g.bvo)
    x165 = np.zeros((nbos, nbos), dtype=np.float64)
    x165 += einsum("VAo,WoA->VW", lu11, x164)
    del x164
    x167 += einsum("WV->VW", x165)
    del x165
    ls2new = np.zeros((nbos, nbos), dtype=np.float64)
    ls2new += einsum("VW->VW", x167)
    ls2new += einsum("WV->VW", x167)
    del x167
    x168 += einsum("Ao->oA", f.vo) * -1
    ls2new += einsum("oA,WVAo->VW", x168, lu12) * -1
    del x168
    x169 = np.zeros((nbos, nbos, nbos), dtype=np.float64)
    x169 += einsum("XoA,VWAo->VWX", u11, lu12)
    lu12new += einsum("XoA,WVX->VWAo", g.bov, x169)
    del x169
    x170 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x170 += einsum("VWBp,opAB->VWoA", lu12, t2)
    lu12new += einsum("poBA,WVpB->VWAo", v.oovv, x170)
    del x170
    x171 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x171 += einsum("XW,XVAo->VWoA", w, lu12)
    x177 -= einsum("VWoA->VWoA", x171)
    del x171
    x172 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x172 += einsum("VBA,WBo->VWoA", g.bvv, lu11)
    x177 -= einsum("VWoA->VWoA", x172)
    del x172
    lu12new -= einsum("VWoA->VWAo", x177)
    lu12new -= einsum("WVoA->VWAo", x177)
    del x177
    l1new += einsum("V,VoA->Ao", ls1, gc.bov)
    l1new += einsum("oA->Ao", f.ov)
    l1new -= einsum("Bp,oBpA->Ao", l1, v.ovov)
    l2new += einsum("DCpo,DCBA->ABop", l2, v.vvvv) * 0.5
    l2new += einsum("poBA->ABop", v.oovv)
    ls1new += einsum("W,WV->V", ls1, w)
    ls1new += einsum("V->V", G)
    ls1new += einsum("Ao,VAo->V", l1, g.bvo)
    lu11new += einsum("VBp,ABop->VAo", g.bvo, l2)
    lu11new -= einsum("VBp,oBpA->VAo", lu11, v.ovov)
    lu11new -= einsum("op,VAp->VAo", f.oo, lu11)
    lu11new -= einsum("Ap,Vop->VAo", l1, g.boo)
    lu11new -= einsum("Wop,VWAp->VAo", gc.boo, lu12)
    lu11new += einsum("VoA->VAo", g.bov)
    lu11new += einsum("W,VWAo->VAo", G, lu12)
    lu11new += einsum("VW,WoA->VAo", ls2, gc.bov)
    lu11new += einsum("WV,WAo->VAo", w, lu11)
    lu11new += einsum("BA,VBo->VAo", f.vv, lu11)
    lu11new += einsum("Bo,VBA->VAo", l1, g.bvv)
    lu11new += einsum("WBA,VWBo->VAo", gc.bvv, lu12)

    return {"l1new": l1new, "l2new": l2new, "ls1new": ls1new, "ls2new": ls2new, "lu11new": lu11new, "lu12new": lu12new}

def make_rdm1_f(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    # 1RDM
    x0 = np.zeros((nocc, nocc), dtype=np.float64)
    x0 += einsum("di,jd->ij", l1, t1)
    x7 = np.zeros((nocc, nocc), dtype=np.float64)
    x7 += einsum("ij->ij", x0)
    rdm1_f_oo = np.zeros((nocc, nocc), dtype=np.float64)
    rdm1_f_oo -= einsum("ij->ij", x0)
    del x0
    x1 = np.zeros((nocc, nocc), dtype=np.float64)
    x1 += einsum("tsdi,tsjd->ij", lu12, u12)
    x7 += einsum("ij->ij", x1) * 0.5
    rdm1_f_oo += einsum("ij->ij", x1) * -0.5
    del x1
    x2 = np.zeros((nocc, nocc), dtype=np.float64)
    x2 += einsum("edik,jked->ij", l2, t2)
    x7 += einsum("ij->ij", x2) * 0.5
    rdm1_f_oo += einsum("ij->ij", x2) * -0.5
    del x2
    x3 = np.zeros((nocc, nocc), dtype=np.float64)
    x3 += einsum("sdi,sjd->ij", lu11, u11)
    x7 += einsum("ij->ij", x3)
    rdm1_f_vo = np.zeros((nvir, nocc), dtype=np.float64)
    rdm1_f_vo += einsum("jd,ji->di", t1, x7) * -1
    del x7
    rdm1_f_oo -= einsum("ij->ij", x3)
    del x3
    x4 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x4 += einsum("ke,deij->ijkd", t1, l2)
    rdm1_f_vo += einsum("kjde,kjie->di", t2, x4) * 0.5
    del x4
    x5 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x5 += einsum("jd,stdi->stij", t1, lu12)
    rdm1_f_vo += einsum("tsjd,tsji->di", u12, x5) * -0.5
    del x5
    x6 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x6 += einsum("jd,sdi->sij", t1, lu11)
    x6 += einsum("tjd,tsdi->sij", u11, lu12)
    rdm1_f_vo -= einsum("sjd,sji->di", u11, x6)
    del x6
    rdm1_f_oo += einsum("ji->ij", delta_oo)
    rdm1_f_ov = np.zeros((nocc, nvir), dtype=np.float64)
    rdm1_f_ov += einsum("di->id", l1)
    rdm1_f_vo += einsum("ts,tsid->di", ls2, u12) * 0.5
    rdm1_f_vo += einsum("ej,ijde->di", l1, t2)
    rdm1_f_vo += einsum("id->di", t1)
    rdm1_f_vo += einsum("s,sid->di", ls1, u11)
    rdm1_f_vv = np.zeros((nvir, nvir), dtype=np.float64)
    rdm1_f_vv += einsum("sei,sid->de", lu11, u11)
    rdm1_f_vv += einsum("feji,jidf->de", l2, t2) * -0.5
    rdm1_f_vv += einsum("tsei,tsid->de", lu12, u12) * 0.5
    rdm1_f_vv += einsum("ei,id->de", l1, t1)

    rdm1_f = np.block([[rdm1_f_oo, rdm1_f_ov], [rdm1_f_vo, rdm1_f_vv]])

    return rdm1_f

def make_rdm2_f(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    # 2RDM
    x0 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x0 += einsum("feij,klfe->ijkl", l2, t2)
    x28 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x28 += einsum("jilk->ijkl", x0) * -1
    x75 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x75 += einsum("jilk->ijkl", x0) * -1
    x76 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x76 += einsum("jilk->ijkl", x0) * -1
    rdm2_f_oooo = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    rdm2_f_oooo += einsum("jilk->ijkl", x0) * 0.5
    del x0
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += einsum("kf,efij->ijke", t1, l2)
    x2 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x2 += einsum("ke,ijle->ijkl", t1, x1)
    x28 += einsum("ijlk->ijkl", x2) * 2
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 += einsum("le,lijk->ijke", t1, x28) * 0.5
    del x28
    rdm2_f_oovo = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    rdm2_f_oovo += einsum("ikje->iejk", x29) * -1
    rdm2_f_vooo = np.zeros((nvir, nocc, nocc, nocc), dtype=np.float64)
    rdm2_f_vooo += einsum("ikje->eijk", x29)
    del x29
    x75 += einsum("ijlk->ijkl", x2) * 2.0000000000000013
    rdm2_f_vovo = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    rdm2_f_vovo += einsum("klfe,klji->efij", t2, x75) * -0.25
    del x75
    x76 += einsum("ijlk->ijkl", x2) * 1.9999999999999987
    x77 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x77 += einsum("le,likj->ijke", t1, x76) * -1
    del x76
    rdm2_f_vovo += einsum("ke,kjif->efij", t1, x77) * -0.5000000000000003
    del x77
    rdm2_f_oooo -= einsum("ijlk->ijkl", x2)
    del x2
    x13 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x13 -= einsum("klef,iljf->ijke", t2, x1)
    x20 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x20 += einsum("ijke->ijke", x13)
    x34 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x34 -= einsum("ijke->ijke", x13)
    x58 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x58 += einsum("ke,kijf->ijef", t1, x13)
    del x13
    x64 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x64 -= einsum("ijef->ijef", x58)
    del x58
    x24 = np.zeros((nocc, nvir), dtype=np.float64)
    x24 -= einsum("kjef,kjif->ie", t2, x1)
    x26 = np.zeros((nocc, nvir), dtype=np.float64)
    x26 += einsum("ie->ie", x24)
    x70 = np.zeros((nocc, nvir), dtype=np.float64)
    x70 += einsum("ie->ie", x24)
    del x24
    x38 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x38 += einsum("kf,ikje->ijef", t1, x1)
    x85 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x85 -= einsum("jg,jief->iefg", t1, x38)
    rdm2_f_vovv = np.zeros((nvir, nvir, nocc, nvir), dtype=np.float64)
    rdm2_f_vovv -= einsum("igfe->efig", x85)
    rdm2_f_vvvo = np.zeros((nvir, nvir, nvir, nocc), dtype=np.float64)
    rdm2_f_vvvo += einsum("igfe->efgi", x85)
    del x85
    rdm2_f_oovv = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    rdm2_f_oovv += einsum("ijfe->iejf", x38)
    rdm2_f_ovvo = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    rdm2_f_ovvo -= einsum("ijfe->iefj", x38)
    rdm2_f_voov = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    rdm2_f_voov -= einsum("ijfe->eijf", x38)
    rdm2_f_vvoo = np.zeros((nvir, nocc, nvir, nocc), dtype=np.float64)
    rdm2_f_vvoo += einsum("ijfe->eifj", x38)
    del x38
    x84 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x84 += einsum("kjfg,kjie->iefg", t2, x1)
    rdm2_f_vovv += einsum("igef->efig", x84) * 0.5
    rdm2_f_vvvo += einsum("igef->efgi", x84) * -0.5
    del x84
    rdm2_f_ooov = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    rdm2_f_ooov -= einsum("jike->ijke", x1)
    rdm2_f_ovoo = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    rdm2_f_ovoo += einsum("jike->ijek", x1)
    del x1
    x3 = np.zeros((nocc, nocc), dtype=np.float64)
    x3 += einsum("ei,je->ij", l1, t1)
    x19 = np.zeros((nocc, nocc), dtype=np.float64)
    x19 += einsum("ij->ij", x3)
    x32 = np.zeros((nocc, nvir), dtype=np.float64)
    x32 += einsum("je,ji->ie", t1, x3)
    x33 = np.zeros((nocc, nvir), dtype=np.float64)
    x33 += einsum("ie->ie", x32) * -2
    del x32
    x72 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x72 += einsum("ki,jkef->ijef", x3, t2)
    x74 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x74 -= einsum("ijfe->ijef", x72)
    del x72
    x78 = np.zeros((nocc, nocc), dtype=np.float64)
    x78 += einsum("ij->ij", x3)
    rdm2_f_oooo -= einsum("ki,jl->ijkl", delta_oo, x3)
    rdm2_f_oooo += einsum("kj,il->ijkl", delta_oo, x3)
    rdm2_f_oooo += einsum("li,jk->ijkl", delta_oo, x3)
    rdm2_f_oooo -= einsum("lj,ik->ijkl", delta_oo, x3)
    del x3
    x4 = np.zeros((nocc, nocc), dtype=np.float64)
    x4 += einsum("tsei,tsje->ij", lu12, u12)
    x6 = np.zeros((nocc, nocc), dtype=np.float64)
    x6 += einsum("ij->ij", x4)
    x68 = np.zeros((nocc, nocc), dtype=np.float64)
    x68 += einsum("ij->ij", x4)
    del x4
    x5 = np.zeros((nocc, nocc), dtype=np.float64)
    x5 += einsum("feik,jkfe->ij", l2, t2)
    x6 += einsum("ij->ij", x5)
    x25 = np.zeros((nocc, nvir), dtype=np.float64)
    x25 += einsum("je,ji->ie", t1, x6)
    x26 += einsum("ie->ie", x25)
    del x25
    x27 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x27 += einsum("je,ik->ijke", t1, x6) * -0.5
    x35 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x35 += einsum("je,ik->ijke", t1, x6) * 0.5
    x53 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x53 += einsum("ki,kjef->ijef", x6, t2) * 0.5
    rdm2_f_vovo += einsum("jief->efij", x53)
    rdm2_f_vovo += einsum("ijef->efij", x53) * -1
    del x53
    rdm2_f_oooo += einsum("ki,jl->ijkl", delta_oo, x6) * -0.5
    rdm2_f_oooo += einsum("li,jk->ijkl", delta_oo, x6) * 0.5
    rdm2_f_oooo += einsum("jk,il->ijkl", delta_oo, x6) * 0.5
    rdm2_f_oooo += einsum("jl,ik->ijkl", delta_oo, x6) * -0.5
    del x6
    x68 += einsum("ij->ij", x5)
    del x5
    x69 = np.zeros((nocc, nvir), dtype=np.float64)
    x69 += einsum("je,ji->ie", t1, x68)
    del x68
    x70 += einsum("ie->ie", x69)
    del x69
    x7 = np.zeros((nocc, nocc), dtype=np.float64)
    x7 += einsum("sei,sje->ij", lu11, u11)
    x15 = np.zeros((nocc, nvir), dtype=np.float64)
    x15 += einsum("je,ji->ie", t1, x7)
    x18 = np.zeros((nocc, nvir), dtype=np.float64)
    x18 += einsum("ie->ie", x15)
    del x15
    x19 += einsum("ij->ij", x7)
    x20 -= einsum("je,ik->ijke", t1, x19)
    x34 += einsum("je,ik->ijke", t1, x19)
    del x19
    x73 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x73 += einsum("kj,ikef->ijef", x7, t2)
    x74 += einsum("ijfe->ijef", x73)
    del x73
    rdm2_f_vovo -= einsum("ijfe->efij", x74)
    rdm2_f_vovo += einsum("jife->efij", x74)
    del x74
    x78 += einsum("ij->ij", x7)
    x79 = np.zeros((nocc, nvir), dtype=np.float64)
    x79 += einsum("je,ji->ie", t1, x78) * 2
    x80 = np.zeros((nocc, nvir), dtype=np.float64)
    x80 += einsum("ie->ie", x79) * -1
    del x79
    x81 = np.zeros((nocc, nvir), dtype=np.float64)
    x81 += einsum("je,ji->ie", t1, x78)
    del x78
    x82 = np.zeros((nocc, nvir), dtype=np.float64)
    x82 += einsum("ie->ie", x81)
    del x81
    rdm2_f_oooo -= einsum("ik,jl->ijkl", delta_oo, x7)
    rdm2_f_oooo += einsum("il,jk->ijkl", delta_oo, x7)
    rdm2_f_oooo += einsum("kj,il->ijkl", delta_oo, x7)
    rdm2_f_oooo -= einsum("lj,ik->ijkl", delta_oo, x7)
    del x7
    x8 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x8 += einsum("fi,jkef->ijke", l1, t2)
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += einsum("ke,kijf->ijef", t1, x8)
    x50 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x50 += einsum("ijef->ijef", x47)
    del x47
    rdm2_f_oovo -= einsum("ikje->iejk", x8)
    rdm2_f_vooo += einsum("ikje->eijk", x8)
    del x8
    x9 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x9 += einsum("je,sei->sij", t1, lu11)
    x10 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x10 += einsum("ske,sij->ijke", u11, x9)
    x20 += einsum("ijke->ijke", x10)
    x34 -= einsum("ijke->ijke", x10)
    del x10
    x16 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x16 += einsum("sij->sij", x9)
    x60 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x60 += einsum("je,sji->sie", t1, x9)
    del x9
    x61 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x61 -= einsum("sie->sie", x60)
    del x60
    x11 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x11 += einsum("tje,tsei->sij", u11, lu12)
    x12 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x12 += einsum("sje,sik->ijke", u11, x11)
    x20 -= einsum("ijke->ijke", x12)
    x34 += einsum("ijke->ijke", x12)
    del x12
    rdm2_f_vooo -= einsum("ijke->eijk", x34)
    rdm2_f_vooo += einsum("ikje->eijk", x34)
    del x34
    x16 += einsum("sij->sij", x11)
    x17 = np.zeros((nocc, nvir), dtype=np.float64)
    x17 += einsum("sje,sji->ie", u11, x16)
    del x16
    x18 += einsum("ie->ie", x17)
    x63 = np.zeros((nocc, nvir), dtype=np.float64)
    x63 += einsum("ie->ie", x17)
    del x17
    x56 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x56 += einsum("je,sji->sie", t1, x11)
    del x11
    x57 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x57 += einsum("sif,sje->ijef", u11, x56)
    del x56
    x64 += einsum("ijef->ijef", x57)
    del x57
    x14 = np.zeros((nocc, nvir), dtype=np.float64)
    x14 += einsum("fj,ijef->ie", l1, t2)
    x18 -= einsum("ie->ie", x14)
    x20 += einsum("ji,ke->ijke", delta_oo, x18)
    rdm2_f_oovo -= einsum("ijke->iejk", x20)
    rdm2_f_oovo += einsum("ikje->iejk", x20)
    del x20
    rdm2_f_vooo += einsum("ij,ke->eijk", delta_oo, x18)
    rdm2_f_vooo -= einsum("ik,je->eijk", delta_oo, x18)
    del x18
    x63 -= einsum("ie->ie", x14)
    del x14
    x64 -= einsum("ie,jf->ijef", t1, x63)
    del x63
    x21 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x21 += einsum("je,stei->stij", t1, lu12)
    x22 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x22 += einsum("tske,tsij->ijke", u12, x21)
    x27 += einsum("ijke->ijke", x22) * 0.5
    x35 += einsum("ijke->ijke", x22) * -0.5
    rdm2_f_vooo += einsum("ijke->eijk", x35) * -1
    rdm2_f_vooo += einsum("ikje->eijk", x35)
    del x35
    x67 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x67 += einsum("ke,kijf->ijef", t1, x22)
    del x22
    x71 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x71 += einsum("ijef->ijef", x67) * 0.5
    del x67
    x23 = np.zeros((nocc, nvir), dtype=np.float64)
    x23 += einsum("tsje,tsji->ie", u12, x21)
    x26 += einsum("ie->ie", x23)
    x27 += einsum("ji,ke->ijke", delta_oo, x26) * 0.5
    rdm2_f_oovo += einsum("ijke->iejk", x27) * -1
    rdm2_f_oovo += einsum("ikje->iejk", x27)
    del x27
    rdm2_f_vooo += einsum("ij,ke->eijk", delta_oo, x26) * 0.5
    rdm2_f_vooo += einsum("ik,je->eijk", delta_oo, x26) * -0.5
    del x26
    x70 += einsum("ie->ie", x23)
    del x23
    x71 += einsum("ie,jf->ijef", t1, x70) * 0.5
    del x70
    x54 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x54 += einsum("tje,tsji->sie", u11, x21)
    del x21
    x55 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x55 += einsum("sje,sif->ijef", u11, x54)
    del x54
    x64 += einsum("ijef->ijef", x55)
    del x55
    x30 = np.zeros((nocc, nvir), dtype=np.float64)
    x30 += einsum("s,sie->ie", ls1, u11)
    x33 += einsum("ie->ie", x30) * 2
    x80 += einsum("ie->ie", x30) * 2
    x82 += einsum("ie->ie", x30) * -1
    del x30
    x31 = np.zeros((nocc, nvir), dtype=np.float64)
    x31 += einsum("ts,tsie->ie", ls2, u12)
    x33 += einsum("ie->ie", x31)
    x80 += einsum("ie->ie", x31)
    x82 += einsum("ie->ie", x31) * -0.5
    del x31
    rdm2_f_vovo += einsum("jf,ie->efij", t1, x82) * -1
    rdm2_f_vovo += einsum("je,if->efij", t1, x82)
    del x82
    x33 += einsum("ie->ie", t1) * 2
    rdm2_f_oovo += einsum("ji,ke->iejk", delta_oo, x33) * 0.5
    rdm2_f_oovo += einsum("ki,je->iejk", delta_oo, x33) * -0.5
    rdm2_f_vooo += einsum("ki,je->eijk", delta_oo, x33) * 0.5
    rdm2_f_vooo += einsum("ji,ke->eijk", delta_oo, x33) * -0.5
    del x33
    x36 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x36 += einsum("tsei,tsjf->ijef", lu12, u12)
    x94 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x94 += einsum("jf,jieg->iefg", t1, x36)
    x95 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x95 += einsum("iefg->iefg", x94) * -0.5
    del x94
    rdm2_f_oovv += einsum("ijfe->iejf", x36) * -0.5
    rdm2_f_ovvo += einsum("ijfe->iefj", x36) * 0.5
    rdm2_f_voov += einsum("ijfe->eijf", x36) * 0.5
    rdm2_f_vvoo += einsum("ijfe->eifj", x36) * -0.5
    del x36
    x37 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x37 -= einsum("geik,jkfg->ijef", l2, t2)
    x49 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x49 += einsum("ikeg,kjgf->ijef", t2, x37)
    x50 += einsum("ijef->ijef", x49)
    del x49
    x91 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x91 += einsum("jf,jieg->iefg", t1, x37)
    x93 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x93 -= einsum("iefg->iefg", x91)
    del x91
    rdm2_f_oovv -= einsum("ijfe->iejf", x37)
    rdm2_f_ovvo += einsum("ijfe->iefj", x37)
    rdm2_f_voov += einsum("ijfe->eijf", x37)
    rdm2_f_vvoo -= einsum("ijfe->eifj", x37)
    del x37
    x39 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x39 += einsum("sei,sjf->ijef", lu11, u11)
    rdm2_f_oovv -= einsum("ijfe->iejf", x39)
    rdm2_f_ovvo += einsum("ijfe->iefj", x39)
    rdm2_f_voov += einsum("ijfe->eijf", x39)
    rdm2_f_vvoo -= einsum("ijfe->eifj", x39)
    del x39
    x40 = np.zeros((nvir, nvir), dtype=np.float64)
    x40 += einsum("ei,if->ef", l1, t1)
    x44 = np.zeros((nvir, nvir), dtype=np.float64)
    x44 += einsum("ef->ef", x40) * 2
    x92 = np.zeros((nvir, nvir), dtype=np.float64)
    x92 += einsum("ef->ef", x40)
    del x40
    x41 = np.zeros((nvir, nvir), dtype=np.float64)
    x41 += einsum("sei,sif->ef", lu11, u11)
    x44 += einsum("ef->ef", x41) * 2
    x48 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x48 += einsum("gf,ijeg->ijef", x41, t2)
    x50 -= einsum("ijef->ijef", x48)
    del x48
    rdm2_f_vovo -= einsum("jief->efij", x50)
    rdm2_f_vovo += einsum("jife->efij", x50)
    del x50
    x92 += einsum("ef->ef", x41)
    del x41
    x93 += einsum("if,eg->iefg", t1, x92)
    del x92
    x42 = np.zeros((nvir, nvir), dtype=np.float64)
    x42 += einsum("tsei,tsif->ef", lu12, u12)
    x44 += einsum("ef->ef", x42)
    x51 = np.zeros((nvir, nvir), dtype=np.float64)
    x51 += einsum("ef->ef", x42)
    del x42
    x43 = np.zeros((nvir, nvir), dtype=np.float64)
    x43 -= einsum("geji,jifg->ef", l2, t2)
    x44 += einsum("ef->ef", x43)
    rdm2_f_oovv += einsum("ji,fe->iejf", delta_oo, x44) * 0.5
    rdm2_f_ovvo += einsum("ji,fe->iefj", delta_oo, x44) * -0.5
    rdm2_f_voov += einsum("ji,fe->eijf", delta_oo, x44) * -0.5
    rdm2_f_vvoo += einsum("ji,fe->eifj", delta_oo, x44) * 0.5
    del x44
    x51 += einsum("ef->ef", x43)
    del x43
    x52 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x52 += einsum("ge,ijgf->ijef", x51, t2) * 0.5
    rdm2_f_vovo += einsum("ijfe->efij", x52)
    rdm2_f_vovo += einsum("ijef->efij", x52) * -1
    del x52
    x95 += einsum("if,eg->iefg", t1, x51) * 0.5
    del x51
    rdm2_f_vovv += einsum("igef->efig", x95)
    rdm2_f_vovv += einsum("igfe->efig", x95) * -1
    rdm2_f_vvvo += einsum("igef->efgi", x95) * -1
    rdm2_f_vvvo += einsum("igfe->efgi", x95)
    del x95
    x45 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x45 += einsum("st,tie->sie", ls2, u11)
    x46 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x46 += einsum("sjf,sie->ijef", u11, x45)
    del x45
    rdm2_f_vovo -= einsum("ijfe->efij", x46)
    rdm2_f_vovo += einsum("jife->efij", x46)
    del x46
    x59 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x59 += einsum("sfj,ijef->sie", lu11, t2)
    x61 += einsum("sie->sie", x59)
    del x59
    x62 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x62 += einsum("sjf,sie->ijef", u11, x61)
    del x61
    x64 += einsum("ijef->ijef", x62)
    del x62
    rdm2_f_vovo += einsum("ijef->efij", x64)
    rdm2_f_vovo -= einsum("ijfe->efij", x64)
    rdm2_f_vovo -= einsum("jief->efij", x64)
    rdm2_f_vovo += einsum("jife->efij", x64)
    del x64
    x65 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x65 += einsum("stfj,ijef->stie", lu12, t2)
    x66 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x66 += einsum("tsjf,tsie->ijef", u12, x65)
    del x65
    x71 += einsum("ijef->ijef", x66) * -0.5
    del x66
    rdm2_f_vovo += einsum("ijef->efij", x71) * -1
    rdm2_f_vovo += einsum("ijfe->efij", x71)
    rdm2_f_vovo += einsum("jief->efij", x71)
    rdm2_f_vovo += einsum("jife->efij", x71) * -1
    del x71
    x80 += einsum("ie->ie", t1) * 2
    rdm2_f_vovo += einsum("ie,jf->efij", t1, x80) * 0.5
    rdm2_f_vovo += einsum("if,je->efij", t1, x80) * -0.5
    del x80
    x83 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x83 += einsum("jg,efij->iefg", t1, l2)
    rdm2_f_ovvv = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    rdm2_f_ovvv -= einsum("igfe->iefg", x83)
    rdm2_f_vvov = np.zeros((nvir, nocc, nvir, nvir), dtype=np.float64)
    rdm2_f_vvov += einsum("igfe->eifg", x83)
    rdm2_f_vvvv = np.zeros((nvir, nvir, nvir, nvir), dtype=np.float64)
    rdm2_f_vvvv += einsum("ie,ighf->efgh", t1, x83)
    del x83
    x86 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x86 += einsum("ej,ijfg->iefg", l1, t2)
    rdm2_f_vovv -= einsum("igfe->efig", x86)
    rdm2_f_vvvo += einsum("igfe->efgi", x86)
    del x86
    x87 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x87 += einsum("if,sei->sef", t1, lu11)
    x88 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x88 += einsum("sig,sef->iefg", u11, x87)
    del x87
    x93 -= einsum("iefg->iefg", x88)
    del x88
    x89 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x89 += einsum("tif,stei->sef", u11, lu12)
    x90 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x90 += einsum("sif,seg->iefg", u11, x89)
    del x89
    x93 += einsum("iefg->iefg", x90)
    del x90
    rdm2_f_vovv += einsum("igef->efig", x93)
    rdm2_f_vovv -= einsum("igfe->efig", x93)
    rdm2_f_vvvo -= einsum("igef->efgi", x93)
    rdm2_f_vvvo += einsum("igfe->efgi", x93)
    del x93
    rdm2_f_oooo += einsum("ki,lj->ijkl", delta_oo, delta_oo)
    rdm2_f_oooo -= einsum("jk,li->ijkl", delta_oo, delta_oo)
    rdm2_f_ooov += einsum("ki,ej->ijke", delta_oo, l1)
    rdm2_f_ooov -= einsum("kj,ei->ijke", delta_oo, l1)
    rdm2_f_ovoo -= einsum("ki,ej->ijek", delta_oo, l1)
    rdm2_f_ovoo += einsum("kj,ei->ijek", delta_oo, l1)
    rdm2_f_ovov = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    rdm2_f_ovov += einsum("feji->ijef", l2)
    rdm2_f_oovv -= einsum("fi,je->iejf", l1, t1)
    rdm2_f_ovvo += einsum("fi,je->iefj", l1, t1)
    rdm2_f_voov += einsum("fi,je->eijf", l1, t1)
    rdm2_f_vvoo -= einsum("fi,je->eifj", l1, t1)
    rdm2_f_vovo += einsum("jife->efij", t2)
    rdm2_f_vvvv += einsum("hgji,jife->efgh", l2, t2) * 0.5

    rdm2_f = pack_2e(rdm2_f_oooo, rdm2_f_ooov, rdm2_f_oovo, rdm2_f_ovoo, rdm2_f_vooo, rdm2_f_oovv, rdm2_f_ovov, rdm2_f_ovvo, rdm2_f_voov, rdm2_f_vovo, rdm2_f_vvoo, rdm2_f_ovvv, rdm2_f_vovv, rdm2_f_vvov, rdm2_f_vvvo, rdm2_f_vvvv)

    return rdm2_f

def make_sing_b_dm(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    # Single boson DM
    dm_b_cre = np.zeros((nbos), dtype=np.float64)
    dm_b_cre += einsum("u->u", ls1)
    dm_b_des = np.zeros((nbos), dtype=np.float64)
    dm_b_des += einsum("ai,uia->u", l1, u11)
    dm_b_des += einsum("v,uv->u", ls1, s2)
    dm_b_des += einsum("u->u", s1)
    dm_b_des += einsum("vai,uvia->u", lu11, u12)

    dm_b = np.array([dm_b_cre, dm_b_des])

    return dm_b

def make_rdm1_b(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    # Boson 1RDM
    rdm1_b = np.zeros((nbos, nbos), dtype=np.float64)
    rdm1_b += einsum("vxai,wxia->vw", lu12, u12)
    rdm1_b += einsum("vai,wia->vw", lu11, u11)
    rdm1_b += einsum("vx,wx->vw", ls2, s2)
    rdm1_b += einsum("v,w->vw", ls1, s1)

    return rdm1_b

def make_eb_coup_rdm(f=None, v=None, w=None, g=None, G=None, nocc=None, nvir=None, nbos=None, t1=None, t2=None, s1=None, s2=None, u11=None, u12=None, l1=None, l2=None, ls1=None, ls2=None, lu11=None, lu12=None, **kwargs):
    # Get boson coupling creation array:
    gc = SimpleNamespace(
        boo=g.boo.transpose(0, 2, 1),
        bov=g.bvo.transpose(0, 2, 1),
        bvo=g.bov.transpose(0, 2, 1),
        bvv=g.bvv.transpose(0, 2, 1),
    )

    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    # Boson-fermion coupling RDM
    x0 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x0 += einsum("jd,udi->uij", t1, lu11)
    x3 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x3 += einsum("uij->uij", x0)
    x30 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x30 += einsum("uij->uij", x0)
    rdm_eb_cre_oo = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    rdm_eb_cre_oo -= einsum("uji->uij", x0)
    del x0
    x1 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x1 += einsum("vjd,uvdi->uij", u11, lu12)
    x3 += einsum("uij->uij", x1)
    rdm_eb_cre_ov = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    rdm_eb_cre_ov -= einsum("jd,uji->uid", t1, x3)
    rdm_eb_des_ov = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    rdm_eb_des_ov -= einsum("vji,vujd->uid", x3, u12)
    del x3
    x5 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x5 += einsum("uv,vij->uij", s2, x1)
    x27 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x27 += einsum("uij->uij", x5)
    rdm_eb_des_oo = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    rdm_eb_des_oo -= einsum("uji->uij", x5)
    del x5
    x30 += einsum("uij->uij", x1)
    x32 = np.zeros((nocc, nvir), dtype=np.float64)
    x32 += einsum("ujd,uji->id", u11, x30)
    del x30
    rdm_eb_cre_oo -= einsum("uji->uij", x1)
    del x1
    x2 = np.zeros((nbos, nbos, nocc, nocc), dtype=np.float64)
    x2 += einsum("jd,uvdi->uvij", t1, lu12)
    x32 += einsum("vujd,vuji->id", u12, x2) * 0.5
    rdm_eb_cre_ov -= einsum("vjd,uvji->uid", u11, x2)
    del x2
    x4 = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    x4 += einsum("vie,uvdi->ude", u11, lu12)
    rdm_eb_cre_vv = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    rdm_eb_cre_vv += einsum("ude->ude", x4)
    rdm_eb_des_vv = np.zeros((nbos, nvir, nvir), dtype=np.float64)
    rdm_eb_des_vv += einsum("uv,vde->ude", s2, x4)
    x6 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x6 += einsum("vdi,uvjd->uij", lu11, u12)
    x27 += einsum("uij->uij", x6)
    rdm_eb_des_oo -= einsum("uji->uij", x6)
    del x6
    x7 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x7 += einsum("uv,vdi->uid", s2, lu11)
    x9 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x9 += einsum("uid->uid", x7)
    rdm_eb_des_vo = np.zeros((nbos, nvir, nocc), dtype=np.float64)
    rdm_eb_des_vo += einsum("uid->udi", x7)
    del x7
    x8 = np.zeros((nbos, nocc, nvir), dtype=np.float64)
    x8 -= einsum("uje,edij->uid", u11, l2)
    x9 += einsum("uid->uid", x8)
    x10 = np.zeros((nbos, nocc, nocc), dtype=np.float64)
    x10 += einsum("id,ujd->uij", t1, x9)
    x27 += einsum("uji->uij", x10)
    rdm_eb_des_ov -= einsum("jd,uji->uid", t1, x27)
    del x27
    rdm_eb_des_oo -= einsum("uij->uij", x10)
    del x10
    rdm_eb_des_ov += einsum("uje,jied->uid", x9, t2)
    rdm_eb_des_vv += einsum("ie,uid->ude", t1, x9)
    del x9
    rdm_eb_des_vo += einsum("uid->udi", x8)
    del x8
    x11 = np.zeros((nocc, nocc), dtype=np.float64)
    x11 += einsum("di,jd->ij", l1, t1)
    x15 = np.zeros((nocc, nocc), dtype=np.float64)
    x15 += einsum("ij->ij", x11) * 2
    x26 = np.zeros((nocc, nocc), dtype=np.float64)
    x26 += einsum("ij->ij", x11) * 2
    x31 = np.zeros((nocc, nocc), dtype=np.float64)
    x31 += einsum("ij->ij", x11) * 2
    del x11
    x12 = np.zeros((nocc, nocc), dtype=np.float64)
    x12 += einsum("udi,ujd->ij", lu11, u11)
    x15 += einsum("ij->ij", x12) * 2
    x26 += einsum("ij->ij", x12) * 2
    x31 += einsum("ij->ij", x12) * 2
    del x12
    x13 = np.zeros((nocc, nocc), dtype=np.float64)
    x13 += einsum("vudi,vujd->ij", lu12, u12)
    x15 += einsum("ij->ij", x13)
    x26 += einsum("ij->ij", x13)
    x31 += einsum("ij->ij", x13)
    del x13
    x14 = np.zeros((nocc, nocc), dtype=np.float64)
    x14 += einsum("edik,jked->ij", l2, t2)
    x15 += einsum("ij->ij", x14)
    x26 += einsum("ij->ij", x14)
    rdm_eb_des_ov += einsum("ji,ujd->uid", x26, u11) * -0.5
    del x26
    x31 += einsum("ij->ij", x14)
    del x14
    x32 += einsum("jd,ji->id", t1, x31) * 0.5
    del x31
    x15 += einsum("ji->ij", delta_oo) * -2
    rdm_eb_des_oo += einsum("u,ji->uij", s1, x15) * -0.5
    del x15
    x16 = np.zeros((nbos), dtype=np.float64)
    x16 += einsum("v,uv->u", ls1, s2)
    x19 = np.zeros((nbos), dtype=np.float64)
    x19 += einsum("u->u", x16)
    del x16
    x17 = np.zeros((nbos), dtype=np.float64)
    x17 += einsum("di,uid->u", l1, u11)
    x19 += einsum("u->u", x17)
    del x17
    x18 = np.zeros((nbos), dtype=np.float64)
    x18 += einsum("vdi,uvid->u", lu11, u12)
    x19 += einsum("u->u", x18)
    del x18
    rdm_eb_des_oo += einsum("u,ji->uij", x19, delta_oo)
    rdm_eb_des_ov += einsum("u,id->uid", x19, t1)
    del x19
    x20 = np.zeros((nbos, nbos, nbos), dtype=np.float64)
    x20 += einsum("wid,uvdi->uvw", u11, lu12)
    rdm_eb_des_ov += einsum("wvu,wvid->uid", x20, u12) * 0.5
    del x20
    x21 = np.zeros((nvir, nvir), dtype=np.float64)
    x21 += einsum("di,ie->de", l1, t1)
    x25 = np.zeros((nvir, nvir), dtype=np.float64)
    x25 += einsum("de->de", x21)
    x34 = np.zeros((nvir, nvir), dtype=np.float64)
    x34 += einsum("de->de", x21) * 2
    del x21
    x22 = np.zeros((nvir, nvir), dtype=np.float64)
    x22 += einsum("udi,uie->de", lu11, u11)
    x25 += einsum("de->de", x22)
    x34 += einsum("de->de", x22) * 2
    del x22
    x23 = np.zeros((nvir, nvir), dtype=np.float64)
    x23 += einsum("vudi,vuie->de", lu12, u12)
    x25 += einsum("de->de", x23) * 0.5
    x34 += einsum("de->de", x23)
    del x23
    x24 = np.zeros((nvir, nvir), dtype=np.float64)
    x24 -= einsum("fdji,jief->de", l2, t2)
    x25 += einsum("de->de", x24) * 0.5
    rdm_eb_des_ov += einsum("ed,uie->uid", x25, u11) * -1
    del x25
    x34 += einsum("de->de", x24)
    del x24
    rdm_eb_des_vv += einsum("u,de->ude", s1, x34) * 0.5
    del x34
    x28 = np.zeros((nbos, nbos), dtype=np.float64)
    x28 += einsum("uw,vw->uv", ls2, s2)
    x28 += einsum("udi,vid->uv", lu11, u11)
    x28 += einsum("wudi,vwid->uv", lu12, u12)
    rdm_eb_des_ov += einsum("vu,vid->uid", x28, u11)
    del x28
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 += einsum("ke,deij->ijkd", t1, l2)
    x32 += einsum("kjde,kjie->id", t2, x29) * -0.5000000000000003
    del x29
    x32 += einsum("id->id", t1) * -1
    x32 += einsum("u,uid->id", ls1, u11) * -1
    x32 += einsum("vu,vuid->id", ls2, u12) * -0.5
    x32 += einsum("ej,ijde->id", l1, t2) * -1
    rdm_eb_des_ov += einsum("u,id->uid", s1, x32) * -1
    del x32
    x33 = np.zeros((nbos, nbos, nocc, nvir), dtype=np.float64)
    x33 += einsum("vuid->uvid", u12)
    x33 += einsum("vu,id->uvid", s2, t1)
    rdm_eb_des_ov -= einsum("ved,vuie->uid", x4, x33)
    del x33
    del x4
    rdm_eb_cre_oo += einsum("u,ji->uij", ls1, delta_oo)
    rdm_eb_cre_ov += einsum("uej,ijde->uid", lu11, t2)
    rdm_eb_cre_ov += einsum("u,id->uid", ls1, t1)
    rdm_eb_cre_ov += einsum("uv,vid->uid", ls2, u11)
    rdm_eb_cre_vo = np.zeros((nbos, nvir, nocc), dtype=np.float64)
    rdm_eb_cre_vo += einsum("udi->udi", lu11)
    rdm_eb_cre_vv += einsum("ie,udi->ude", t1, lu11)
    rdm_eb_des_oo -= einsum("dj,uid->uij", l1, u11)
    rdm_eb_des_ov += einsum("uid->uid", u11)
    rdm_eb_des_ov += einsum("v,uvid->uid", ls1, u12)
    rdm_eb_des_vo += einsum("u,di->udi", s1, l1)
    rdm_eb_des_vv += einsum("vdi,uvie->ude", lu11, u12)
    rdm_eb_des_vv += einsum("di,uie->ude", l1, u11)

    rdm_eb = np.array([
            np.block([[rdm_eb_cre_oo, rdm_eb_cre_ov], [rdm_eb_cre_vo, rdm_eb_cre_vv]]),
            np.block([[rdm_eb_des_oo, rdm_eb_des_ov], [rdm_eb_des_vo, rdm_eb_des_vv]]),
    ])

    return rdm_eb



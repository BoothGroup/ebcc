# Code generated by qwick.

import numpy as np
from ebcc.util import pack_2e, einsum, direct_sum, Namespace

def energy(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    # energy
    x0 = 0
    x0 += np.einsum("ijab,ibja->", t2.bbbb, v.bbbb.ovov)
    e_cc = 0
    e_cc += np.einsum("->", x0) * -1.0
    del x0
    x1 = 0
    x1 += np.einsum("ijab,iajb->", t2.bbbb, v.bbbb.ovov)
    e_cc += np.einsum("->", x1) * 2.0
    del x1
    x2 = 0
    x2 += np.einsum("ia,ia->", f.bb.ov, t1.bb)
    e_cc += np.einsum("->", x2) * 2.0
    del x2
    x3 = np.zeros((nocc[1], nvir[1]), dtype=np.float64)
    x3 += np.einsum("ia,jbia->ia", t1.bb, v.bbbb.ovov)
    x4 = 0
    x4 += np.einsum("ia,ia->", t1.bb, x3.bb)
    del x3.bb
    e_cc += np.einsum("->", x4) * 2.0
    del x4
    x5 = np.zeros((nocc[1], nvir[1]), dtype=np.float64)
    x5 += np.einsum("ia,jaib->ia", t1.bb, v.bbbb.ovov)
    x6 = 0
    x6 += np.einsum("ia,ia->", t1.bb, x5.bb)
    del x5.bb
    e_cc += np.einsum("->", x6) * -1.0
    del x6

    return e_cc

def update_amps(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    t1new = Namespace()
    t2new = Namespace()

    # T amplitudes
    t1new_aa = np.zeros((nocc[0], nvir[0]), dtype=np.float64)
    t1new_aa += np.einsum("ia->ia", f.aa.ov)
    t1new_aa += np.einsum("ij,ja->ia", f.aa.oo, t1.aa) * -1.0
    t1new_aa += np.einsum("ab,ib->ia", f.aa.vv, t1.aa)
    t1new_aa += np.einsum("jb,ijab->ia", f.bb.ov, t2.abab)
    t1new_aa += np.einsum("jb,ijab->ia", f.aa.ov, t2.aaaa) * 2.0
    t1new_aa += np.einsum("jb,ijab->ia", t1.aa, v.aaaa.oovv) * -1.0
    t1new_aa += np.einsum("jb,iajb->ia", t1.aa, v.aaaa.ovov)
    t1new_aa += np.einsum("jb,iajb->ia", t1.bb, v.aabb.ovov)
    t1new_aa += np.einsum("jkab,ijkb->ia", t2.abab, v.aabb.ooov) * -1.0
    t1new_aa += np.einsum("ijbc,jcab->ia", t2.abab, v.bbaa.ovvv)
    t1new_aa += np.einsum("jkab,ijkb->ia", t2.aaaa, v.aaaa.ooov) * -1.0
    t1new_aa += np.einsum("jkab,ikjb->ia", t2.aaaa, v.aaaa.ooov)
    t1new_aa += np.einsum("ijbc,jbac->ia", t2.aaaa, v.aaaa.ovvv) * -1.0
    t1new_aa += np.einsum("ijbc,jcab->ia", t2.aaaa, v.aaaa.ovvv)
    t1new_aa += np.einsum("jb,ib,ja->ia", f.aa.ov, t1.aa, t1.aa) * -1.0
    t1new_aa += np.einsum("jb,ka,ijkb->ia", t1.aa, t1.aa, v.aaaa.ooov)
    t1new_aa += np.einsum("jb,ka,ikjb->ia", t1.aa, t1.aa, v.aaaa.ooov) * -1.0
    t1new_aa += np.einsum("ib,jc,jbac->ia", t1.aa, t1.aa, v.aaaa.ovvv) * -1.0
    t1new_aa += np.einsum("ib,jc,jcab->ia", t1.aa, t1.aa, v.aaaa.ovvv)
    t1new_aa += np.einsum("ja,kb,ijkb->ia", t1.aa, t1.bb, v.aabb.ooov) * -1.0
    t1new_aa += np.einsum("ib,jc,jcab->ia", t1.aa, t1.bb, v.bbaa.ovvv)
    t1new_aa += np.einsum("ib,jkac,jbkc->ia", t1.aa, t2.abab, v.aabb.ovov) * -1.0
    t1new_aa += np.einsum("ja,ikbc,jbkc->ia", t1.aa, t2.abab, v.aabb.ovov) * -1.0
    t1new_aa += np.einsum("jb,ikac,jbkc->ia", t1.aa, t2.abab, v.aabb.ovov)
    t1new_aa += np.einsum("ib,jkac,jbkc->ia", t1.aa, t2.aaaa, v.aaaa.ovov) * -1.0
    t1new_aa += np.einsum("ib,jkac,jckb->ia", t1.aa, t2.aaaa, v.aaaa.ovov)
    t1new_aa += np.einsum("ja,ikbc,jbkc->ia", t1.aa, t2.aaaa, v.aaaa.ovov) * -1.0
    t1new_aa += np.einsum("ja,ikbc,jckb->ia", t1.aa, t2.aaaa, v.aaaa.ovov)
    t1new_aa += np.einsum("jb,ikac,jbkc->ia", t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t1new_aa += np.einsum("jb,ikac,jckb->ia", t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t1new_aa += np.einsum("jb,ikac,jbkc->ia", t1.bb, t2.abab, v.bbbb.ovov)
    t1new_aa += np.einsum("jb,ikac,jckb->ia", t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t1new_aa += np.einsum("jb,ikac,jbkc->ia", t1.bb, t2.aaaa, v.bbaa.ovov) * 2.0
    t1new_aa += np.einsum("ib,jc,ka,jbkc->ia", t1.aa, t1.aa, t1.aa, v.aaaa.ovov)
    t1new_aa += np.einsum("ib,jc,ka,jckb->ia", t1.aa, t1.aa, t1.aa, v.aaaa.ovov) * -1.0
    t1new_aa += np.einsum("ib,ja,kc,jbkc->ia", t1.aa, t1.aa, t1.bb, v.aabb.ovov) * -1.0
    t1new_bb = np.zeros((nocc[1], nvir[1]), dtype=np.float64)
    t1new_bb += np.einsum("ia->ia", f.bb.ov)
    t1new_bb += np.einsum("ij,ja->ia", f.bb.oo, t1.bb) * -1.0
    t1new_bb += np.einsum("ab,ib->ia", f.bb.vv, t1.bb)
    t1new_bb += np.einsum("jb,jiba->ia", f.aa.ov, t2.abab)
    t1new_bb += np.einsum("jb,ijab->ia", f.bb.ov, t2.bbbb) * 2.0
    t1new_bb += np.einsum("jb,iajb->ia", t1.aa, v.bbaa.ovov)
    t1new_bb += np.einsum("jb,ijab->ia", t1.bb, v.bbbb.oovv) * -1.0
    t1new_bb += np.einsum("jb,iajb->ia", t1.bb, v.bbbb.ovov)
    t1new_bb += np.einsum("jkba,ikjb->ia", t2.abab, v.bbaa.ooov) * -1.0
    t1new_bb += np.einsum("jibc,jbac->ia", t2.abab, v.aabb.ovvv)
    t1new_bb += np.einsum("jkab,ijkb->ia", t2.bbbb, v.bbbb.ooov) * -1.0
    t1new_bb += np.einsum("jkab,ikjb->ia", t2.bbbb, v.bbbb.ooov)
    t1new_bb += np.einsum("ijbc,jbac->ia", t2.bbbb, v.bbbb.ovvv) * -1.0
    t1new_bb += np.einsum("ijbc,jcab->ia", t2.bbbb, v.bbbb.ovvv)
    t1new_bb += np.einsum("jb,ib,ja->ia", f.bb.ov, t1.bb, t1.bb) * -1.0
    t1new_bb += np.einsum("jb,ka,ikjb->ia", t1.aa, t1.bb, v.bbaa.ooov) * -1.0
    t1new_bb += np.einsum("jb,ic,jbac->ia", t1.aa, t1.bb, v.aabb.ovvv)
    t1new_bb += np.einsum("jb,ka,ijkb->ia", t1.bb, t1.bb, v.bbbb.ooov)
    t1new_bb += np.einsum("jb,ka,ikjb->ia", t1.bb, t1.bb, v.bbbb.ooov) * -1.0
    t1new_bb += np.einsum("ib,jc,jbac->ia", t1.bb, t1.bb, v.bbbb.ovvv) * -1.0
    t1new_bb += np.einsum("ib,jc,jcab->ia", t1.bb, t1.bb, v.bbbb.ovvv)
    t1new_bb += np.einsum("jb,kica,jbkc->ia", t1.aa, t2.abab, v.aaaa.ovov)
    t1new_bb += np.einsum("jb,kica,jckb->ia", t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t1new_bb += np.einsum("jb,ikac,jbkc->ia", t1.aa, t2.bbbb, v.aabb.ovov) * 2.0
    t1new_bb += np.einsum("ib,jkca,jckb->ia", t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t1new_bb += np.einsum("ja,kibc,jckb->ia", t1.bb, t2.abab, v.bbaa.ovov) * -1.0
    t1new_bb += np.einsum("jb,kica,jbkc->ia", t1.bb, t2.abab, v.bbaa.ovov)
    t1new_bb += np.einsum("ib,jkac,jbkc->ia", t1.bb, t2.bbbb, v.bbbb.ovov) * -1.0
    t1new_bb += np.einsum("ib,jkac,jckb->ia", t1.bb, t2.bbbb, v.bbbb.ovov)
    t1new_bb += np.einsum("ja,ikbc,jbkc->ia", t1.bb, t2.bbbb, v.bbbb.ovov) * -1.0
    t1new_bb += np.einsum("ja,ikbc,jckb->ia", t1.bb, t2.bbbb, v.bbbb.ovov)
    t1new_bb += np.einsum("jb,ikac,jbkc->ia", t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t1new_bb += np.einsum("jb,ikac,jckb->ia", t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t1new_bb += np.einsum("jb,ic,ka,jbkc->ia", t1.aa, t1.bb, t1.bb, v.aabb.ovov) * -1.0
    t1new_bb += np.einsum("ib,jc,ka,jbkc->ia", t1.bb, t1.bb, t1.bb, v.bbbb.ovov)
    t1new_bb += np.einsum("ib,jc,ka,jckb->ia", t1.bb, t1.bb, t1.bb, v.bbbb.ovov) * -1.0
    t2new_aaaa = np.zeros((nocc[0], nocc[0], nvir[0], nvir[0]), dtype=np.float64)
    t2new_aaaa += np.einsum("iajb->ijab", v.aaaa.ovov)
    t2new_aaaa += np.einsum("ibja->ijab", v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("ik,jkab->ijab", f.aa.oo, t2.aaaa) * 2.0
    t2new_aaaa += np.einsum("jk,ikab->ijab", f.aa.oo, t2.aaaa) * -2.0
    t2new_aaaa += np.einsum("ac,ijbc->ijab", f.aa.vv, t2.aaaa) * -2.0
    t2new_aaaa += np.einsum("bc,ijac->ijab", f.aa.vv, t2.aaaa) * 2.0
    t2new_aaaa += np.einsum("ka,ikjb->ijab", t1.aa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ka,jkib->ijab", t1.aa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("kb,ikja->ijab", t1.aa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("kb,jkia->ijab", t1.aa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ic,jabc->ijab", t1.aa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ic,jbac->ijab", t1.aa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("jc,iabc->ijab", t1.aa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("jc,ibac->ijab", t1.aa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ikbc,jakc->ijab", t2.abab, v.aabb.ovov) * -1.0
    t2new_aaaa += np.einsum("ikac,jbkc->ijab", t2.abab, v.aabb.ovov)
    t2new_aaaa += np.einsum("jkbc,iakc->ijab", t2.abab, v.aabb.ovov)
    t2new_aaaa += np.einsum("jkac,ibkc->ijab", t2.abab, v.aabb.ovov) * -1.0
    t2new_aaaa += np.einsum("klab,ikjl->ijab", t2.aaaa, v.aaaa.oooo)
    t2new_aaaa += np.einsum("klab,iljk->ijab", t2.aaaa, v.aaaa.oooo) * -1.0
    t2new_aaaa += np.einsum("ikac,jkbc->ijab", t2.aaaa, v.aaaa.oovv) * -2.0
    t2new_aaaa += np.einsum("ikbc,jkac->ijab", t2.aaaa, v.aaaa.oovv) * 2.0
    t2new_aaaa += np.einsum("jkac,ikbc->ijab", t2.aaaa, v.aaaa.oovv) * 2.0
    t2new_aaaa += np.einsum("jkbc,ikac->ijab", t2.aaaa, v.aaaa.oovv) * -2.0
    t2new_aaaa += np.einsum("ikbc,jakc->ijab", t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ikac,jbkc->ijab", t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jkbc,iakc->ijab", t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jkac,ibkc->ijab", t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ijcd,acbd->ijab", t2.aaaa, v.aaaa.vvvv)
    t2new_aaaa += np.einsum("ijcd,adbc->ijab", t2.aaaa, v.aaaa.vvvv) * -1.0
    t2new_aaaa += np.einsum("kc,ic,jkab->ijab", f.aa.ov, t1.aa, t2.aaaa) * 2.0
    t2new_aaaa += np.einsum("kc,jc,ikab->ijab", f.aa.ov, t1.aa, t2.aaaa) * -2.0
    t2new_aaaa += np.einsum("kc,ka,ijbc->ijab", f.aa.ov, t1.aa, t2.aaaa) * 2.0
    t2new_aaaa += np.einsum("kc,kb,ijac->ijab", f.aa.ov, t1.aa, t2.aaaa) * -2.0
    t2new_aaaa += np.einsum("ic,ka,jkbc->ijab", t1.aa, t1.aa, v.aaaa.oovv)
    t2new_aaaa += np.einsum("ic,kb,jkac->ijab", t1.aa, t1.aa, v.aaaa.oovv) * -1.0
    t2new_aaaa += np.einsum("jc,ka,ikbc->ijab", t1.aa, t1.aa, v.aaaa.oovv) * -1.0
    t2new_aaaa += np.einsum("jc,kb,ikac->ijab", t1.aa, t1.aa, v.aaaa.oovv)
    t2new_aaaa += np.einsum("ka,lb,ikjl->ijab", t1.aa, t1.aa, v.aaaa.oooo)
    t2new_aaaa += np.einsum("ka,lb,iljk->ijab", t1.aa, t1.aa, v.aaaa.oooo) * -1.0
    t2new_aaaa += np.einsum("ic,ka,jbkc->ijab", t1.aa, t1.aa, v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,kb,jakc->ijab", t1.aa, t1.aa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("jc,ka,ibkc->ijab", t1.aa, t1.aa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("jc,kb,iakc->ijab", t1.aa, t1.aa, v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,jd,acbd->ijab", t1.aa, t1.aa, v.aaaa.vvvv)
    t2new_aaaa += np.einsum("ic,jd,adbc->ijab", t1.aa, t1.aa, v.aaaa.vvvv) * -1.0
    t2new_aaaa += np.einsum("ka,ilbc,jklc->ijab", t1.aa, t2.abab, v.aabb.ooov)
    t2new_aaaa += np.einsum("ka,jlbc,iklc->ijab", t1.aa, t2.abab, v.aabb.ooov) * -1.0
    t2new_aaaa += np.einsum("kb,ilac,jklc->ijab", t1.aa, t2.abab, v.aabb.ooov) * -1.0
    t2new_aaaa += np.einsum("kb,jlac,iklc->ijab", t1.aa, t2.abab, v.aabb.ooov)
    t2new_aaaa += np.einsum("ic,jkad,kdbc->ijab", t1.aa, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ic,jkbd,kdac->ijab", t1.aa, t2.abab, v.bbaa.ovvv)
    t2new_aaaa += np.einsum("jc,ikad,kdbc->ijab", t1.aa, t2.abab, v.bbaa.ovvv)
    t2new_aaaa += np.einsum("jc,ikbd,kdac->ijab", t1.aa, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ic,klab,jklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ic,klab,jlkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("jc,klab,iklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("jc,klab,ilkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ka,ilbc,jklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("ka,ilbc,jlkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("ka,jlbc,iklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("ka,jlbc,ilkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("kb,ilac,jklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("kb,ilac,jlkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("kb,jlac,iklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("kb,jlac,ilkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("kc,ilab,jklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("kc,ilab,jlkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("kc,jlab,iklc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * -2.0
    t2new_aaaa += np.einsum("kc,jlab,ilkc->ijab", t1.aa, t2.aaaa, v.aaaa.ooov) * 2.0
    t2new_aaaa += np.einsum("ic,jkad,kcbd->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("ic,jkbd,kcad->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("ic,jkad,kdbc->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("ic,jkbd,kdac->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("jc,ikad,kcbd->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("jc,ikbd,kcad->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("jc,ikad,kdbc->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("jc,ikbd,kdac->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("ka,ijcd,kcbd->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ka,ijcd,kdbc->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("kb,ijcd,kcad->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("kb,ijcd,kdac->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("kc,ijad,kcbd->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("kc,ijbd,kcad->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("kc,ijad,kdbc->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("kc,ijbd,kdac->ijab", t1.aa, t2.aaaa, v.aaaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("kc,ilab,jlkc->ijab", t1.bb, t2.aaaa, v.aabb.ooov) * -2.0
    t2new_aaaa += np.einsum("kc,jlab,ilkc->ijab", t1.bb, t2.aaaa, v.aabb.ooov) * 2.0
    t2new_aaaa += np.einsum("kc,ijad,kcbd->ijab", t1.bb, t2.aaaa, v.bbaa.ovvv) * 2.0
    t2new_aaaa += np.einsum("kc,ijbd,kcad->ijab", t1.bb, t2.aaaa, v.bbaa.ovvv) * -2.0
    t2new_aaaa += np.einsum("ikac,jlbd,kcld->ijab", t2.abab, t2.abab, v.bbbb.ovov)
    t2new_aaaa += np.einsum("ikbc,jlad,kcld->ijab", t2.abab, t2.abab, v.bbbb.ovov) * -1.0
    t2new_aaaa += np.einsum("ikac,jlbd,kdlc->ijab", t2.abab, t2.abab, v.bbbb.ovov) * -1.0
    t2new_aaaa += np.einsum("ikbc,jlad,kdlc->ijab", t2.abab, t2.abab, v.bbbb.ovov)
    t2new_aaaa += np.einsum("ikac,jlbd,kcld->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ikbc,jlad,kcld->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ikcd,jlab,kdlc->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jkac,ilbd,kcld->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_aaaa += np.einsum("jkbc,ilad,kcld->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jkcd,ilab,kdlc->ijab", t2.abab, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_aaaa += np.einsum("klac,ijbd,kdlc->ijab", t2.abab, t2.aaaa, v.aabb.ovov) * 2.0
    t2new_aaaa += np.einsum("klbc,ijad,kdlc->ijab", t2.abab, t2.aaaa, v.aabb.ovov) * -2.0
    t2new_aaaa += np.einsum("ikac,jlbd,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 4.0
    t2new_aaaa += np.einsum("ikab,jlcd,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ikbc,jlad,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -4.0
    t2new_aaaa += np.einsum("ikcd,jlab,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ikac,jlbd,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -4.0
    t2new_aaaa += np.einsum("ikab,jlcd,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ikbc,jlad,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 4.0
    t2new_aaaa += np.einsum("ikcd,jlab,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ijac,klbd,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ijbc,klad,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ijcd,klab,kcld->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("ijac,klbd,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ijbc,klad,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ijcd,klab,kdlc->ijab", t2.aaaa, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,ka,lb,jklc->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ic,ka,lb,jlkc->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("jc,ka,lb,iklc->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ooov)
    t2new_aaaa += np.einsum("jc,ka,lb,ilkc->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ooov) * -1.0
    t2new_aaaa += np.einsum("ic,jd,ka,kcbd->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ic,jd,ka,kdbc->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("ic,jd,kb,kcad->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ovvv)
    t2new_aaaa += np.einsum("ic,jd,kb,kdac->ijab", t1.aa, t1.aa, t1.aa, v.aaaa.ovvv) * -1.0
    t2new_aaaa += np.einsum("ic,ka,jlbd,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aabb.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,kb,jlad,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aabb.ovov)
    t2new_aaaa += np.einsum("jc,ka,ilbd,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aabb.ovov)
    t2new_aaaa += np.einsum("jc,kb,ilad,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aabb.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,jd,klab,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("ic,jd,klab,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("ic,ka,jlbd,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ic,ka,jlbd,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ic,kb,jlad,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ic,kb,jlad,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ic,kd,jlab,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ic,kd,jlab,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jc,ka,ilbd,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jc,ka,ilbd,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("jc,kb,ilad,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("jc,kb,ilad,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jc,kd,ilab,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jc,kd,ilab,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ka,lb,ijcd,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("ka,lb,ijcd,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_aaaa += np.einsum("kc,la,ijbd,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("kc,la,ijbd,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("kc,lb,ijad,kcld->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_aaaa += np.einsum("kc,lb,ijad,kdlc->ijab", t1.aa, t1.aa, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_aaaa += np.einsum("ic,kd,jlab,kdlc->ijab", t1.aa, t1.bb, t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_aaaa += np.einsum("jc,kd,ilab,kdlc->ijab", t1.aa, t1.bb, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_aaaa += np.einsum("ka,lc,ijbd,kdlc->ijab", t1.aa, t1.bb, t2.aaaa, v.aabb.ovov) * 2.0
    t2new_aaaa += np.einsum("kb,lc,ijad,kdlc->ijab", t1.aa, t1.bb, t2.aaaa, v.aabb.ovov) * -2.0
    t2new_aaaa += np.einsum("ic,jd,ka,lb,kcld->ijab", t1.aa, t1.aa, t1.aa, t1.aa, v.aaaa.ovov)
    t2new_aaaa += np.einsum("ic,jd,ka,lb,kdlc->ijab", t1.aa, t1.aa, t1.aa, t1.aa, v.aaaa.ovov) * -1.0
    t2new_abab = np.zeros((nocc[0], nocc[1], nvir[0], nvir[1]), dtype=np.float64)
    t2new_abab += np.einsum("iajb->ijab", v.aabb.ovov)
    t2new_abab += np.einsum("ik,kjab->ijab", f.aa.oo, t2.abab) * -1.0
    t2new_abab += np.einsum("jk,ikab->ijab", f.bb.oo, t2.abab) * -1.0
    t2new_abab += np.einsum("ac,ijcb->ijab", f.aa.vv, t2.abab)
    t2new_abab += np.einsum("bc,ijac->ijab", f.bb.vv, t2.abab)
    t2new_abab += np.einsum("ka,ikjb->ijab", t1.aa, v.aabb.ooov) * -1.0
    t2new_abab += np.einsum("ic,jbac->ijab", t1.aa, v.bbaa.ovvv)
    t2new_abab += np.einsum("kb,jkia->ijab", t1.bb, v.bbaa.ooov) * -1.0
    t2new_abab += np.einsum("jc,iabc->ijab", t1.bb, v.aabb.ovvv)
    t2new_abab += np.einsum("klab,ikjl->ijab", t2.abab, v.aabb.oooo)
    t2new_abab += np.einsum("ikac,jkbc->ijab", t2.abab, v.bbbb.oovv) * -1.0
    t2new_abab += np.einsum("ikcb,jkac->ijab", t2.abab, v.bbaa.oovv) * -1.0
    t2new_abab += np.einsum("kjac,ikbc->ijab", t2.abab, v.aabb.oovv) * -1.0
    t2new_abab += np.einsum("kjcb,ikac->ijab", t2.abab, v.aaaa.oovv) * -1.0
    t2new_abab += np.einsum("ikac,jbkc->ijab", t2.abab, v.bbbb.ovov)
    t2new_abab += np.einsum("kjcb,iakc->ijab", t2.abab, v.aaaa.ovov)
    t2new_abab += np.einsum("ijcd,acbd->ijab", t2.abab, v.aabb.vvvv)
    t2new_abab += np.einsum("ikac,jbkc->ijab", t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_abab += np.einsum("jkbc,iakc->ijab", t2.bbbb, v.aabb.ovov) * 2.0
    t2new_abab += np.einsum("kc,ic,kjab->ijab", f.aa.ov, t1.aa, t2.abab) * -1.0
    t2new_abab += np.einsum("kc,ka,ijcb->ijab", f.aa.ov, t1.aa, t2.abab) * -1.0
    t2new_abab += np.einsum("kc,jc,ikab->ijab", f.bb.ov, t1.bb, t2.abab) * -1.0
    t2new_abab += np.einsum("kc,kb,ijac->ijab", f.bb.ov, t1.bb, t2.abab) * -1.0
    t2new_abab += np.einsum("ic,ka,jbkc->ijab", t1.aa, t1.aa, v.bbaa.ovov) * -1.0
    t2new_abab += np.einsum("ic,kb,jkac->ijab", t1.aa, t1.bb, v.bbaa.oovv) * -1.0
    t2new_abab += np.einsum("ka,jc,ikbc->ijab", t1.aa, t1.bb, v.aabb.oovv) * -1.0
    t2new_abab += np.einsum("ka,lb,ikjl->ijab", t1.aa, t1.bb, v.aabb.oooo)
    t2new_abab += np.einsum("ic,jd,acbd->ijab", t1.aa, t1.bb, v.aabb.vvvv)
    t2new_abab += np.einsum("jc,kb,iakc->ijab", t1.bb, t1.bb, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("ic,klab,jlkc->ijab", t1.aa, t2.abab, v.bbaa.ooov)
    t2new_abab += np.einsum("ka,ilcb,jlkc->ijab", t1.aa, t2.abab, v.bbaa.ooov)
    t2new_abab += np.einsum("ka,ljcb,iklc->ijab", t1.aa, t2.abab, v.aaaa.ooov) * -1.0
    t2new_abab += np.einsum("ka,ljcb,ilkc->ijab", t1.aa, t2.abab, v.aaaa.ooov)
    t2new_abab += np.einsum("kc,ilab,jlkc->ijab", t1.aa, t2.abab, v.bbaa.ooov) * -1.0
    t2new_abab += np.einsum("kc,ljab,iklc->ijab", t1.aa, t2.abab, v.aaaa.ooov)
    t2new_abab += np.einsum("kc,ljab,ilkc->ijab", t1.aa, t2.abab, v.aaaa.ooov) * -1.0
    t2new_abab += np.einsum("ic,kjad,kcbd->ijab", t1.aa, t2.abab, v.aabb.ovvv) * -1.0
    t2new_abab += np.einsum("ic,kjdb,kcad->ijab", t1.aa, t2.abab, v.aaaa.ovvv) * -1.0
    t2new_abab += np.einsum("ic,kjdb,kdac->ijab", t1.aa, t2.abab, v.aaaa.ovvv)
    t2new_abab += np.einsum("ka,ijcd,kcbd->ijab", t1.aa, t2.abab, v.aabb.ovvv) * -1.0
    t2new_abab += np.einsum("kc,ijad,kcbd->ijab", t1.aa, t2.abab, v.aabb.ovvv)
    t2new_abab += np.einsum("kc,ijdb,kcad->ijab", t1.aa, t2.abab, v.aaaa.ovvv)
    t2new_abab += np.einsum("kc,ijdb,kdac->ijab", t1.aa, t2.abab, v.aaaa.ovvv) * -1.0
    t2new_abab += np.einsum("ka,jlbc,iklc->ijab", t1.aa, t2.bbbb, v.aabb.ooov) * -2.0
    t2new_abab += np.einsum("ic,jkbd,kdac->ijab", t1.aa, t2.bbbb, v.bbaa.ovvv) * 2.0
    t2new_abab += np.einsum("jc,klab,iklc->ijab", t1.bb, t2.abab, v.aabb.ooov)
    t2new_abab += np.einsum("kb,ilac,jklc->ijab", t1.bb, t2.abab, v.bbbb.ooov) * -1.0
    t2new_abab += np.einsum("kb,ilac,jlkc->ijab", t1.bb, t2.abab, v.bbbb.ooov)
    t2new_abab += np.einsum("kb,ljac,ilkc->ijab", t1.bb, t2.abab, v.aabb.ooov)
    t2new_abab += np.einsum("kc,ilab,jklc->ijab", t1.bb, t2.abab, v.bbbb.ooov)
    t2new_abab += np.einsum("kc,ilab,jlkc->ijab", t1.bb, t2.abab, v.bbbb.ooov) * -1.0
    t2new_abab += np.einsum("kc,ljab,ilkc->ijab", t1.bb, t2.abab, v.aabb.ooov) * -1.0
    t2new_abab += np.einsum("jc,ikad,kcbd->ijab", t1.bb, t2.abab, v.bbbb.ovvv) * -1.0
    t2new_abab += np.einsum("jc,ikdb,kcad->ijab", t1.bb, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_abab += np.einsum("jc,ikad,kdbc->ijab", t1.bb, t2.abab, v.bbbb.ovvv)
    t2new_abab += np.einsum("kb,ijcd,kdac->ijab", t1.bb, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_abab += np.einsum("kc,ijad,kcbd->ijab", t1.bb, t2.abab, v.bbbb.ovvv)
    t2new_abab += np.einsum("kc,ijdb,kcad->ijab", t1.bb, t2.abab, v.bbaa.ovvv)
    t2new_abab += np.einsum("kc,ijad,kdbc->ijab", t1.bb, t2.abab, v.bbbb.ovvv) * -1.0
    t2new_abab += np.einsum("kb,ilac,jklc->ijab", t1.bb, t2.aaaa, v.bbaa.ooov) * -2.0
    t2new_abab += np.einsum("jc,ikad,kdbc->ijab", t1.bb, t2.aaaa, v.aabb.ovvv) * 2.0
    t2new_abab += np.einsum("ijcb,klad,kcld->ijab", t2.abab, t2.abab, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("ijcd,klab,kcld->ijab", t2.abab, t2.abab, v.aabb.ovov)
    t2new_abab += np.einsum("ijac,kldb,kdlc->ijab", t2.abab, t2.abab, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("ikac,ljdb,kcld->ijab", t2.abab, t2.abab, v.bbaa.ovov)
    t2new_abab += np.einsum("ikab,ljcd,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov) * -1.0
    t2new_abab += np.einsum("ikcb,ljad,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov)
    t2new_abab += np.einsum("ikcd,ljab,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov) * -1.0
    t2new_abab += np.einsum("ikac,jlbd,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_abab += np.einsum("ikab,jlcd,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_abab += np.einsum("ikac,jlbd,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_abab += np.einsum("ikab,jlcd,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov)
    t2new_abab += np.einsum("ijac,klbd,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_abab += np.einsum("ijcb,klad,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_abab += np.einsum("ijac,klbd,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov)
    t2new_abab += np.einsum("ijcb,klad,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov)
    t2new_abab += np.einsum("kjab,ilcd,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_abab += np.einsum("kjcb,ilad,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_abab += np.einsum("kjab,ilcd,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov)
    t2new_abab += np.einsum("kjcb,ilad,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_abab += np.einsum("ikac,jlbd,kcld->ijab", t2.aaaa, t2.bbbb, v.aabb.ovov) * 4.0
    t2new_abab += np.einsum("ic,ka,lb,jlkc->ijab", t1.aa, t1.aa, t1.bb, v.bbaa.ooov)
    t2new_abab += np.einsum("ic,ka,jd,kcbd->ijab", t1.aa, t1.aa, t1.bb, v.aabb.ovvv) * -1.0
    t2new_abab += np.einsum("ka,jc,lb,iklc->ijab", t1.aa, t1.bb, t1.bb, v.aabb.ooov)
    t2new_abab += np.einsum("ic,jd,kb,kdac->ijab", t1.aa, t1.bb, t1.bb, v.bbaa.ovvv) * -1.0
    t2new_abab += np.einsum("ic,ka,ljdb,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_abab += np.einsum("ic,ka,ljdb,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_abab += np.einsum("ic,kd,ljab,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_abab += np.einsum("ic,kd,ljab,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_abab += np.einsum("kc,la,ijdb,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_abab += np.einsum("kc,la,ijdb,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_abab += np.einsum("ic,ka,jlbd,kcld->ijab", t1.aa, t1.aa, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_abab += np.einsum("ic,jd,klab,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_abab += np.einsum("ic,kb,ljad,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.bbaa.ovov)
    t2new_abab += np.einsum("ic,kd,ljab,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.bbaa.ovov) * -1.0
    t2new_abab += np.einsum("ka,jc,ildb,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_abab += np.einsum("kc,jd,ilab,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("ka,lb,ijcd,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_abab += np.einsum("ka,lc,ijdb,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("kc,lb,ijad,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_abab += np.einsum("jc,kb,ilad,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_abab += np.einsum("jc,kb,ilad,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_abab += np.einsum("jc,kd,ilab,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_abab += np.einsum("jc,kd,ilab,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_abab += np.einsum("kc,lb,ijad,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_abab += np.einsum("kc,lb,ijad,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_abab += np.einsum("jc,kb,ilad,kcld->ijab", t1.bb, t1.bb, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_abab += np.einsum("ic,ka,jd,lb,kcld->ijab", t1.aa, t1.aa, t1.bb, t1.bb, v.aabb.ovov)
    t2new_baba = np.zeros((nocc[1], nocc[0], nvir[1], nvir[0]), dtype=np.float64)
    t2new_baba += np.einsum("iajb->ijab", v.bbaa.ovov)
    t2new_baba += np.einsum("ik,jkba->ijab", f.bb.oo, t2.abab) * -1.0
    t2new_baba += np.einsum("jk,kiba->ijab", f.aa.oo, t2.abab) * -1.0
    t2new_baba += np.einsum("ac,jibc->ijab", f.bb.vv, t2.abab)
    t2new_baba += np.einsum("bc,jica->ijab", f.aa.vv, t2.abab)
    t2new_baba += np.einsum("kb,jkia->ijab", t1.aa, v.aabb.ooov) * -1.0
    t2new_baba += np.einsum("jc,iabc->ijab", t1.aa, v.bbaa.ovvv)
    t2new_baba += np.einsum("ka,ikjb->ijab", t1.bb, v.bbaa.ooov) * -1.0
    t2new_baba += np.einsum("ic,jbac->ijab", t1.bb, v.aabb.ovvv)
    t2new_baba += np.einsum("klba,iljk->ijab", t2.abab, v.bbaa.oooo)
    t2new_baba += np.einsum("jkbc,ikac->ijab", t2.abab, v.bbbb.oovv) * -1.0
    t2new_baba += np.einsum("jkca,ikbc->ijab", t2.abab, v.bbaa.oovv) * -1.0
    t2new_baba += np.einsum("kibc,jkac->ijab", t2.abab, v.aabb.oovv) * -1.0
    t2new_baba += np.einsum("kica,jkbc->ijab", t2.abab, v.aaaa.oovv) * -1.0
    t2new_baba += np.einsum("jkbc,iakc->ijab", t2.abab, v.bbbb.ovov)
    t2new_baba += np.einsum("kica,jbkc->ijab", t2.abab, v.aaaa.ovov)
    t2new_baba += np.einsum("jicd,adbc->ijab", t2.abab, v.bbaa.vvvv)
    t2new_baba += np.einsum("ikac,jbkc->ijab", t2.bbbb, v.aabb.ovov) * 2.0
    t2new_baba += np.einsum("jkbc,iakc->ijab", t2.aaaa, v.bbaa.ovov) * 2.0
    t2new_baba += np.einsum("kc,jc,kiba->ijab", f.aa.ov, t1.aa, t2.abab) * -1.0
    t2new_baba += np.einsum("kc,kb,jica->ijab", f.aa.ov, t1.aa, t2.abab) * -1.0
    t2new_baba += np.einsum("kc,ic,jkba->ijab", f.bb.ov, t1.bb, t2.abab) * -1.0
    t2new_baba += np.einsum("kc,ka,jibc->ijab", f.bb.ov, t1.bb, t2.abab) * -1.0
    t2new_baba += np.einsum("jc,kb,iakc->ijab", t1.aa, t1.aa, v.bbaa.ovov) * -1.0
    t2new_baba += np.einsum("jc,ka,ikbc->ijab", t1.aa, t1.bb, v.bbaa.oovv) * -1.0
    t2new_baba += np.einsum("kb,ic,jkac->ijab", t1.aa, t1.bb, v.aabb.oovv) * -1.0
    t2new_baba += np.einsum("kb,la,iljk->ijab", t1.aa, t1.bb, v.bbaa.oooo)
    t2new_baba += np.einsum("jc,id,adbc->ijab", t1.aa, t1.bb, v.bbaa.vvvv)
    t2new_baba += np.einsum("ic,ka,jbkc->ijab", t1.bb, t1.bb, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("jc,klba,ilkc->ijab", t1.aa, t2.abab, v.bbaa.ooov)
    t2new_baba += np.einsum("kb,jlca,ilkc->ijab", t1.aa, t2.abab, v.bbaa.ooov)
    t2new_baba += np.einsum("kb,lica,jklc->ijab", t1.aa, t2.abab, v.aaaa.ooov) * -1.0
    t2new_baba += np.einsum("kb,lica,jlkc->ijab", t1.aa, t2.abab, v.aaaa.ooov)
    t2new_baba += np.einsum("kc,jlba,ilkc->ijab", t1.aa, t2.abab, v.bbaa.ooov) * -1.0
    t2new_baba += np.einsum("kc,liba,jklc->ijab", t1.aa, t2.abab, v.aaaa.ooov)
    t2new_baba += np.einsum("kc,liba,jlkc->ijab", t1.aa, t2.abab, v.aaaa.ooov) * -1.0
    t2new_baba += np.einsum("jc,kibd,kcad->ijab", t1.aa, t2.abab, v.aabb.ovvv) * -1.0
    t2new_baba += np.einsum("jc,kida,kcbd->ijab", t1.aa, t2.abab, v.aaaa.ovvv) * -1.0
    t2new_baba += np.einsum("jc,kida,kdbc->ijab", t1.aa, t2.abab, v.aaaa.ovvv)
    t2new_baba += np.einsum("kb,jicd,kcad->ijab", t1.aa, t2.abab, v.aabb.ovvv) * -1.0
    t2new_baba += np.einsum("kc,jibd,kcad->ijab", t1.aa, t2.abab, v.aabb.ovvv)
    t2new_baba += np.einsum("kc,jida,kcbd->ijab", t1.aa, t2.abab, v.aaaa.ovvv)
    t2new_baba += np.einsum("kc,jida,kdbc->ijab", t1.aa, t2.abab, v.aaaa.ovvv) * -1.0
    t2new_baba += np.einsum("kb,ilac,jklc->ijab", t1.aa, t2.bbbb, v.aabb.ooov) * -2.0
    t2new_baba += np.einsum("jc,ikad,kdbc->ijab", t1.aa, t2.bbbb, v.bbaa.ovvv) * 2.0
    t2new_baba += np.einsum("ic,klba,jklc->ijab", t1.bb, t2.abab, v.aabb.ooov)
    t2new_baba += np.einsum("ka,jlbc,iklc->ijab", t1.bb, t2.abab, v.bbbb.ooov) * -1.0
    t2new_baba += np.einsum("ka,jlbc,ilkc->ijab", t1.bb, t2.abab, v.bbbb.ooov)
    t2new_baba += np.einsum("ka,libc,jlkc->ijab", t1.bb, t2.abab, v.aabb.ooov)
    t2new_baba += np.einsum("kc,jlba,iklc->ijab", t1.bb, t2.abab, v.bbbb.ooov)
    t2new_baba += np.einsum("kc,jlba,ilkc->ijab", t1.bb, t2.abab, v.bbbb.ooov) * -1.0
    t2new_baba += np.einsum("kc,liba,jlkc->ijab", t1.bb, t2.abab, v.aabb.ooov) * -1.0
    t2new_baba += np.einsum("ic,jkbd,kcad->ijab", t1.bb, t2.abab, v.bbbb.ovvv) * -1.0
    t2new_baba += np.einsum("ic,jkda,kcbd->ijab", t1.bb, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_baba += np.einsum("ic,jkbd,kdac->ijab", t1.bb, t2.abab, v.bbbb.ovvv)
    t2new_baba += np.einsum("ka,jicd,kdbc->ijab", t1.bb, t2.abab, v.bbaa.ovvv) * -1.0
    t2new_baba += np.einsum("kc,jibd,kcad->ijab", t1.bb, t2.abab, v.bbbb.ovvv)
    t2new_baba += np.einsum("kc,jida,kcbd->ijab", t1.bb, t2.abab, v.bbaa.ovvv)
    t2new_baba += np.einsum("kc,jibd,kdac->ijab", t1.bb, t2.abab, v.bbbb.ovvv) * -1.0
    t2new_baba += np.einsum("ka,jlbc,iklc->ijab", t1.bb, t2.aaaa, v.bbaa.ooov) * -2.0
    t2new_baba += np.einsum("ic,jkbd,kdac->ijab", t1.bb, t2.aaaa, v.aabb.ovvv) * 2.0
    t2new_baba += np.einsum("jica,klbd,kcld->ijab", t2.abab, t2.abab, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("jicd,klba,kcld->ijab", t2.abab, t2.abab, v.aabb.ovov)
    t2new_baba += np.einsum("jibc,klda,kdlc->ijab", t2.abab, t2.abab, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("jkbc,lida,kcld->ijab", t2.abab, t2.abab, v.bbaa.ovov)
    t2new_baba += np.einsum("jkba,licd,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov) * -1.0
    t2new_baba += np.einsum("jkca,libd,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov)
    t2new_baba += np.einsum("jkcd,liba,kdlc->ijab", t2.abab, t2.abab, v.bbaa.ovov) * -1.0
    t2new_baba += np.einsum("jkbc,ilad,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_baba += np.einsum("jkba,ilcd,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_baba += np.einsum("jkbc,ilad,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_baba += np.einsum("jkba,ilcd,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov)
    t2new_baba += np.einsum("jibc,klad,kcld->ijab", t2.abab, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_baba += np.einsum("jica,klbd,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_baba += np.einsum("jibc,klad,kdlc->ijab", t2.abab, t2.bbbb, v.bbbb.ovov)
    t2new_baba += np.einsum("jica,klbd,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov)
    t2new_baba += np.einsum("kiba,jlcd,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -1.0
    t2new_baba += np.einsum("kica,jlbd,kcld->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * 2.0
    t2new_baba += np.einsum("kiba,jlcd,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov)
    t2new_baba += np.einsum("kica,jlbd,kdlc->ijab", t2.abab, t2.aaaa, v.aaaa.ovov) * -2.0
    t2new_baba += np.einsum("ikac,jlbd,kcld->ijab", t2.bbbb, t2.aaaa, v.bbaa.ovov) * 4.0
    t2new_baba += np.einsum("jc,kb,la,ilkc->ijab", t1.aa, t1.aa, t1.bb, v.bbaa.ooov)
    t2new_baba += np.einsum("jc,kb,id,kcad->ijab", t1.aa, t1.aa, t1.bb, v.aabb.ovvv) * -1.0
    t2new_baba += np.einsum("kb,ic,la,jklc->ijab", t1.aa, t1.bb, t1.bb, v.aabb.ooov)
    t2new_baba += np.einsum("jc,id,ka,kdbc->ijab", t1.aa, t1.bb, t1.bb, v.bbaa.ovvv) * -1.0
    t2new_baba += np.einsum("jc,kb,lida,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_baba += np.einsum("jc,kb,lida,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_baba += np.einsum("jc,kd,liba,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_baba += np.einsum("jc,kd,liba,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_baba += np.einsum("kc,lb,jida,kcld->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov) * -1.0
    t2new_baba += np.einsum("kc,lb,jida,kdlc->ijab", t1.aa, t1.aa, t2.abab, v.aaaa.ovov)
    t2new_baba += np.einsum("jc,kb,ilad,kcld->ijab", t1.aa, t1.aa, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_baba += np.einsum("jc,id,klba,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_baba += np.einsum("jc,ka,libd,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.bbaa.ovov)
    t2new_baba += np.einsum("jc,kd,liba,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.bbaa.ovov) * -1.0
    t2new_baba += np.einsum("kb,ic,jlda,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_baba += np.einsum("kc,id,jlba,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("kb,la,jicd,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov)
    t2new_baba += np.einsum("kb,lc,jida,kdlc->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("kc,la,jibd,kcld->ijab", t1.aa, t1.bb, t2.abab, v.aabb.ovov) * -1.0
    t2new_baba += np.einsum("ic,ka,jlbd,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_baba += np.einsum("ic,ka,jlbd,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_baba += np.einsum("ic,kd,jlba,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_baba += np.einsum("ic,kd,jlba,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_baba += np.einsum("kc,la,jibd,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov) * -1.0
    t2new_baba += np.einsum("kc,la,jibd,kdlc->ijab", t1.bb, t1.bb, t2.abab, v.bbbb.ovov)
    t2new_baba += np.einsum("ic,ka,jlbd,kcld->ijab", t1.bb, t1.bb, t2.aaaa, v.bbaa.ovov) * -2.0
    t2new_baba += np.einsum("jc,kb,id,la,kcld->ijab", t1.aa, t1.aa, t1.bb, t1.bb, v.aabb.ovov)
    t2new_bbbb = np.zeros((nocc[1], nocc[1], nvir[1], nvir[1]), dtype=np.float64)
    t2new_bbbb += np.einsum("iajb->ijab", v.bbbb.ovov)
    t2new_bbbb += np.einsum("ibja->ijab", v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("ik,jkab->ijab", f.bb.oo, t2.bbbb) * 2.0
    t2new_bbbb += np.einsum("jk,ikab->ijab", f.bb.oo, t2.bbbb) * -2.0
    t2new_bbbb += np.einsum("ac,ijbc->ijab", f.bb.vv, t2.bbbb) * -2.0
    t2new_bbbb += np.einsum("bc,ijac->ijab", f.bb.vv, t2.bbbb) * 2.0
    t2new_bbbb += np.einsum("ka,ikjb->ijab", t1.bb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ka,jkib->ijab", t1.bb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("kb,ikja->ijab", t1.bb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("kb,jkia->ijab", t1.bb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ic,jabc->ijab", t1.bb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("ic,jbac->ijab", t1.bb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("jc,iabc->ijab", t1.bb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("jc,ibac->ijab", t1.bb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("kjcb,iakc->ijab", t2.abab, v.bbaa.ovov)
    t2new_bbbb += np.einsum("kjca,ibkc->ijab", t2.abab, v.bbaa.ovov) * -1.0
    t2new_bbbb += np.einsum("kicb,jakc->ijab", t2.abab, v.bbaa.ovov) * -1.0
    t2new_bbbb += np.einsum("kica,jbkc->ijab", t2.abab, v.bbaa.ovov)
    t2new_bbbb += np.einsum("klab,ikjl->ijab", t2.bbbb, v.bbbb.oooo)
    t2new_bbbb += np.einsum("klab,iljk->ijab", t2.bbbb, v.bbbb.oooo) * -1.0
    t2new_bbbb += np.einsum("ikac,jkbc->ijab", t2.bbbb, v.bbbb.oovv) * -2.0
    t2new_bbbb += np.einsum("ikbc,jkac->ijab", t2.bbbb, v.bbbb.oovv) * 2.0
    t2new_bbbb += np.einsum("jkac,ikbc->ijab", t2.bbbb, v.bbbb.oovv) * 2.0
    t2new_bbbb += np.einsum("jkbc,ikac->ijab", t2.bbbb, v.bbbb.oovv) * -2.0
    t2new_bbbb += np.einsum("ikbc,jakc->ijab", t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ikac,jbkc->ijab", t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jkbc,iakc->ijab", t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jkac,ibkc->ijab", t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ijcd,acbd->ijab", t2.bbbb, v.bbbb.vvvv)
    t2new_bbbb += np.einsum("ijcd,adbc->ijab", t2.bbbb, v.bbbb.vvvv) * -1.0
    t2new_bbbb += np.einsum("kc,ic,jkab->ijab", f.bb.ov, t1.bb, t2.bbbb) * 2.0
    t2new_bbbb += np.einsum("kc,jc,ikab->ijab", f.bb.ov, t1.bb, t2.bbbb) * -2.0
    t2new_bbbb += np.einsum("kc,ka,ijbc->ijab", f.bb.ov, t1.bb, t2.bbbb) * 2.0
    t2new_bbbb += np.einsum("kc,kb,ijac->ijab", f.bb.ov, t1.bb, t2.bbbb) * -2.0
    t2new_bbbb += np.einsum("ic,ka,jkbc->ijab", t1.bb, t1.bb, v.bbbb.oovv)
    t2new_bbbb += np.einsum("ic,kb,jkac->ijab", t1.bb, t1.bb, v.bbbb.oovv) * -1.0
    t2new_bbbb += np.einsum("jc,ka,ikbc->ijab", t1.bb, t1.bb, v.bbbb.oovv) * -1.0
    t2new_bbbb += np.einsum("jc,kb,ikac->ijab", t1.bb, t1.bb, v.bbbb.oovv)
    t2new_bbbb += np.einsum("ka,lb,ikjl->ijab", t1.bb, t1.bb, v.bbbb.oooo)
    t2new_bbbb += np.einsum("ka,lb,iljk->ijab", t1.bb, t1.bb, v.bbbb.oooo) * -1.0
    t2new_bbbb += np.einsum("ic,ka,jbkc->ijab", t1.bb, t1.bb, v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,kb,jakc->ijab", t1.bb, t1.bb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("jc,ka,ibkc->ijab", t1.bb, t1.bb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("jc,kb,iakc->ijab", t1.bb, t1.bb, v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,jd,acbd->ijab", t1.bb, t1.bb, v.bbbb.vvvv)
    t2new_bbbb += np.einsum("ic,jd,adbc->ijab", t1.bb, t1.bb, v.bbbb.vvvv) * -1.0
    t2new_bbbb += np.einsum("kc,ilab,jlkc->ijab", t1.aa, t2.bbbb, v.bbaa.ooov) * -2.0
    t2new_bbbb += np.einsum("kc,jlab,ilkc->ijab", t1.aa, t2.bbbb, v.bbaa.ooov) * 2.0
    t2new_bbbb += np.einsum("kc,ijad,kcbd->ijab", t1.aa, t2.bbbb, v.aabb.ovvv) * 2.0
    t2new_bbbb += np.einsum("kc,ijbd,kcad->ijab", t1.aa, t2.bbbb, v.aabb.ovvv) * -2.0
    t2new_bbbb += np.einsum("ka,ljcb,iklc->ijab", t1.bb, t2.abab, v.bbaa.ooov) * -1.0
    t2new_bbbb += np.einsum("ka,licb,jklc->ijab", t1.bb, t2.abab, v.bbaa.ooov)
    t2new_bbbb += np.einsum("kb,ljca,iklc->ijab", t1.bb, t2.abab, v.bbaa.ooov)
    t2new_bbbb += np.einsum("kb,lica,jklc->ijab", t1.bb, t2.abab, v.bbaa.ooov) * -1.0
    t2new_bbbb += np.einsum("ic,kjdb,kdac->ijab", t1.bb, t2.abab, v.aabb.ovvv)
    t2new_bbbb += np.einsum("ic,kjda,kdbc->ijab", t1.bb, t2.abab, v.aabb.ovvv) * -1.0
    t2new_bbbb += np.einsum("jc,kidb,kdac->ijab", t1.bb, t2.abab, v.aabb.ovvv) * -1.0
    t2new_bbbb += np.einsum("jc,kida,kdbc->ijab", t1.bb, t2.abab, v.aabb.ovvv)
    t2new_bbbb += np.einsum("ic,klab,jklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ic,klab,jlkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("jc,klab,iklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("jc,klab,ilkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ka,ilbc,jklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("ka,ilbc,jlkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("ka,jlbc,iklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("ka,jlbc,ilkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("kb,ilac,jklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("kb,ilac,jlkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("kb,jlac,iklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("kb,jlac,ilkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("kc,ilab,jklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("kc,ilab,jlkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("kc,jlab,iklc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * -2.0
    t2new_bbbb += np.einsum("kc,jlab,ilkc->ijab", t1.bb, t2.bbbb, v.bbbb.ooov) * 2.0
    t2new_bbbb += np.einsum("ic,jkad,kcbd->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("ic,jkbd,kcad->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("ic,jkad,kdbc->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("ic,jkbd,kdac->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("jc,ikad,kcbd->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("jc,ikbd,kcad->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("jc,ikad,kdbc->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("jc,ikbd,kdac->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("ka,ijcd,kcbd->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("ka,ijcd,kdbc->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("kb,ijcd,kcad->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("kb,ijcd,kdac->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("kc,ijad,kcbd->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("kc,ijbd,kcad->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("kc,ijad,kdbc->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * -2.0
    t2new_bbbb += np.einsum("kc,ijbd,kdac->ijab", t1.bb, t2.bbbb, v.bbbb.ovvv) * 2.0
    t2new_bbbb += np.einsum("kica,ljdb,kcld->ijab", t2.abab, t2.abab, v.aaaa.ovov)
    t2new_bbbb += np.einsum("kicb,ljda,kcld->ijab", t2.abab, t2.abab, v.aaaa.ovov) * -1.0
    t2new_bbbb += np.einsum("kica,ljdb,kdlc->ijab", t2.abab, t2.abab, v.aaaa.ovov) * -1.0
    t2new_bbbb += np.einsum("kicb,ljda,kdlc->ijab", t2.abab, t2.abab, v.aaaa.ovov)
    t2new_bbbb += np.einsum("kjcb,ilad,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("kjcd,ilab,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("kjca,ilbd,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("klcb,ijad,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("klca,ijbd,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("kicb,jlad,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("kicd,jlab,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("kica,jlbd,kcld->ijab", t2.abab, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("ikac,jlbd,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 4.0
    t2new_bbbb += np.einsum("ikab,jlcd,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ikbc,jlad,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -4.0
    t2new_bbbb += np.einsum("ikcd,jlab,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ikac,jlbd,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -4.0
    t2new_bbbb += np.einsum("ikab,jlcd,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ikbc,jlad,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 4.0
    t2new_bbbb += np.einsum("ikcd,jlab,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ijac,klbd,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ijbc,klad,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ijcd,klab,kcld->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("ijac,klbd,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ijbc,klad,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ijcd,klab,kdlc->ijab", t2.bbbb, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,ka,lb,jklc->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ic,ka,lb,jlkc->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("jc,ka,lb,iklc->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ooov)
    t2new_bbbb += np.einsum("jc,ka,lb,ilkc->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ooov) * -1.0
    t2new_bbbb += np.einsum("ic,jd,ka,kcbd->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("ic,jd,ka,kdbc->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("ic,jd,kb,kcad->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ovvv)
    t2new_bbbb += np.einsum("ic,jd,kb,kdac->ijab", t1.bb, t1.bb, t1.bb, v.bbbb.ovvv) * -1.0
    t2new_bbbb += np.einsum("kc,id,jlab,kcld->ijab", t1.aa, t1.bb, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("kc,jd,ilab,kcld->ijab", t1.aa, t1.bb, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("kc,la,ijbd,kcld->ijab", t1.aa, t1.bb, t2.bbbb, v.aabb.ovov) * 2.0
    t2new_bbbb += np.einsum("kc,lb,ijad,kcld->ijab", t1.aa, t1.bb, t2.bbbb, v.aabb.ovov) * -2.0
    t2new_bbbb += np.einsum("ic,ka,ljdb,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbaa.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,kb,ljda,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbaa.ovov)
    t2new_bbbb += np.einsum("jc,ka,lidb,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbaa.ovov)
    t2new_bbbb += np.einsum("jc,kb,lida,kcld->ijab", t1.bb, t1.bb, t2.abab, v.bbaa.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,jd,klab,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("ic,jd,klab,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("ic,ka,jlbd,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ic,ka,jlbd,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ic,kb,jlad,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ic,kb,jlad,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ic,kd,jlab,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ic,kd,jlab,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jc,ka,ilbd,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jc,ka,ilbd,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("jc,kb,ilad,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("jc,kb,ilad,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jc,kd,ilab,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("jc,kd,ilab,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("ka,lb,ijcd,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("ka,lb,ijcd,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -1.0
    t2new_bbbb += np.einsum("kc,la,ijbd,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("kc,la,ijbd,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("kc,lb,ijad,kcld->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * -2.0
    t2new_bbbb += np.einsum("kc,lb,ijad,kdlc->ijab", t1.bb, t1.bb, t2.bbbb, v.bbbb.ovov) * 2.0
    t2new_bbbb += np.einsum("ic,jd,ka,lb,kcld->ijab", t1.bb, t1.bb, t1.bb, t1.bb, v.bbbb.ovov)
    t2new_bbbb += np.einsum("ic,jd,ka,lb,kdlc->ijab", t1.bb, t1.bb, t1.bb, t1.bb, v.bbbb.ovov) * -1.0

    t1new.aa = t1new_aa
    t1new.bb = t1new_bb
    t2new.aaaa = t2new_aaaa
    t2new.abab = t2new_abab
    t2new.baba = t2new_baba
    t2new.bbbb = t2new_bbbb

    return {"t1new": t1new, "t2new": t2new}

def energy_perturbative(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    # T3 amplitude
    t3_aaaaaa = np.zeros((nocc[0], nocc[0], nocc[0], nvir[0], nvir[0], nvir[0]), dtype=np.float64)
    t3_aaaaaa += einsum("ilab,jlkc->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("ilac,jlkb->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("ilbc,jlka->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("ilab,kljc->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("ilac,kljb->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("ilbc,klja->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("jlab,ilkc->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("jlac,ilkb->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("jlbc,ilka->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("jlab,klic->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("jlac,klib->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("jlbc,klia->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("klab,iljc->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("klac,iljb->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("klbc,ilja->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("klab,jlic->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("klac,jlib->ijkabc", t2.aaaa, v.aaaa.ooov) * -2.0
    t3_aaaaaa += einsum("klbc,jlia->ijkabc", t2.aaaa, v.aaaa.ooov) * 2.0
    t3_aaaaaa += einsum("ikbd,jacd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("ikcd,jabd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ikad,jbcd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ikcd,jbad->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("ikad,jcbd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("ikbd,jcad->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ijbd,kacd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ijcd,kabd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("ijad,kbcd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("ijcd,kbad->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ijad,kcbd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("ijbd,kcad->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("jkbd,iacd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("jkcd,iabd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("jkad,ibcd->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aaaaaa += einsum("jkcd,ibad->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("jkad,icbd->ijkabc", t2.aaaa, v.aaaa.ovvv) * 2.0
    t3_aaaaaa += einsum("jkbd,icad->ijkabc", t2.aaaa, v.aaaa.ovvv) * -2.0
    t3_aabaab = np.zeros((nocc[0], nocc[0], nocc[1], nvir[0], nvir[0], nvir[1]), dtype=np.float64)
    t3_aabaab += einsum("ilac,kljb->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_aabaab += einsum("ilbc,klja->ijkabc", t2.abab, v.bbaa.ooov)
    t3_aabaab += einsum("jlac,klib->ijkabc", t2.abab, v.bbaa.ooov)
    t3_aabaab += einsum("jlbc,klia->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_aabaab += einsum("lkac,iljb->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_aabaab += einsum("lkbc,ilja->ijkabc", t2.abab, v.aaaa.ooov)
    t3_aabaab += einsum("lkac,jlib->ijkabc", t2.abab, v.aaaa.ooov)
    t3_aabaab += einsum("lkbc,jlia->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_aabaab += einsum("ikbd,jacd->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_aabaab += einsum("ikdc,jabd->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_aabaab += einsum("ikad,jbcd->ijkabc", t2.abab, v.aabb.ovvv)
    t3_aabaab += einsum("ikdc,jbad->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_aabaab += einsum("jkbd,iacd->ijkabc", t2.abab, v.aabb.ovvv)
    t3_aabaab += einsum("jkdc,iabd->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_aabaab += einsum("jkad,ibcd->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_aabaab += einsum("jkdc,ibad->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_aabaab += einsum("ilab,jlkc->ijkabc", t2.aaaa, v.aabb.ooov) * -2.0
    t3_aabaab += einsum("jlab,ilkc->ijkabc", t2.aaaa, v.aabb.ooov) * 2.0
    t3_aabaab += einsum("ijad,kcbd->ijkabc", t2.aaaa, v.bbaa.ovvv) * 2.0
    t3_aabaab += einsum("ijbd,kcad->ijkabc", t2.aaaa, v.bbaa.ovvv) * -2.0
    t3_abaaba = np.zeros((nocc[0], nocc[1], nocc[0], nvir[0], nvir[1], nvir[0]), dtype=np.float64)
    t3_abaaba += einsum("ilab,jlkc->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_abaaba += einsum("ilcb,jlka->ijkabc", t2.abab, v.bbaa.ooov)
    t3_abaaba += einsum("klab,jlic->ijkabc", t2.abab, v.bbaa.ooov)
    t3_abaaba += einsum("klcb,jlia->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_abaaba += einsum("ljab,ilkc->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_abaaba += einsum("ljcb,ilka->ijkabc", t2.abab, v.aaaa.ooov)
    t3_abaaba += einsum("ljab,klic->ijkabc", t2.abab, v.aaaa.ooov)
    t3_abaaba += einsum("ljcb,klia->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_abaaba += einsum("ijcd,kabd->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_abaaba += einsum("ijdb,kacd->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_abaaba += einsum("ijad,kcbd->ijkabc", t2.abab, v.aabb.ovvv)
    t3_abaaba += einsum("ijdb,kcad->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_abaaba += einsum("kjcd,iabd->ijkabc", t2.abab, v.aabb.ovvv)
    t3_abaaba += einsum("kjdb,iacd->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_abaaba += einsum("kjad,icbd->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_abaaba += einsum("kjdb,icad->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_abaaba += einsum("ilac,kljb->ijkabc", t2.aaaa, v.aabb.ooov) * -2.0
    t3_abaaba += einsum("klac,iljb->ijkabc", t2.aaaa, v.aabb.ooov) * 2.0
    t3_abaaba += einsum("ikad,jbcd->ijkabc", t2.aaaa, v.bbaa.ovvv) * 2.0
    t3_abaaba += einsum("ikcd,jbad->ijkabc", t2.aaaa, v.bbaa.ovvv) * -2.0
    t3_abbabb = np.zeros((nocc[0], nocc[1], nocc[1], nvir[0], nvir[1], nvir[1]), dtype=np.float64)
    t3_abbabb += einsum("ilab,jlkc->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_abbabb += einsum("ilac,jlkb->ijkabc", t2.abab, v.bbbb.ooov)
    t3_abbabb += einsum("ilab,kljc->ijkabc", t2.abab, v.bbbb.ooov)
    t3_abbabb += einsum("ilac,kljb->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_abbabb += einsum("ljab,ilkc->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_abbabb += einsum("ljac,ilkb->ijkabc", t2.abab, v.aabb.ooov)
    t3_abbabb += einsum("lkab,iljc->ijkabc", t2.abab, v.aabb.ooov)
    t3_abbabb += einsum("lkac,iljb->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_abbabb += einsum("ikad,jbcd->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_abbabb += einsum("ikdc,jbad->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_abbabb += einsum("ikad,jcbd->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_abbabb += einsum("ikdb,jcad->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_abbabb += einsum("ijad,kbcd->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_abbabb += einsum("ijdc,kbad->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_abbabb += einsum("ijad,kcbd->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_abbabb += einsum("ijdb,kcad->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_abbabb += einsum("jlbc,klia->ijkabc", t2.bbbb, v.bbaa.ooov) * -2.0
    t3_abbabb += einsum("klbc,jlia->ijkabc", t2.bbbb, v.bbaa.ooov) * 2.0
    t3_abbabb += einsum("jkbd,iacd->ijkabc", t2.bbbb, v.aabb.ovvv) * 2.0
    t3_abbabb += einsum("jkcd,iabd->ijkabc", t2.bbbb, v.aabb.ovvv) * -2.0
    t3_baabaa = np.zeros((nocc[1], nocc[0], nocc[0], nvir[1], nvir[0], nvir[0]), dtype=np.float64)
    t3_baabaa += einsum("jlba,ilkc->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_baabaa += einsum("jlca,ilkb->ijkabc", t2.abab, v.bbaa.ooov)
    t3_baabaa += einsum("klba,iljc->ijkabc", t2.abab, v.bbaa.ooov)
    t3_baabaa += einsum("klca,iljb->ijkabc", t2.abab, v.bbaa.ooov) * -1.0
    t3_baabaa += einsum("liba,jlkc->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_baabaa += einsum("lica,jlkb->ijkabc", t2.abab, v.aaaa.ooov)
    t3_baabaa += einsum("liba,kljc->ijkabc", t2.abab, v.aaaa.ooov)
    t3_baabaa += einsum("lica,kljb->ijkabc", t2.abab, v.aaaa.ooov) * -1.0
    t3_baabaa += einsum("jicd,kbad->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_baabaa += einsum("jida,kbcd->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_baabaa += einsum("jibd,kcad->ijkabc", t2.abab, v.aabb.ovvv)
    t3_baabaa += einsum("jida,kcbd->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_baabaa += einsum("kicd,jbad->ijkabc", t2.abab, v.aabb.ovvv)
    t3_baabaa += einsum("kida,jbcd->ijkabc", t2.abab, v.aaaa.ovvv)
    t3_baabaa += einsum("kibd,jcad->ijkabc", t2.abab, v.aabb.ovvv) * -1.0
    t3_baabaa += einsum("kida,jcbd->ijkabc", t2.abab, v.aaaa.ovvv) * -1.0
    t3_baabaa += einsum("jlbc,klia->ijkabc", t2.aaaa, v.aabb.ooov) * -2.0
    t3_baabaa += einsum("klbc,jlia->ijkabc", t2.aaaa, v.aabb.ooov) * 2.0
    t3_baabaa += einsum("jkbd,iacd->ijkabc", t2.aaaa, v.bbaa.ovvv) * 2.0
    t3_baabaa += einsum("jkcd,iabd->ijkabc", t2.aaaa, v.bbaa.ovvv) * -2.0
    t3_babbab = np.zeros((nocc[1], nocc[0], nocc[1], nvir[1], nvir[0], nvir[1]), dtype=np.float64)
    t3_babbab += einsum("jlba,ilkc->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_babbab += einsum("jlbc,ilka->ijkabc", t2.abab, v.bbbb.ooov)
    t3_babbab += einsum("jlba,klic->ijkabc", t2.abab, v.bbbb.ooov)
    t3_babbab += einsum("jlbc,klia->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_babbab += einsum("liba,jlkc->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_babbab += einsum("libc,jlka->ijkabc", t2.abab, v.aabb.ooov)
    t3_babbab += einsum("lkba,jlic->ijkabc", t2.abab, v.aabb.ooov)
    t3_babbab += einsum("lkbc,jlia->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_babbab += einsum("jkbd,iacd->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_babbab += einsum("jkdc,iabd->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_babbab += einsum("jkbd,icad->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_babbab += einsum("jkda,icbd->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_babbab += einsum("jibd,kacd->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_babbab += einsum("jidc,kabd->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_babbab += einsum("jibd,kcad->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_babbab += einsum("jida,kcbd->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_babbab += einsum("ilac,kljb->ijkabc", t2.bbbb, v.bbaa.ooov) * -2.0
    t3_babbab += einsum("klac,iljb->ijkabc", t2.bbbb, v.bbaa.ooov) * 2.0
    t3_babbab += einsum("ikad,jbcd->ijkabc", t2.bbbb, v.aabb.ovvv) * 2.0
    t3_babbab += einsum("ikcd,jbad->ijkabc", t2.bbbb, v.aabb.ovvv) * -2.0
    t3_bbabba = np.zeros((nocc[1], nocc[1], nocc[0], nvir[1], nvir[1], nvir[0]), dtype=np.float64)
    t3_bbabba += einsum("klca,iljb->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_bbabba += einsum("klcb,ilja->ijkabc", t2.abab, v.bbbb.ooov)
    t3_bbabba += einsum("klca,jlib->ijkabc", t2.abab, v.bbbb.ooov)
    t3_bbabba += einsum("klcb,jlia->ijkabc", t2.abab, v.bbbb.ooov) * -1.0
    t3_bbabba += einsum("lica,kljb->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_bbabba += einsum("licb,klja->ijkabc", t2.abab, v.aabb.ooov)
    t3_bbabba += einsum("ljca,klib->ijkabc", t2.abab, v.aabb.ooov)
    t3_bbabba += einsum("ljcb,klia->ijkabc", t2.abab, v.aabb.ooov) * -1.0
    t3_bbabba += einsum("kjcd,iabd->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_bbabba += einsum("kjdb,iacd->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_bbabba += einsum("kjcd,ibad->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_bbabba += einsum("kjda,ibcd->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_bbabba += einsum("kicd,jabd->ijkabc", t2.abab, v.bbbb.ovvv) * -1.0
    t3_bbabba += einsum("kidb,jacd->ijkabc", t2.abab, v.bbaa.ovvv) * -1.0
    t3_bbabba += einsum("kicd,jbad->ijkabc", t2.abab, v.bbbb.ovvv)
    t3_bbabba += einsum("kida,jbcd->ijkabc", t2.abab, v.bbaa.ovvv)
    t3_bbabba += einsum("ilab,jlkc->ijkabc", t2.bbbb, v.bbaa.ooov) * -2.0
    t3_bbabba += einsum("jlab,ilkc->ijkabc", t2.bbbb, v.bbaa.ooov) * 2.0
    t3_bbabba += einsum("ijad,kcbd->ijkabc", t2.bbbb, v.aabb.ovvv) * 2.0
    t3_bbabba += einsum("ijbd,kcad->ijkabc", t2.bbbb, v.aabb.ovvv) * -2.0
    t3_bbbbbb = np.zeros((nocc[1], nocc[1], nocc[1], nvir[1], nvir[1], nvir[1]), dtype=np.float64)
    t3_bbbbbb += einsum("ilab,jlkc->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("ilac,jlkb->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("ilbc,jlka->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("ilab,kljc->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("ilac,kljb->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("ilbc,klja->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("jlab,ilkc->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("jlac,ilkb->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("jlbc,ilka->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("jlab,klic->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("jlac,klib->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("jlbc,klia->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("klab,iljc->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("klac,iljb->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("klbc,ilja->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("klab,jlic->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("klac,jlib->ijkabc", t2.bbbb, v.bbbb.ooov) * -2.0
    t3_bbbbbb += einsum("klbc,jlia->ijkabc", t2.bbbb, v.bbbb.ooov) * 2.0
    t3_bbbbbb += einsum("ikbd,jacd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("ikcd,jabd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ikad,jbcd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ikcd,jbad->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("ikad,jcbd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("ikbd,jcad->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ijbd,kacd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ijcd,kabd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("ijad,kbcd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("ijcd,kbad->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ijad,kcbd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("ijbd,kcad->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("jkbd,iacd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("jkcd,iabd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("jkad,ibcd->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    t3_bbbbbb += einsum("jkcd,ibad->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("jkad,icbd->ijkabc", t2.bbbb, v.bbbb.ovvv) * 2.0
    t3_bbbbbb += einsum("jkbd,icad->ijkabc", t2.bbbb, v.bbbb.ovvv) * -2.0
    e_aaaaaa_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
    )
    t3_aaaaaa /= e_aaaaaa_ijkabc
    del e_aaaaaa_ijkabc
    e_aabaab_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
    )
    t3_aabaab /= e_aabaab_ijkabc
    del e_aabaab_ijkabc
    e_abaaba_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
    )
    t3_abaaba /= e_abaaba_ijkabc
    del e_abaaba_ijkabc
    e_abbabb_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
    )
    t3_abbabb /= e_abbabb_ijkabc
    del e_abbabb_ijkabc
    e_baabaa_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
    )
    t3_baabaa /= e_baabaa_ijkabc
    del e_baabaa_ijkabc
    e_babbab_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
    )
    t3_babbab /= e_babbab_ijkabc
    del e_babbab_ijkabc
    e_bbabba_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.aa.oo), np.diag(f.aa.vv)),
    )
    t3_bbabba /= e_bbabba_ijkabc
    del e_bbabba_ijkabc
    e_bbbbbb_ijkabc = direct_sum(
            "ia+jb+kc->ijkabc",
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
            direct_sum("i-a->ia", np.diag(f.bb.oo), np.diag(f.bb.vv)),
    )
    t3_bbbbbb /= e_bbbbbb_ijkabc
    del e_bbbbbb_ijkabc

    # energy
    e_pert = 0
    e_pert += einsum("ai,jbkc,ijkabc->", l1.aa, v.bbaa.ovov, t3.abaaba)
    e_pert += einsum("ai,jbkc,ikjacb->", l1.aa, v.aabb.ovov, t3.abaaba)
    e_pert += einsum("ai,jbkc,ijkabc->", l1.aa, v.bbbb.ovov, t3.abbabb)
    e_pert += einsum("ai,jbkc,ijkabc->", l1.aa, v.aaaa.ovov, t3.aaaaaa) * 3.0
    e_pert += einsum("ai,jbkc,jikbac->", l1.bb, v.aaaa.ovov, t3.abaaba)
    e_pert += einsum("ai,jbkc,ijkabc->", l1.bb, v.aabb.ovov, t3.babbab)
    e_pert += einsum("ai,jbkc,ijkabc->", l1.bb, v.bbaa.ovov, t3.bbabba)
    e_pert += einsum("ai,jbkc,ijkabc->", l1.bb, v.bbbb.ovov, t3.bbbbbb) * 3.0
    e_pert += einsum("abij,iklc,kjlabc->", l2.abab, v.aaaa.ooov, t3.abaaba) * -2.0
    e_pert += einsum("abij,jklc,iklabc->", l2.abab, v.bbaa.ooov, t3.abaaba) * -2.0
    e_pert += einsum("abij,kcad,ijkcbd->", l2.abab, v.aaaa.ovvv, t3.abaaba) * -2.0
    e_pert += einsum("abij,kcbd,ijkadc->", l2.abab, v.aabb.ovvv, t3.abaaba) * 2.0
    e_pert += einsum("abij,iklc,jklbac->", l2.abab, v.aabb.ooov, t3.babbab) * -2.0
    e_pert += einsum("abij,jklc,iklabc->", l2.abab, v.bbbb.ooov, t3.abbabb) * -2.0
    e_pert += einsum("abij,kcad,ijkdbc->", l2.abab, v.bbaa.ovvv, t3.abbabb) * 2.0
    e_pert += einsum("abij,kcbd,ijkacd->", l2.abab, v.bbbb.ovvv, t3.abbabb) * -2.0
    e_pert += einsum("abij,jklc,ilkacb->", l2.aaaa, v.aabb.ooov, t3.abaaba) * -2.0
    e_pert += einsum("abij,kcbd,ikjacd->", l2.aaaa, v.bbaa.ovvv, t3.abaaba) * 2.0
    e_pert += einsum("abij,jklc,iklabc->", l2.aaaa, v.aaaa.ooov, t3.aaaaaa) * -6.0
    e_pert += einsum("abij,jklc,iklabc->", l2.bbbb, v.bbaa.ooov, t3.bbabba) * -2.0
    e_pert += einsum("abij,jklc,iklabc->", l2.bbbb, v.bbbb.ooov, t3.bbbbbb) * -6.0
    e_pert += einsum("abij,kcbd,ijkacd->", l2.aaaa, v.aaaa.ovvv, t3.aaaaaa) * -6.0
    e_pert += einsum("abij,kcbd,ijkacd->", l2.bbbb, v.bbbb.ovvv, t3.bbbbbb) * -6.0
    e_pert += einsum("abij,kcbd,ijkadc->", l2.bbbb, v.aabb.ovvv, t3.bbabba) * 2.0

    return e_pert


# Code generated by qwick.

import numpy as np
from ebcc.util import pack_2e, einsum, direct_sum, Namespace

def energy(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    # energy
    x0 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x0 += np.einsum("ia,jb->iajb", t1, t1)
    x1 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x1 += np.einsum("ijab->iajb", t2)
    x1 += np.einsum("iajb->iajb", x0)
    del x0
    x2 = 0
    x2 += np.einsum("ia,ia->", f.ov, t1)
    e_cc = 0
    e_cc += np.einsum("->", x2) * 2.0
    del x2
    x3 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x3 += np.einsum("iajb->iajb", x1) * 2.0
    x3 += np.einsum("ibja->iajb", x1) * -1.0
    del x1
    x4 = 0
    x4 += np.einsum("iajb,iajb->", v.ovov, x3)
    del x3
    e_cc += np.einsum("->", x4)
    del x4

    return e_cc

def update_amps(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    # T amplitudes
    t1new = np.zeros((nocc, nvir), dtype=np.float64)
    t1new += np.einsum("ia->ia", f.ov)
    t2new = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    t2new += np.einsum("iajb->ijab", v.ovov)
    x0 = np.zeros((nocc, nocc), dtype=np.float64)
    x0 += np.einsum("jb,ib->ji", f.ov, t1)
    x1 = np.zeros((nocc, nocc), dtype=np.float64)
    x1 += np.einsum("ij->ji", f.oo)
    x1 += np.einsum("ji->ji", x0)
    del x0
    x2 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x2 += np.einsum("ijbc->ijcb", t2) * -1.0
    x2 += np.einsum("ijcb->ijcb", t2) * 2.0
    x3 = np.zeros((nvir, nocc), dtype=np.float64)
    x3 += np.einsum("jbac,ijcb->ai", v.ovvv, x2)
    t1new += np.einsum("ai->ia", x3)
    del x3
    x4 = np.zeros((nvir, nvir), dtype=np.float64)
    x4 += np.einsum("kldb,kdlc->bc", t2, v.ovov)
    x5 = np.zeros((nvir, nocc), dtype=np.float64)
    x5 += np.einsum("jb,jckb->ck", t1, v.ovov)
    x6 = np.zeros((nocc, nocc), dtype=np.float64)
    x6 += np.einsum("ib,bk->ik", t1, x5)
    x7 = np.zeros((nvir, nvir), dtype=np.float64)
    x7 += np.einsum("jc,jcab->ab", t1, v.ovvv)
    x8 = np.zeros((nocc, nocc), dtype=np.float64)
    x8 += np.einsum("ikbc,jckb->ij", t2, v.ovov)
    x9 = np.zeros((nvir, nvir), dtype=np.float64)
    x9 += np.einsum("klbd,kdlc->bc", t2, v.ovov)
    x10 = np.zeros((nvir, nvir), dtype=np.float64)
    x10 += np.einsum("jc,jbac->ba", t1, v.ovvv)
    x11 = np.zeros((nvir, nvir), dtype=np.float64)
    x11 += np.einsum("ba->ba", x10)
    x11 += np.einsum("ab->ba", x7) * -2.0
    x12 = np.zeros((nocc, nvir), dtype=np.float64)
    x12 += np.einsum("jb,jbkc->kc", t1, v.ovov)
    x13 = np.zeros((nocc, nvir), dtype=np.float64)
    x13 += np.einsum("kc->kc", x12) * 2.0
    x13 += np.einsum("ck->kc", x5) * -1.0
    del x5
    x14 = np.zeros((nvir, nvir), dtype=np.float64)
    x14 += np.einsum("klbd,kcld->bc", t2, v.ovov)
    x15 = np.zeros((nvir, nvir), dtype=np.float64)
    x15 += np.einsum("ab->ab", x4) * -1.0
    x15 += np.einsum("ab->ab", x9)
    x16 = np.zeros((nocc, nvir), dtype=np.float64)
    x16 += np.einsum("kc->kc", f.ov)
    x16 += np.einsum("kc->kc", x13)
    x17 = np.zeros((nocc, nvir), dtype=np.float64)
    x17 += np.einsum("kc,ikac->ia", x16, x2)
    del x16
    t1new += np.einsum("ia->ia", x17)
    del x17
    x18 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x18 += np.einsum("jkab->jkab", t2)
    x18 += np.einsum("jkba->jkab", t2) * -1.0
    x19 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x19 += np.einsum("ijab->ijab", v.oovv)
    x19 += np.einsum("iajb->ijab", v.ovov) * -2.0
    x20 = np.zeros((nocc, nvir), dtype=np.float64)
    x20 += np.einsum("jb,ijab->ia", t1, x19)
    t1new += np.einsum("ia->ia", x20) * -1.0
    del x20
    x21 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x21 += np.einsum("jkab->jkab", t2) * 3.0
    x21 += np.einsum("jkba->jkab", t2) * -1.0
    x22 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x22 += np.einsum("kjab->jkab", x18) * -1.0
    x22 += np.einsum("jkab->jkab", x21)
    del x21
    x23 = np.zeros((nvir, nvir), dtype=np.float64)
    x23 += np.einsum("kldb,kcld->bc", t2, v.ovov)
    x24 = np.zeros((nvir, nvir), dtype=np.float64)
    x24 += np.einsum("ab->ab", x14) * 3.0
    x24 += np.einsum("ab->ab", x23) * -1.0
    x25 = np.zeros((nvir, nvir), dtype=np.float64)
    x25 += np.einsum("ab->ab", x15) * -1.0
    x25 += np.einsum("ab->ab", x24)
    del x24
    x26 = np.zeros((nvir, nvir), dtype=np.float64)
    x26 += np.einsum("ba->ba", x11) * 2.0
    x26 += np.einsum("ab->ba", x25)
    del x25
    x27 = np.zeros((nocc, nocc), dtype=np.float64)
    x27 += np.einsum("ikbc,jbkc->ij", t2, v.ovov)
    x28 = np.zeros((nocc, nocc), dtype=np.float64)
    x28 += np.einsum("ib,kb->ik", t1, x12)
    del x12
    x29 = np.zeros((nocc, nocc), dtype=np.float64)
    x29 += np.einsum("ik->ik", x28) * -2.0
    del x28
    x29 += np.einsum("ik->ik", x6)
    del x6
    x30 = np.zeros((nocc, nocc), dtype=np.float64)
    x30 += np.einsum("ij->ij", x27) * 2.0
    x30 += np.einsum("ij->ij", x8) * -1.0
    x31 = np.zeros((nocc, nocc), dtype=np.float64)
    x31 += np.einsum("ij->ij", x29)
    x31 += np.einsum("ij->ij", x30) * -1.0
    del x30
    x32 = np.zeros((nocc, nvir), dtype=np.float64)
    x32 += np.einsum("ijkb,jkab->ia", v.ooov, x22)
    del x22
    t1new += np.einsum("ia->ia", x32) * -0.5
    del x32
    x33 = np.zeros((nocc, nocc), dtype=np.float64)
    x33 += np.einsum("jb,ijkb->ik", t1, v.ooov)
    x34 = np.zeros((nocc, nocc), dtype=np.float64)
    x34 += np.einsum("jb,ikjb->ik", t1, v.ooov)
    x35 = np.zeros((nocc, nocc), dtype=np.float64)
    x35 += np.einsum("ik->ik", x33)
    del x33
    x35 += np.einsum("ik->ik", x34) * -2.0
    del x34
    x36 = np.zeros((nocc, nocc), dtype=np.float64)
    x36 += np.einsum("ki->ik", x1) * -1.0
    x36 += np.einsum("ik->ik", x35)
    x37 = np.zeros((nocc, nocc), dtype=np.float64)
    x37 += np.einsum("ij->ij", x31)
    del x31
    x37 += np.einsum("ij->ij", x36)
    x38 = np.zeros((nvir, nocc), dtype=np.float64)
    x38 += np.einsum("ja,ij->ai", t1, x37)
    del x37
    t1new += np.einsum("ai->ia", x38)
    del x38
    x39 = np.zeros((nvir, nvir), dtype=np.float64)
    x39 += np.einsum("ab->ba", f.vv) * -2.0
    x39 += np.einsum("ba->ba", x26)
    del x26
    x40 = np.zeros((nocc, nvir), dtype=np.float64)
    x40 += np.einsum("ib,ba->ia", t1, x39)
    del x39
    t1new += np.einsum("ia->ia", x40) * -0.5
    del x40
    x41 = np.zeros((nocc, nocc), dtype=np.float64)
    x41 += np.einsum("jk->jk", x27)
    del x27
    x41 += np.einsum("jk->jk", x8) * -1.0
    del x8
    x42 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x42 += np.einsum("ijcd,kcld->ijkl", t2, v.ovov)
    x43 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x43 += np.einsum("ic,jd->icjd", t1, t1)
    x44 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x44 += np.einsum("ijcd->icjd", t2)
    x44 += np.einsum("icjd->icjd", x43)
    del x43
    x45 = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    x45 += np.einsum("acbd,icjd->abij", v.vvvv, x44)
    del x44
    t2new += np.einsum("abij->ijab", x45)
    del x45
    x46 = np.zeros((nvir, nvir), dtype=np.float64)
    x46 += np.einsum("bc->bc", x4) * -3.0
    del x4
    x46 += np.einsum("bc->bc", x9)
    del x9
    x47 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x47 += np.einsum("ib,jckb->ijck", t1, v.ovov)
    x48 = np.zeros((nvir, nocc, nvir, nocc), dtype=np.float64)
    x48 += np.einsum("lb,ilck->bick", t1, x47)
    x49 = np.zeros((nvir, nocc, nvir, nocc), dtype=np.float64)
    x49 += np.einsum("ikbc->bick", v.oovv) * -1.0
    x49 += np.einsum("bick->bick", x48)
    del x48
    x50 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x50 += np.einsum("ijcd,kdac->ijka", t2, v.ovvv)
    x51 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x51 += np.einsum("ikac,jbkc->iajb", t2, v.ovov)
    t2new += np.einsum("jbia->ijab", x51)
    x52 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x52 += np.einsum("ic,jbkc->ijbk", t1, x51)
    x53 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x53 += np.einsum("ikca,jbkc->iajb", t2, v.ovov)
    t2new += np.einsum("iajb->ijab", x53) * -1.0
    t2new += np.einsum("jbia->ijab", x53) * -1.0
    x54 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x54 += np.einsum("jbkc->jbkc", x51)
    del x51
    x54 += np.einsum("jbkc->jbkc", x53) * -1.0
    x55 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x55 += np.einsum("kjcb,iakc->jbia", t2, v.ovov)
    t2new += np.einsum("jbia->ijab", x55)
    x56 = np.zeros((nvir, nvir), dtype=np.float64)
    x56 += np.einsum("ac->ac", x15)
    del x15
    x56 += np.einsum("ac->ac", x23)
    x57 = np.zeros((nvir, nvir), dtype=np.float64)
    x57 += np.einsum("lb,lc->bc", t1, x13)
    del x13
    x58 = np.zeros((nvir, nvir), dtype=np.float64)
    x58 += np.einsum("bc->bc", f.vv) * -1.0
    x58 += np.einsum("bc->bc", x57)
    x59 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x59 += np.einsum("ijcd,kcbd->ijkb", t2, v.ovvv)
    x60 = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    x60 += np.einsum("ikcb,kdlc->ibdl", t2, v.ovov)
    x61 = np.zeros((nocc, nocc), dtype=np.float64)
    x61 += np.einsum("ikcd,kdlc->il", t2, v.ovov)
    x62 = np.zeros((nocc, nocc), dtype=np.float64)
    x62 += np.einsum("il->il", x29)
    x62 += np.einsum("il->il", x61) * -2.0
    del x61
    x63 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x63 += np.einsum("ilcb,jlkc->ibjk", t2, v.ooov)
    x64 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x64 += np.einsum("ljdb,ikdl->jbik", t2, x47)
    x65 = np.zeros((nocc, nocc), dtype=np.float64)
    x65 += np.einsum("jl->jl", x29)
    del x29
    x65 += np.einsum("jl->jl", x35)
    del x35
    x66 = np.zeros((nvir, nvir), dtype=np.float64)
    x66 += np.einsum("ad->ad", x56)
    del x56
    x66 += np.einsum("ad->ad", x7) * 4.0
    del x7
    x67 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x67 += np.einsum("ic,jbac->ijba", t1, v.ovvv)
    t2new += np.einsum("ijba->ijab", x67)
    t2new += np.einsum("jiab->ijab", x67)
    x68 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x68 += np.einsum("ic,jkcb->ijkb", t1, x67)
    x69 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x69 += np.einsum("jkdb,ikda->jbia", t2, x67)
    t2new += np.einsum("iajb->ijab", x69) * -1.0
    t2new += np.einsum("jbia->ijab", x69) * -1.0
    del x69
    x70 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x70 += np.einsum("jlbc,iklc->jbik", t2, v.ooov)
    x71 = np.zeros((nocc, nocc), dtype=np.float64)
    x71 += np.einsum("ljcd,kdlc->jk", t2, v.ovov)
    x72 = np.zeros((nocc, nocc), dtype=np.float64)
    x72 += np.einsum("jk->jk", x41)
    del x41
    x72 += np.einsum("jk->jk", x71)
    del x71
    x73 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x73 += np.einsum("ic,jbkc->ijbk", t1, x53)
    del x53
    x74 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x74 += np.einsum("jiak->jiak", x52) * 2.0
    x74 += np.einsum("jiak->jiak", x73) * -1.0
    x75 = np.zeros((nvir, nvir), dtype=np.float64)
    x75 += np.einsum("db->db", x11) * 2.0
    del x11
    x75 += np.einsum("bd->db", x46) * -1.0
    del x46
    x76 = np.zeros((nvir, nvir), dtype=np.float64)
    x76 += np.einsum("bd->db", x58) * 2.0
    del x58
    x76 += np.einsum("db->db", x75)
    del x75
    x77 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x77 += np.einsum("jbkc->jbkc", x54)
    del x54
    x77 += np.einsum("jbkc->jbkc", x55)
    x78 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x78 += np.einsum("ikac,jbkc->iajb", x2, x77)
    del x2, x77
    t2new += np.einsum("iajb->ijab", x78)
    del x78
    x79 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x79 += np.einsum("jkbd,ikda->jbia", t2, x67)
    t2new += np.einsum("iajb->ijab", x79) * 2.0
    t2new += np.einsum("jbia->ijab", x79)
    del x79
    x80 = np.zeros((nvir, nvir), dtype=np.float64)
    x80 += np.einsum("ad->da", f.vv) * -1.0
    x80 += np.einsum("da->da", x10)
    del x10
    x81 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x81 += np.einsum("ic,jbkc->ijbk", t1, x55)
    del x55
    x82 = np.zeros((nocc, nocc), dtype=np.float64)
    x82 += np.einsum("jk->jk", x65) * -1.0
    del x65
    x82 += np.einsum("jk->jk", x72)
    del x72
    x83 = np.zeros((nocc, nocc), dtype=np.float64)
    x83 += np.einsum("kj->kj", x1)
    del x1
    x83 += np.einsum("jk->kj", x82)
    del x82
    x84 = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    x84 += np.einsum("kj,ikab->iabj", x83, t2)
    del x83
    t2new += np.einsum("iabj->ijab", x84) * -1.0
    del x84
    x85 = np.zeros((nvir, nvir), dtype=np.float64)
    x85 += np.einsum("bc->bc", x14)
    x85 += np.einsum("bc->bc", x23) * -1.0
    del x23
    x86 = np.zeros((nvir, nvir), dtype=np.float64)
    x86 += np.einsum("cb->bc", x76)
    del x76
    x86 += np.einsum("bc->bc", x85)
    del x85
    x87 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x87 += np.einsum("bc,ijac->ijab", x86, t2)
    del x86
    t2new += np.einsum("ijab->ijab", x87) * -0.5
    del x87
    x88 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x88 += np.einsum("ic,jkac->ijka", t1, v.oovv)
    x89 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x89 += np.einsum("kc,ijcb->kijb", f.ov, t2)
    x90 = np.zeros((nvir, nocc, nocc, nocc), dtype=np.float64)
    x90 += np.einsum("la,ijlk->aijk", t1, x42)
    x91 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x91 += np.einsum("jbik->ijbk", x64) * -1.0
    del x64
    x91 += np.einsum("ijbk->ijbk", x81)
    del x81
    x92 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x92 += np.einsum("ic,kcbd->ikbd", t1, v.ovvv)
    x93 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x93 += np.einsum("jkad->jkad", v.oovv)
    x93 += np.einsum("jkad->jkad", x92)
    x94 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x94 += np.einsum("ibdl->ilbd", x60) * -1.0
    del x60
    x94 += np.einsum("ilbd->ilbd", x92)
    x95 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x95 += np.einsum("ikda->ikda", x67)
    del x67
    x95 += np.einsum("ikad->ikda", x94) * -1.0
    x96 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x96 += np.einsum("ikad->ikda", v.oovv) * -1.0
    x96 += np.einsum("ikda->ikda", x95)
    del x95
    x97 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x97 += np.einsum("kjdb,ikda->jbia", t2, x96)
    del x96
    t2new += np.einsum("jbia->ijab", x97)
    del x97
    x98 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x98 += np.einsum("bidl->ilbd", x49) * -1.0
    del x49
    x98 += np.einsum("ilbd->ilbd", x94)
    del x94
    x99 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x99 += np.einsum("ljad,ilbd->jaib", t2, x98)
    del x98
    t2new += np.einsum("jaib->ijab", x99) * -1.0
    del x99
    x100 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x100 += np.einsum("ikdb,jkad->ibja", t2, x93)
    del x93
    t2new += np.einsum("ibja->ijab", x100) * -1.0
    del x100
    x101 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x101 += np.einsum("ic,jkcl->ijkl", t1, x47)
    x102 = np.zeros((nvir, nocc, nocc, nocc), dtype=np.float64)
    x102 += np.einsum("lb,ijkl->bijk", t1, x101)
    x103 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x103 += np.einsum("bijk->ijkb", x102) * -1.0
    del x102
    x103 += np.einsum("ijkb->ijkb", x68)
    x104 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x104 += np.einsum("ilad,jkdl->iajk", t2, x47)
    x105 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x105 += np.einsum("iajk->iajk", x104)
    del x104
    x105 += np.einsum("aijk->iajk", x90)
    del x90
    x106 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x106 += np.einsum("iajk->jiak", x105) * -1.0
    del x105
    x106 += np.einsum("jiak->jiak", x74)
    del x74
    x107 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x107 += np.einsum("kc,ijac->kija", f.ov, t2)
    x108 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x108 += np.einsum("kija->ijka", x107)
    del x107
    x108 += np.einsum("ijka->ijka", x88)
    x109 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x109 += np.einsum("ilac,jlkc->iajk", t2, v.ooov)
    x110 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x110 += np.einsum("ljdb->jlbd", t2)
    x110 += np.einsum("jlbd->jlbd", x18)
    del x18
    x111 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x111 += np.einsum("kdlc,jlbd->kcjb", v.ovov, x110)
    del x110
    x112 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x112 += np.einsum("kcjb->jkbc", x111)
    del x111
    x112 += np.einsum("jkbc->jkbc", x92)
    del x92
    x113 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x113 += np.einsum("jkbc->jkbc", x112)
    del x112
    x113 += np.einsum("jkbc->jkbc", x19)
    del x19
    x114 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x114 += np.einsum("ikac,jkbc->iajb", t2, x113)
    del x113
    t2new += np.einsum("iajb->ijab", x114) * -1.0
    del x114
    x115 = np.zeros((nocc, nocc), dtype=np.float64)
    x115 += np.einsum("ikcd,kcld->il", t2, v.ovov)
    x116 = np.zeros((nocc, nocc), dtype=np.float64)
    x116 += np.einsum("il->il", x115)
    del x115
    x116 += np.einsum("il->il", x62)
    del x62
    x117 = np.zeros((nocc, nocc), dtype=np.float64)
    x117 += np.einsum("il->il", x116)
    del x116
    x117 += np.einsum("il->il", x36)
    del x36
    x118 = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    x118 += np.einsum("il,ljab->jabi", x117, t2)
    del x117
    t2new += np.einsum("jabi->ijab", x118)
    del x118
    x119 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x119 += np.einsum("ijka->jiak", x108)
    del x108
    x119 += np.einsum("jiak->jiak", x47)
    x120 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x120 += np.einsum("jkia->jiak", v.ooov)
    x120 += np.einsum("jiak->jiak", x119)
    del x119
    x121 = np.zeros((nvir, nvir), dtype=np.float64)
    x121 += np.einsum("ad->da", x57)
    del x57
    x121 += np.einsum("da->da", x80)
    del x80
    x122 = np.zeros((nvir, nvir), dtype=np.float64)
    x122 += np.einsum("da->ad", x121) * -2.0
    del x121
    x122 += np.einsum("ad->ad", x66)
    del x66
    x123 = np.zeros((nvir, nvir), dtype=np.float64)
    x123 += np.einsum("ac->ac", x122) * -1.0
    del x122
    x123 += np.einsum("ac->ac", x14) * 3.0
    del x14
    x124 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x124 += np.einsum("ac,ijcb->ijba", x123, t2)
    del x123
    t2new += np.einsum("ijba->ijab", x124) * -0.5
    del x124
    x125 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x125 += np.einsum("jlcb,iklc->jbik", t2, v.ooov)
    x126 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x126 += np.einsum("iajk->iajk", x125) * -1.0
    x126 += np.einsum("iajk->iajk", x70) * 2.0
    x127 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x127 += np.einsum("ildb,jkdl->ibjk", t2, x47)
    x128 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x128 += np.einsum("ibjk->ijbk", x127) * -1.0
    del x127
    x128 += np.einsum("ijbk->ijbk", x91)
    del x91
    x129 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x129 += np.einsum("ijbk->ijbk", x128)
    del x128
    x129 += np.einsum("ijbk->ijbk", x52)
    del x52
    x130 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x130 += np.einsum("ijbk->ijbk", x129)
    del x129
    x130 += np.einsum("ijbk->ijbk", x73) * -1.0
    del x73
    x131 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x131 += np.einsum("ijbk->ijbk", x130)
    del x130
    x131 += np.einsum("ijkb->ijbk", x59)
    del x59
    x132 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x132 += np.einsum("jikb->jikb", x88)
    del x88
    x132 += np.einsum("kijb->jikb", x89)
    del x89
    x133 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x133 += np.einsum("jikb->ijbk", x132)
    del x132
    x133 += np.einsum("ijbk->ijbk", x47)
    del x47
    x134 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x134 += np.einsum("ic,jlkc->ijlk", t1, v.ooov)
    x135 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x135 += np.einsum("ijlk->ijlk", x134)
    x135 += np.einsum("jikl->ijlk", x134)
    del x134
    x136 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x136 += np.einsum("ikjl->ijlk", v.oooo)
    x136 += np.einsum("ijlk->ijlk", x135)
    del x135
    x137 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x137 += np.einsum("ijkl->ijlk", x101)
    del x101
    x137 += np.einsum("ijlk->ijlk", x136)
    x138 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x138 += np.einsum("ijlk->ijkl", x137)
    del x137
    x138 += np.einsum("ijkl->ijkl", x42)
    del x42
    x139 = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    x139 += np.einsum("klab,ijkl->abij", t2, x138)
    del x138
    t2new += np.einsum("abij->ijab", x139)
    del x139
    x140 = np.zeros((nvir, nocc, nocc, nocc), dtype=np.float64)
    x140 += np.einsum("lb,ijlk->bijk", t1, x136)
    del x136
    x141 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x141 += np.einsum("ijbk->ijbk", x133)
    del x133
    x141 += np.einsum("bijk->ijbk", x140) * -1.0
    del x140
    x142 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x142 += np.einsum("ikjb->ijbk", v.ooov)
    x142 += np.einsum("ijbk->ijbk", x141)
    del x141
    x143 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x143 += np.einsum("iklc->iklc", v.ooov)
    x143 += np.einsum("ilkc->iklc", v.ooov) * -1.0
    x144 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x144 += np.einsum("ljcb,iklc->jbik", t2, x143)
    del x143
    x145 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x145 += np.einsum("jbik->ibjk", x144) * -1.0
    del x144
    x145 += np.einsum("ibjk->ibjk", x63)
    del x63
    x146 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x146 += np.einsum("ibjk->jbik", x145) * -1.0
    del x145
    x146 += np.einsum("jbik->jbik", x70)
    del x70
    x147 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x147 += np.einsum("jbik->jbik", x125)
    del x125
    x147 += np.einsum("jbik->jbik", x146) * -1.0
    del x146
    x148 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x148 += np.einsum("ijkb->jbik", x103) * -1.0
    del x103
    x148 += np.einsum("jbik->jbik", x147)
    del x147
    x149 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x149 += np.einsum("ijbk->ijbk", x131)
    del x131
    x149 += np.einsum("jbik->ijbk", x148) * -1.0
    del x148
    x150 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x150 += np.einsum("ijbk->ijbk", x142)
    del x142
    x150 += np.einsum("ijbk->ijbk", x149)
    del x149
    x151 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x151 += np.einsum("ka,ijbk->aijb", t1, x150)
    del x150
    t2new += np.einsum("aijb->ijab", x151) * -1.0
    del x151
    x152 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x152 += np.einsum("ljac,ilkc->jaik", t2, v.ooov)
    x153 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x153 += np.einsum("iajk->iajk", x109)
    del x109
    x153 += np.einsum("jaik->iajk", x152)
    del x152
    x154 = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    x154 += np.einsum("iajk->iajk", x126)
    del x126
    x154 += np.einsum("iajk->iajk", x153) * -1.0
    del x153
    x155 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x155 += np.einsum("jiak->jiak", x106)
    del x106
    x155 += np.einsum("iajk->jiak", x154)
    del x154
    x156 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x156 += np.einsum("jiak->jika", x155)
    del x155
    x156 += np.einsum("jika->jika", x68)
    del x68
    x157 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x157 += np.einsum("jika->jika", x156)
    del x156
    x157 += np.einsum("ijka->jika", x50)
    del x50
    x158 = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    x158 += np.einsum("jiak->jiak", x120)
    del x120
    x158 += np.einsum("jika->jiak", x157)
    del x157
    x159 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x159 += np.einsum("kb,jiak->bjia", t1, x158)
    del x158
    t2new += np.einsum("bjia->ijab", x159) * -1.0
    del x159

    return {"t1new": t1new, "t2new": t2new}

def energy_perturbative(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    # T3 amplitude
    x0 = np.zeros((nocc, nvir, nvir, nocc, nocc, nvir), dtype=np.float64)
    x0 += einsum("ljab,ilkc->jabikc", t2, v.ooov)
    t3 = np.zeros((nocc, nocc, nocc, nvir, nvir, nvir), dtype=np.float64)
    t3 += einsum("jabikc->ijkabc", x0) * -1.0
    t3 += einsum("jabkic->ijkabc", x0)
    t3 += einsum("jcbika->ijkabc", x0)
    t3 += einsum("jcbkia->ijkabc", x0) * -1.0
    del x0
    x1 = np.zeros((nocc, nocc, nvir, nocc, nvir, nvir), dtype=np.float64)
    x1 += einsum("ikad,jbcd->ikajbc", t2, v.ovvv)
    t3 += einsum("ijakcb->ijkabc", x1)
    t3 += einsum("ijckab->ijkabc", x1) * -1.0
    t3 += einsum("ikajbc->ijkabc", x1)
    t3 += einsum("ikcjba->ijkabc", x1) * -1.0
    t3 += einsum("kjaicb->ijkabc", x1) * -1.0
    t3 += einsum("kjciab->ijkabc", x1)
    del x1
    x2 = np.zeros((nocc, nvir, nvir, nocc, nocc, nvir), dtype=np.float64)
    x2 += einsum("ilab,jlkc->iabjkc", t2, v.ooov)
    t3 += einsum("iabjkc->ijkabc", x2) * -1.0
    t3 += einsum("iackjb->ijkabc", x2) * -1.0
    t3 += einsum("icakjb->ijkabc", x2)
    t3 += einsum("icbjka->ijkabc", x2)
    t3 += einsum("kabjic->ijkabc", x2)
    t3 += einsum("kacijb->ijkabc", x2)
    t3 += einsum("kcaijb->ijkabc", x2) * -1.0
    t3 += einsum("kcbjia->ijkabc", x2) * -1.0
    del x2
    x3 = np.zeros((nocc, nocc, nvir, nocc, nvir, nvir), dtype=np.float64)
    x3 += einsum("ikdc,jbad->ikcjba", t2, v.ovvv)
    t3 += einsum("ijbkac->ijkabc", x3) * -1.0
    t3 += einsum("ijbkca->ijkabc", x3)
    t3 += einsum("ikajbc->ijkabc", x3) * -1.0
    t3 += einsum("ikcjba->ijkabc", x3)
    t3 += einsum("kjbiac->ijkabc", x3)
    t3 += einsum("kjbica->ijkabc", x3) * -1.0
    del x3
    e_ia = lib.direct_sum("i-a->ia", np.diag(f.oo), np.diag(f.vv))
    e_ijkabc = lib.direct_sum("ia+jb+kc->ijkabc", e_ia, e_ia, e_ia)
    t3 /= e_ijkabc
    del e_ijkabc

    # energy
    x0 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x0 += einsum("kcad,ijkdbc->aijb", v.ovvv, t3)
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += einsum("abij,jklbac->iklc", l2, t3)
    x2 = np.zeros((nocc, nvir), dtype=np.float64)
    x2 += einsum("jbkc,ijkbac->ia", v.ovov, t3)
    x3 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x3 += einsum("jbkc->jbkc", v.ovov)
    x3 += einsum("jckb->jbkc", v.ovov) * -1.0
    x4 = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    x4 += einsum("abij->abij", l2)
    x4 += einsum("baij->abij", l2) * -1.0
    x5 = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    x5 += einsum("jbkc->jckb", v.ovov) * -2.0
    x5 += einsum("jckb->jckb", x3)
    del x3
    x6 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x6 += einsum("kcbd,ikjacd->bija", v.ovvv, t3)
    x7 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x7 += einsum("abij,jklacb->iklc", l2, t3)
    x8 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x8 += einsum("iklc->ilkc", x1) * -1.0
    x8 += einsum("ilkc->ilkc", x7)
    x9 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x9 += einsum("abij,iklacb->jklc", l2, t3)
    x10 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x10 += einsum("jklc->jklc", v.ooov)
    x10 += einsum("jlkc->jklc", v.ooov) * -1.0
    x11 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x11 += einsum("abij,jklabc->iklc", l2, t3)
    x12 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x12 += einsum("iklc->iklc", x11)
    x12 += einsum("iklc->iklc", x7) * -1.0
    del x7
    x13 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x13 += einsum("kcbd,ijkacd->bija", v.ovvv, t3)
    x14 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x14 += einsum("bija->bija", x13)
    x14 += einsum("bija->bija", x6) * -1.0
    x15 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x15 += einsum("kcad,jikbdc->ajib", v.ovvv, t3)
    x16 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x16 += einsum("abij,iklabc->jklc", l2, t3)
    x17 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x17 += einsum("jklc->jklc", x16)
    x17 += einsum("jlkc->jklc", x9)
    x18 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x18 += einsum("kcad,ijkcbd->aijb", v.ovvv, t3)
    x19 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x19 += einsum("aijb->aijb", x0) * -1.0
    del x0
    x19 += einsum("aijb->aijb", x18)
    del x18
    x20 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x20 += einsum("bjia->bjia", x19)
    x20 += einsum("bjia->bjia", x6)
    del x6
    x21 = np.zeros((nocc, nocc, nocc, nvir, nvir, nvir), dtype=np.float64)
    x21 += einsum("iklbac->iklbac", t3)
    x21 += einsum("kilbac->iklbac", t3) * -1.0
    x22 = np.zeros((nocc, nocc, nocc, nvir, nvir, nvir), dtype=np.float64)
    x22 += einsum("jikbac->ijkcab", t3)
    x22 += einsum("ijkcab->ijkcab", x21)
    x23 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x23 += einsum("abij,iklbac->jklc", l2, x21)
    del x21
    x24 = 0
    x24 += einsum("jklc,jklc->", x10, x23)
    del x10, x23
    e_pert = 0
    e_pert += einsum("->", x24) * 0.5
    del x24
    x25 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x25 += einsum("bjia->bjia", x13)
    del x13
    x25 += einsum("bija->bjia", x14) * -1.0
    del x14
    x26 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x26 += einsum("bija->bjia", x15) * 2.0
    x26 += einsum("bjia->bjia", x25)
    del x25
    x27 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x27 += einsum("bjia->bjia", x20) * -1.0
    del x20
    x27 += einsum("bjia->bjia", x26)
    del x26
    x28 = 0
    x28 += einsum("abij,bjia->", l2, x27)
    del x27
    e_pert += einsum("->", x28)
    del x28
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 += einsum("ilkc->ilkc", x1) * -1.0
    del x1
    x29 += einsum("ilkc->ilkc", x11)
    del x11
    x30 = np.zeros((nocc, nvir), dtype=np.float64)
    x30 += einsum("jckb,ijkabc->ia", x5, t3)
    del x5
    x31 = np.zeros((nocc, nvir), dtype=np.float64)
    x31 += einsum("jbkc,ijkcab->ia", v.ovov, x22)
    del x22
    x32 = np.zeros((nocc, nvir), dtype=np.float64)
    x32 += einsum("ia->ia", x30) * 2.0
    del x30
    x32 += einsum("ia->ia", x31) * -1.0
    del x31
    x33 = np.zeros((nocc, nvir), dtype=np.float64)
    x33 += einsum("ia->ia", x2)
    del x2
    x33 += einsum("ia->ia", x32)
    del x32
    x34 = 0
    x34 += einsum("ai,ia->", l1, x33)
    del x33
    e_pert += einsum("->", x34) * -0.5
    del x34
    x35 = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    x35 += einsum("ajib->ajib", x15) * 2.0
    del x15
    x35 += einsum("aijb->ajib", x19) * -1.0
    del x19
    x36 = 0
    x36 += einsum("ajib,abij->", x35, x4)
    del x35, x4
    e_pert += einsum("->", x36) * 0.5
    del x36
    x37 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x37 += einsum("abij,kjlabc->iklc", l2, t3)
    x38 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x38 += einsum("iklc->iklc", x12)
    del x12
    x38 += einsum("iklc->iklc", x37) * -1.0
    x39 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x39 += einsum("ilkc->ilkc", x37)
    del x37
    x39 += einsum("iklc->ilkc", x9)
    del x9
    x40 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x40 += einsum("ilkc->ilkc", x29)
    del x29
    x40 += einsum("iklc->ilkc", x38) * -1.0
    del x38
    x41 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x41 += einsum("ilkc->ilkc", x40) * -1.0
    del x40
    x41 += einsum("ilkc->ilkc", x8) * 3.0
    del x8
    x42 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x42 += einsum("jlkc->jlkc", x16)
    del x16
    x42 += einsum("jlkc->jlkc", x39)
    del x39
    x43 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x43 += einsum("jklc->jklc", x17) * 3.0
    del x17
    x43 += einsum("jlkc->jklc", x42) * -1.0
    del x42
    x44 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x44 += einsum("ilkc->ilkc", x41)
    del x41
    x44 += einsum("iklc->ilkc", x43) * -1.0
    del x43
    x45 = 0
    x45 += einsum("iklc,ilkc->", v.ooov, x44)
    del x44
    e_pert += einsum("->", x45) * 0.5
    del x45

    return e_pert


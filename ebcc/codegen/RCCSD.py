# Code generated by qwick.

import numpy as np
from pyscf import lib
from types import SimpleNamespace
from ebcc.codegen import common

def energy(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    # energy
    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("iajb->jiab", v.ovov) * -0.5
    x0 += lib.einsum("iajb->jiba", v.ovov)
    x1 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("ijab->jiba", t2)
    x1 += lib.einsum("ia,jb->ijab", t1, t1)
    e_cc = 0
    e_cc += lib.einsum("ijab,ijab->", x0, x1) * 2
    del x0
    del x1
    e_cc += lib.einsum("ia,ia->", f.ov, t1) * 2

    return e_cc

def update_amps(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, **kwargs):
    # T1 and T2 amplitudes
    x0 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x0 += lib.einsum("ia,jakb->ikjb", t1, v.ovov)
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += lib.einsum("ijka->ijka", x0) * -1
    x1 += lib.einsum("ijka->ikja", x0) * 2
    x27 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x27 += lib.einsum("ijab,klja->kilb", t2, x0)
    x31 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x31 += lib.einsum("ijka->kija", x27)
    del x27
    x44 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x44 += lib.einsum("ijab,kjla->kilb", t2, x0)
    x49 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x49 -= lib.einsum("ijka->ikja", x44)
    del x44
    x45 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x45 += lib.einsum("ijka->ijka", x0) * 2
    x45 -= lib.einsum("ijka->ikja", x0)
    x46 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x46 += lib.einsum("ijab,kila->kljb", t2, x45)
    del x45
    x49 += lib.einsum("ijka->ijka", x46)
    del x46
    x66 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x66 += lib.einsum("ia,jkla->jilk", t1, x0)
    del x0
    x67 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x67 += lib.einsum("ijkl->lkji", x66)
    x80 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x80 += lib.einsum("ijab,klji->lkab", t2, x66)
    del x66
    x84 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x84 += lib.einsum("ijab->ijab", x80) * 4.000000000000003
    del x80
    x1 += lib.einsum("ijka->jika", v.ooov) * 2
    x1 += lib.einsum("ijka->jkia", v.ooov) * -1
    t1new = np.zeros((nocc, nvir), dtype=np.float64)
    t1new += lib.einsum("ijab,kjia->kb", t2, x1) * -2
    del x1
    x2 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x2 += lib.einsum("iabc->ibac", v.ovvv)
    x2 += lib.einsum("iabc->ibca", v.ovvv) * -0.5
    t1new += lib.einsum("ijab,icab->jc", t2, x2) * 4
    del x2
    x3 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x3 -= lib.einsum("iajb->jiab", v.ovov)
    x3 += lib.einsum("iajb->jiba", v.ovov) * 2
    x4 = np.zeros((nocc, nvir), dtype=np.float64)
    x4 += lib.einsum("ia,ijab->jb", t1, x3)
    x5 = np.zeros((nocc, nvir), dtype=np.float64)
    x5 += lib.einsum("ia->ia", x4)
    del x4
    x40 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x40 += lib.einsum("ijab,ikbc->kjca", t2, x3)
    x41 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x41 += lib.einsum("ijab->jiba", x40)
    del x40
    x64 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x64 += lib.einsum("ijab,ikac->kjcb", t2, x3)
    del x3
    x65 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x65 += lib.einsum("ijab,ikac->kjcb", t2, x64)
    del x64
    x70 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x70 += lib.einsum("ijab->ijab", x65) * 2
    del x65
    x5 += lib.einsum("ia->ia", f.ov)
    x30 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x30 += lib.einsum("ia,jkab->ijkb", x5, t2)
    x31 -= lib.einsum("ijka->ikja", x30)
    del x30
    x33 = np.zeros((nocc, nocc), dtype=np.float64)
    x33 += lib.einsum("ia,ja->ji", t1, x5)
    x34 = np.zeros((nocc, nocc), dtype=np.float64)
    x34 += lib.einsum("ij->ji", x33)
    del x33
    x6 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x6 += lib.einsum("ijab->jiab", t2) * 2
    x6 -= lib.einsum("ijab->jiba", t2)
    t1new += lib.einsum("ia,ijba->jb", x5, x6) * 2
    del x5
    del x6
    x7 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x7 += lib.einsum("iabj->ijba", v.ovvo) * 2
    x7 -= lib.einsum("ijab->ijab", v.oovv)
    t1new += lib.einsum("ia,ijba->jb", t1, x7) * 2
    del x7
    x8 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x8 += lib.einsum("iajb->jiab", v.ovov) * -0.5
    x8 += lib.einsum("iajb->jiba", v.ovov)
    x10 = np.zeros((nocc, nvir), dtype=np.float64)
    x10 += lib.einsum("ia,ijab->jb", t1, x8) * 2
    x11 = np.zeros((nocc, nocc), dtype=np.float64)
    x11 += lib.einsum("ijab,ikab->kj", t2, x8) * 2
    x73 = np.zeros((nvir, nvir), dtype=np.float64)
    x73 += lib.einsum("ijab,ijac->cb", t2, x8)
    x74 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x74 += lib.einsum("ab,ijac->ijbc", x73, t2) * 8
    del x73
    x77 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x77 += lib.einsum("ijab->jiba", x74)
    del x74
    x75 = np.zeros((nocc, nocc), dtype=np.float64)
    x75 += lib.einsum("ijab,ikab->kj", t2, x8)
    del x8
    x76 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x76 += lib.einsum("ij,ikab->jkab", x75, t2) * 8
    del x75
    x77 += lib.einsum("ijab->jiba", x76)
    del x76
    x9 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x9 += lib.einsum("ijka->ikja", v.ooov) * -0.5
    x9 += lib.einsum("ijka->kija", v.ooov)
    x11 += lib.einsum("ia,ijka->jk", t1, x9) * 2
    del x9
    x10 += lib.einsum("ia->ia", f.ov)
    x11 += lib.einsum("ia,ja->ji", t1, x10)
    del x10
    x11 += lib.einsum("ij->ij", f.oo)
    t1new += lib.einsum("ia,ij->ja", t1, x11) * -2
    del x11
    x12 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x12 -= lib.einsum("iabc->ibac", v.ovvv)
    x12 += lib.einsum("iabc->ibca", v.ovvv) * 2
    x13 = np.zeros((nvir, nvir), dtype=np.float64)
    x13 += lib.einsum("ia,ibca->bc", t1, x12)
    del x12
    x14 = np.zeros((nvir, nvir), dtype=np.float64)
    x14 += lib.einsum("ab->ab", x13)
    x51 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x51 += lib.einsum("ab,ijbc->ijac", x13, t2)
    del x13
    x55 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x55 -= lib.einsum("ijab->jiba", x51)
    del x51
    x14 += lib.einsum("ab->ab", f.vv)
    t1new += lib.einsum("ia,ba->ib", t1, x14) * 2
    del x14
    x15 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x15 += lib.einsum("ab,ijcb->ijac", f.vv, t2)
    x36 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x36 -= lib.einsum("ijab->ijab", x15)
    del x15
    x16 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x16 += lib.einsum("ia,bjca->ijbc", t1, v.vovv)
    x36 -= lib.einsum("ijab->ijab", x16)
    del x16
    x17 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x17 += lib.einsum("ijab,jkca->ikbc", t2, v.oovv)
    x36 += lib.einsum("ijab->ijab", x17)
    del x17
    x18 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x18 += lib.einsum("ia,jbca->ijcb", t1, v.ovvv)
    x19 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x19 += lib.einsum("ijab,kjca->kibc", t2, x18)
    x36 += lib.einsum("ijab->ijab", x19)
    del x19
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += lib.einsum("ijab->jiab", x18)
    del x18
    x20 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x20 += lib.einsum("iabc->ibac", v.ovvv) * 2
    x20 -= lib.einsum("iabc->ibca", v.ovvv)
    x21 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x21 += lib.einsum("ia,jbca->jibc", t1, x20)
    del x20
    x22 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x22 += lib.einsum("ijab,ikca->kjcb", t2, x21)
    del x21
    x36 -= lib.einsum("ijab->ijba", x22)
    del x22
    x23 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x23 += lib.einsum("ia,jkba->ijkb", t1, v.oovv)
    x31 -= lib.einsum("ijka->jika", x23)
    del x23
    x24 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x24 += lib.einsum("ijab,klja->iklb", t2, v.ooov)
    x31 += lib.einsum("ijka->jika", x24)
    del x24
    x25 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x25 += lib.einsum("ia,jkla->ijlk", t1, v.ooov)
    x26 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x26 += lib.einsum("ia,jkil->jkla", t1, x25)
    x31 += lib.einsum("ijka->jika", x26)
    del x26
    x56 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x56 += lib.einsum("ijab,kijl->klab", t2, x25)
    del x25
    t2new = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    t2new += lib.einsum("ijab->ijab", x56) * -2
    t2new += lib.einsum("ijab->ijba", x56) * 4
    t2new += lib.einsum("ijab->jiab", x56) * 4
    t2new += lib.einsum("ijab->jiba", x56) * -2
    del x56
    x28 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x28 += lib.einsum("ijka->ikja", v.ooov) * 2
    x28 -= lib.einsum("ijka->kija", v.ooov)
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 += lib.einsum("ijab,kila->kljb", t2, x28)
    del x28
    x31 -= lib.einsum("ijka->ikja", x29)
    del x29
    x32 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x32 += lib.einsum("ia,ijkb->jkba", t1, x31)
    del x31
    x36 -= lib.einsum("ijab->ijba", x32)
    del x32
    x34 += lib.einsum("ij->ji", f.oo)
    x35 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x35 += lib.einsum("ij,jkab->ikab", x34, t2)
    del x34
    x36 += lib.einsum("ijab->ijba", x35)
    del x35
    t2new += lib.einsum("ijab->ijab", x36) * 2
    t2new -= lib.einsum("ijab->ijba", x36) * 4
    t2new -= lib.einsum("ijab->jiab", x36) * 4
    t2new += lib.einsum("ijab->jiba", x36) * 2
    del x36
    x37 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x37 += lib.einsum("ijab,jack->ikbc", t2, v.ovvo)
    x55 += lib.einsum("ijab->ijab", x37)
    del x37
    x38 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x38 += lib.einsum("ia,jabc->ijbc", t1, v.ovvv)
    x39 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x39 += lib.einsum("ijab,kjca->kibc", t2, x38)
    del x38
    x55 += lib.einsum("ijab->ijab", x39)
    del x39
    x41 += lib.einsum("ijab->jiab", v.oovv)
    x41 -= lib.einsum("iabj->jiba", v.ovvo) * 2
    x42 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x42 += lib.einsum("ijab,kica->kjcb", t2, x41)
    del x41
    x55 += lib.einsum("ijab->jiba", x42)
    del x42
    x43 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x43 += lib.einsum("ijab,jkla->ilkb", t2, v.ooov)
    x49 -= lib.einsum("ijka->ijka", x43)
    del x43
    x47 += lib.einsum("iabj->ijba", v.ovvo)
    x48 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x48 += lib.einsum("ia,jkba->jkib", t1, x47)
    del x47
    x49 += lib.einsum("ijka->kija", x48)
    del x48
    x49 += lib.einsum("ijak->jika", v.oovo)
    x50 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x50 += lib.einsum("ia,jikb->jkba", t1, x49)
    del x49
    x55 += lib.einsum("ijab->ijba", x50)
    del x50
    x52 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x52 -= lib.einsum("ijka->ikja", v.ooov)
    x52 += lib.einsum("ijka->kija", v.ooov) * 2
    x53 = np.zeros((nocc, nocc), dtype=np.float64)
    x53 += lib.einsum("ia,ijka->jk", t1, x52)
    del x52
    x54 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x54 += lib.einsum("ij,ikab->jkab", x53, t2)
    del x53
    x55 += lib.einsum("ijab->jiba", x54)
    del x54
    t2new -= lib.einsum("ijab->ijab", x55) * 4
    t2new += lib.einsum("ijab->ijba", x55) * 2
    t2new += lib.einsum("ijab->jiab", x55) * 2
    t2new -= lib.einsum("ijab->jiba", x55) * 4
    del x55
    x57 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x57 += lib.einsum("ijab,ikjl->klab", t2, v.oooo)
    x59 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x59 += lib.einsum("ijab->jiba", x57) * 2
    del x57
    x58 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x58 += lib.einsum("ijab,cadb->ijcd", t2, v.vvvv)
    x59 += lib.einsum("ijab->jiba", x58) * 2
    del x58
    t2new += lib.einsum("ijab->ijba", x59) * -1
    t2new += lib.einsum("ijab->ijab", x59) * 2
    del x59
    x60 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x60 += lib.einsum("ia,bacd->icbd", t1, v.vvvv)
    x61 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x61 += lib.einsum("ia,jbca->ijbc", t1, x60)
    del x60
    x70 += lib.einsum("ijab->ijab", x61)
    del x61
    x62 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x62 += lib.einsum("ijab,jakc->ikbc", t2, v.ovov)
    x63 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x63 += lib.einsum("ijab,kjca->ikbc", t2, x62)
    del x62
    x70 += lib.einsum("ijab->ijab", x63)
    del x63
    x67 += lib.einsum("ijkl->kilj", v.oooo)
    x68 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x68 += lib.einsum("ia,ijkl->jkla", t1, x67)
    del x67
    x69 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x69 += lib.einsum("ia,ijkb->kjba", t1, x68)
    del x68
    x70 += lib.einsum("ijab->ijba", x69)
    del x69
    t2new += lib.einsum("ijab->ijab", x70) * 4
    t2new -= lib.einsum("ijab->ijba", x70) * 2
    del x70
    x71 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x71 += lib.einsum("ijab,kacb->ijkc", t2, v.ovvv)
    x72 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x72 += lib.einsum("ia,jkib->jkab", t1, x71)
    del x71
    x77 += lib.einsum("ijab->ijab", x72) * 4
    del x72
    t2new += lib.einsum("ijab->ijab", x77) * -1
    t2new += lib.einsum("ijab->ijba", x77) * 0.5
    t2new += lib.einsum("ijab->jiab", x77) * 0.5
    t2new += lib.einsum("ijab->jiba", x77) * -1
    del x77
    x78 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x78 += lib.einsum("ijab,jcka->ikbc", t2, v.ovov)
    x79 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x79 += lib.einsum("ijab,kjca->ikbc", t2, x78)
    del x78
    t2new -= lib.einsum("ijab->ijab", x79) * 2
    t2new += lib.einsum("ijab->ijba", x79) * 4
    del x79
    x81 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x81 += lib.einsum("ijab,kalb->ijkl", t2, v.ovov)
    x82 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x82 += lib.einsum("ijab->jiba", t2)
    x82 += lib.einsum("ia,jb->ijab", t1, t1)
    x83 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x83 += lib.einsum("ijkl,klab->ijab", x81, x82) * 4
    del x81
    del x82
    x84 += lib.einsum("ijab->jiba", x83)
    del x83
    t2new += lib.einsum("ijab->ijab", x84)
    t2new += lib.einsum("ijab->ijba", x84) * -0.5
    del x84
    t1new += lib.einsum("ai->ia", f.vo) * 2
    t2new -= lib.einsum("aibj->jiab", v.vovo) * 2
    t2new += lib.einsum("aibj->jiba", v.vovo) * 4

    return {"t1new": t1new, "t2new": t2new}

def update_lams(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    # L1 and L2 amplitudes
    x0 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x0 += lib.einsum("ia,jkab->ikjb", f.ov, t2)
    x18 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x18 += lib.einsum("ijka->jika", x0) * 0.5
    x18 += lib.einsum("ijka->kija", x0) * -1
    del x0
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += lib.einsum("ijab,kacb->ijkc", t2, v.ovvv)
    x9 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x9 += lib.einsum("ijka->ijka", x1) * -1
    del x1
    x2 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x2 += lib.einsum("ia,jabc->ijbc", t1, v.ovvv)
    x3 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x3 += lib.einsum("ia,jkba->jikb", t1, x2)
    x9 += lib.einsum("ijka->ijka", x3) * -1
    del x3
    x110 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x110 += lib.einsum("ijab->ijab", x2)
    del x2
    x4 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x4 += lib.einsum("ijab,kbla->ijlk", t2, v.ovov)
    x7 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x7 += lib.einsum("ijkl->jilk", x4)
    x121 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x121 += lib.einsum("ijkl->jilk", x4)
    del x4
    x5 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x5 += lib.einsum("ia,jakb->ikjb", t1, v.ovov)
    x6 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x6 += lib.einsum("ia,jkla->ijkl", t1, x5)
    x7 += lib.einsum("ijkl->ijkl", x6)
    x8 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x8 += lib.einsum("ia,jkil->jkla", t1, x7)
    del x7
    x9 += lib.einsum("ijka->jika", x8)
    del x8
    x18 += lib.einsum("ijka->ikja", x9)
    x18 += lib.einsum("ijka->jkia", x9) * -0.5
    del x9
    x121 += lib.einsum("ijkl->ijkl", x6)
    del x6
    x122 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x122 += lib.einsum("abij,ijkl->klab", l2, x121) * 4
    del x121
    x125 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x125 += lib.einsum("ijab->ijab", x122)
    del x122
    x13 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x13 += lib.einsum("ijka->ijka", x5) * 2
    x13 += lib.einsum("ijka->ikja", x5) * -1
    x22 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x22 -= lib.einsum("ijka->ijka", x5)
    x22 += lib.einsum("ijka->ikja", x5) * 2
    x23 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x23 += lib.einsum("ijka->ijka", x5) * 2
    x23 -= lib.einsum("ijka->ikja", x5)
    x51 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x51 += lib.einsum("ijka->jkia", x5) * -0.5
    x51 += lib.einsum("ijka->kjia", x5)
    x104 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x104 += lib.einsum("ai,ijkb->jkab", l1, x5)
    x115 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x115 += lib.einsum("ijab->ijab", x104)
    del x104
    x10 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x10 += lib.einsum("iajb->jiab", v.ovov)
    x10 += lib.einsum("iajb->jiba", v.ovov) * -0.5
    x11 = np.zeros((nocc, nvir), dtype=np.float64)
    x11 += lib.einsum("ia,ijba->jb", t1, x10)
    x12 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x12 += lib.einsum("ia,jkab->jkib", x11, t2)
    del x11
    x18 += lib.einsum("ijka->jkia", x12)
    x18 += lib.einsum("ijka->ikja", x12) * -2
    del x12
    x52 = np.zeros((nocc, nvir), dtype=np.float64)
    x52 += lib.einsum("ia,ijba->jb", t1, x10) * 2
    del x10
    x53 = np.zeros((nocc, nvir), dtype=np.float64)
    x53 += lib.einsum("ia->ia", x52)
    del x52
    x13 += lib.einsum("ijka->jika", v.ooov) * -1
    x13 += lib.einsum("ijka->jkia", v.ooov) * 2
    x14 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x14 += lib.einsum("ijab->jiab", t2)
    x14 += lib.einsum("ijab->jiba", t2) * -0.5
    x18 += lib.einsum("ijka,jlba->iklb", x13, x14) * -1
    del x13
    x68 = np.zeros((nvir, nvir), dtype=np.float64)
    x68 += lib.einsum("abij,ijca->bc", l2, x14) * 2
    x116 = np.zeros((nvir, nvir), dtype=np.float64)
    x116 += lib.einsum("iajb,ijca->bc", v.ovov, x14)
    x117 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x117 += lib.einsum("ab,bcij->ijca", x116, l2) * 8
    del x116
    x120 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x120 += lib.einsum("ijab->jiab", x117)
    del x117
    x118 = np.zeros((nocc, nocc), dtype=np.float64)
    x118 += lib.einsum("iajb,ikba->jk", v.ovov, x14)
    x119 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x119 += lib.einsum("ij,abjk->kiab", x118, l2) * 8
    del x118
    x120 += lib.einsum("ijab->ijba", x119)
    del x119
    l2new = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    l2new += lib.einsum("ijab->abij", x120) * -1
    l2new += lib.einsum("ijab->baij", x120) * 0.5
    l2new += lib.einsum("ijab->abji", x120) * 0.5
    l2new += lib.einsum("ijab->baji", x120) * -1
    del x120
    x126 = np.zeros((nvir, nvir), dtype=np.float64)
    x126 += lib.einsum("abij,ijca->bc", l2, x14)
    del x14
    x127 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x127 += lib.einsum("ab,ibjc->ijca", x126, v.ovov) * 4
    del x126
    x129 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x129 += lib.einsum("ijab->jiba", x127)
    del x127
    x15 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x15 += lib.einsum("iabj->ijba", v.ovvo) * 2
    x15 += lib.einsum("ijab->ijab", v.oovv) * -1
    x18 += lib.einsum("ia,jkba->ijkb", t1, x15) * -0.5
    x62 = np.zeros((nocc, nvir), dtype=np.float64)
    x62 += lib.einsum("ia,ijba->jb", t1, x15) * -1
    del x15
    x16 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x16 += lib.einsum("ia,jkla->ijlk", t1, v.ooov)
    x17 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x17 += lib.einsum("ijkl->jkli", x16)
    x17 += lib.einsum("ijkl->kjli", x16) * -0.5
    x25 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x25 += lib.einsum("ijkl->ijkl", x16) * 2
    x25 -= lib.einsum("ijkl->ikjl", x16)
    x26 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x26 += lib.einsum("ia,jkil->jkla", t1, x25)
    del x25
    x106 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x106 += lib.einsum("abij,jkli->klba", l2, x16)
    del x16
    x115 -= lib.einsum("ijab->ijab", x106)
    del x106
    x17 += lib.einsum("ijkl->kijl", v.oooo) * -0.5
    x17 += lib.einsum("ijkl->kilj", v.oooo)
    x18 += lib.einsum("ia,ijkl->ljka", t1, x17)
    del x17
    x18 += lib.einsum("ijak->jika", v.oovo) * -1
    x18 += lib.einsum("ijak->kija", v.oovo) * 0.5
    l1new = np.zeros((nvir, nocc), dtype=np.float64)
    l1new += lib.einsum("abij,jkia->bk", l2, x18) * 4
    del x18
    x19 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x19 += lib.einsum("ijab->jiab", t2) * 2
    x19 -= lib.einsum("ijab->jiba", t2)
    x20 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x20 -= lib.einsum("abij,ikca->jkbc", l2, x19)
    del x19
    x20 += lib.einsum("abij,jkac->ikbc", l2, t2)
    x21 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x21 += lib.einsum("iabc->ibac", v.ovvv) * 2
    x21 -= lib.einsum("iabc->ibca", v.ovvv)
    x83 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x83 += lib.einsum("ia,jbca->ijbc", t1, x21)
    x84 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x84 += lib.einsum("ijab->ijab", x83)
    del x83
    l1new -= lib.einsum("ijab,jabc->ci", x20, x21) * 2
    del x20
    del x21
    x22 += lib.einsum("ijka->jika", v.ooov) * 2
    x22 -= lib.einsum("ijka->jkia", v.ooov)
    x26 += lib.einsum("ijab,klia->kljb", t2, x22)
    del x22
    x23 -= lib.einsum("ijka->jika", v.ooov)
    x23 += lib.einsum("ijka->jkia", v.ooov) * 2
    x26 += lib.einsum("ijab,klib->klja", t2, x23)
    del x23
    x24 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x24 -= lib.einsum("iabj->ijba", v.ovvo)
    x24 += lib.einsum("ijab->ijab", v.oovv) * 2
    x26 -= lib.einsum("ia,jkba->ijkb", t1, x24)
    del x24
    l1new += lib.einsum("abij,jkib->ak", l2, x26) * 2
    del x26
    x27 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x27 += lib.einsum("ai,jkab->ikjb", l1, t2)
    x37 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x37 += lib.einsum("ijka->ijka", x27) * -1
    x37 += lib.einsum("ijka->ikja", x27) * 0.5
    del x27
    x28 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x28 += lib.einsum("abij,klab->ijkl", l2, t2)
    x31 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x31 += lib.einsum("ijkl->jilk", x28)
    x50 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x50 += lib.einsum("ijkl->jikl", x28) * -0.5
    x50 += lib.einsum("ijkl->jilk", x28)
    l1new += lib.einsum("ijka,jlik->al", v.ooov, x50) * 4
    del x50
    x123 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x123 += lib.einsum("ijkl->jilk", x28)
    del x28
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 += lib.einsum("ia,abjk->kjib", t1, l2)
    x30 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x30 += lib.einsum("ia,jkla->kjli", t1, x29)
    x31 += lib.einsum("ijkl->ijkl", x30)
    x32 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x32 += lib.einsum("ia,ijkl->jkla", t1, x31) * 0.5
    del x31
    x37 += lib.einsum("ijka->ikja", x32) * -1
    x37 += lib.einsum("ijka->ijka", x32) * 2
    del x32
    x49 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x49 += lib.einsum("ijkl->ijkl", x30) * -1
    x49 += lib.einsum("ijkl->ijlk", x30) * 2
    l1new += lib.einsum("ijka,ljik->al", v.ooov, x49) * 2
    del x49
    x123 += lib.einsum("ijkl->ijkl", x30)
    del x30
    x124 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x124 += lib.einsum("iajb,klji->klab", v.ovov, x123) * 4
    del x123
    x125 += lib.einsum("ijab->jiab", x124)
    del x124
    l2new += lib.einsum("ijab->abij", x125)
    l2new += lib.einsum("ijab->baij", x125) * -0.5
    del x125
    x33 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x33 += lib.einsum("ijka->ijka", x29)
    x33 += lib.einsum("ijka->jika", x29) * -0.5
    x42 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x42 += lib.einsum("ijab,ikla->kjlb", t2, x33) * 2
    x40 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x40 += lib.einsum("ijka->ijka", x29) * -1
    x40 += lib.einsum("ijka->jika", x29) * 2
    x42 += lib.einsum("ijab,iklb->kjla", t2, x40)
    del x40
    x43 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x43 -= lib.einsum("ijka->ijka", x29)
    x43 += lib.einsum("ijka->jika", x29) * 2
    x44 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x44 += lib.einsum("ia,jikb->jkba", t1, x43)
    l1new -= lib.einsum("iabc,jibc->aj", v.ovvv, x44) * 2
    del x44
    x91 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x91 += lib.einsum("ijka,jlib->klab", v.ooov, x43)
    x100 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x100 += lib.einsum("ijab->jiba", x91)
    del x91
    x92 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x92 += lib.einsum("ijka,ilkb->ljba", x43, x5)
    x100 += lib.einsum("ijab->jiba", x92)
    del x92
    l1new -= lib.einsum("iabj,kjib->ak", v.ovvo, x43) * 2
    del x43
    x45 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x45 += lib.einsum("ijka->ijka", x29) * 2
    x45 -= lib.einsum("ijka->jika", x29)
    x46 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x46 += lib.einsum("ia,jikb->jkba", t1, x45)
    l1new -= lib.einsum("iabc,jiba->cj", v.ovvv, x46) * 2
    del x46
    l1new -= lib.einsum("ijab,kjia->bk", v.oovv, x45) * 2
    del x45
    x78 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x78 += lib.einsum("ijka,ljkb->liba", v.ooov, x29)
    x100 -= lib.einsum("ijab->ijab", x78)
    del x78
    x79 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x79 += lib.einsum("iabc,jkib->kjac", v.ovvv, x29)
    x100 += lib.einsum("ijab->ijab", x79)
    del x79
    x80 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x80 += lib.einsum("ijka,jklb->ilab", x29, x5)
    x100 -= lib.einsum("ijab->ijab", x80)
    del x80
    x103 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x103 += lib.einsum("ia,jkib->jkab", f.ov, x29)
    x115 += lib.einsum("ijab->ijab", x103)
    del x103
    x107 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x107 += lib.einsum("ijka,jlkb->liba", v.ooov, x29)
    x115 -= lib.einsum("ijab->ijab", x107)
    del x107
    x108 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x108 += lib.einsum("ijka,iklb->jlab", x29, x5)
    del x5
    x115 -= lib.einsum("ijab->ijab", x108)
    del x108
    x34 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x34 += lib.einsum("ijab->jiab", t2) * 2
    x34 += lib.einsum("ijab->jiba", t2) * -1
    x37 += lib.einsum("ijka,ilba->jlkb", x33, x34) * -1
    del x33
    x62 += lib.einsum("iabc,ijca->jb", v.ovvv, x34) * -1
    del x34
    x35 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x35 += lib.einsum("ijab->jiab", t2) * -0.5
    x35 += lib.einsum("ijab->jiba", t2)
    x36 = np.zeros((nocc, nocc), dtype=np.float64)
    x36 += lib.einsum("abij,ikab->jk", l2, x35) * 2
    x37 += lib.einsum("ia,jk->jika", t1, x36) * -1
    l1new += lib.einsum("iajb,kija->bk", v.ovov, x37) * 4
    del x37
    x65 = np.zeros((nocc, nocc), dtype=np.float64)
    x65 += lib.einsum("ij->ij", x36)
    del x36
    x41 = np.zeros((nocc, nocc), dtype=np.float64)
    x41 += lib.einsum("abij,ikab->jk", l2, x35)
    x42 += lib.einsum("ia,jk->jika", t1, x41) * 2
    l1new += lib.einsum("iajb,kijb->ak", v.ovov, x42) * 2
    del x42
    x70 = np.zeros((nocc, nocc), dtype=np.float64)
    x70 += lib.einsum("ij->ij", x41)
    x128 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x128 += lib.einsum("ij,jakb->kiab", x41, v.ovov) * 4
    del x41
    x129 += lib.einsum("ijab->jiba", x128)
    del x128
    l2new += lib.einsum("ijab->abij", x129)
    l2new += lib.einsum("ijab->baij", x129) * -2
    l2new += lib.einsum("ijab->abji", x129) * -2
    l2new += lib.einsum("ijab->baji", x129)
    del x129
    x55 = np.zeros((nocc, nocc), dtype=np.float64)
    x55 += lib.einsum("iajb,ikab->jk", v.ovov, x35) * 2
    x59 = np.zeros((nocc, nocc), dtype=np.float64)
    x59 += lib.einsum("ij->ij", x55)
    del x55
    x66 = np.zeros((nocc, nvir), dtype=np.float64)
    x66 += lib.einsum("ijka,ijab->kb", x29, x35) * 2
    del x35
    x38 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x38 += lib.einsum("ia,bcda->ibdc", t1, v.vvvv)
    x39 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x39 += lib.einsum("iabc->iabc", x38) * -0.5
    x39 += lib.einsum("iabc->ibac", x38)
    del x38
    x39 += lib.einsum("aibc->iabc", v.vovv)
    x39 += lib.einsum("aibc->ibac", v.vovv) * -0.5
    l1new += lib.einsum("abij,iabc->cj", l2, x39) * 4
    del x39
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += lib.einsum("abij,jkca->ikbc", l2, t2)
    x48 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x48 -= lib.einsum("iabc->ibac", v.ovvv)
    x48 += lib.einsum("iabc->ibca", v.ovvv) * 2
    x73 = np.zeros((nvir, nvir), dtype=np.float64)
    x73 += lib.einsum("ia,ibca->bc", t1, x48)
    x74 = np.zeros((nvir, nvir), dtype=np.float64)
    x74 += lib.einsum("ab->ab", x73)
    x98 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x98 += lib.einsum("ab,acij->ijcb", x73, l2)
    del x73
    x100 -= lib.einsum("ijab->jiab", x98)
    del x98
    l1new -= lib.einsum("ijab,jabc->ci", x47, x48) * 2
    del x48
    del x47
    x51 += lib.einsum("ijka->ikja", v.ooov)
    x62 += lib.einsum("ijab,jika->kb", t2, x51) * 2
    del x51
    x53 += lib.einsum("ia->ia", f.ov)
    x58 = np.zeros((nocc, nocc), dtype=np.float64)
    x58 += lib.einsum("ia,ja->ij", t1, x53)
    x59 += lib.einsum("ij->ji", x58)
    del x58
    x54 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x54 += lib.einsum("ijab->jiab", t2) * -1
    x54 += lib.einsum("ijab->jiba", t2) * 2
    x62 += lib.einsum("ia,ijab->jb", x53, x54) * -1
    del x53
    x66 += lib.einsum("ai,ijab->jb", l1, x54) * -1
    del x54
    x56 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x56 += lib.einsum("ijka->ikja", v.ooov)
    x56 += lib.einsum("ijka->kija", v.ooov) * -0.5
    x57 = np.zeros((nocc, nocc), dtype=np.float64)
    x57 += lib.einsum("ia,jika->jk", t1, x56) * 2
    del x56
    x59 += lib.einsum("ij->ij", x57)
    del x57
    x59 += lib.einsum("ij->ij", f.oo)
    x62 += lib.einsum("ia,ij->ja", t1, x59)
    l1new += lib.einsum("ai,ji->aj", l1, x59) * -2
    del x59
    x60 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x60 += lib.einsum("iabc->ibac", v.ovvv) * -0.5
    x60 += lib.einsum("iabc->ibca", v.ovvv)
    x61 = np.zeros((nvir, nvir), dtype=np.float64)
    x61 += lib.einsum("ia,ibca->bc", t1, x60) * 2
    del x60
    x61 += lib.einsum("ab->ab", f.vv)
    x62 += lib.einsum("ia,ba->ib", t1, x61) * -1
    del x61
    x62 += lib.einsum("ai->ia", f.vo) * -1
    x62 += lib.einsum("ijab,jkib->ka", t2, v.ooov) * -1
    x63 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x63 += lib.einsum("abij->jiab", l2)
    x63 += lib.einsum("abij->jiba", l2) * -0.5
    l1new += lib.einsum("ia,ijba->bj", x62, x63) * -4
    del x62
    del x63
    x64 = np.zeros((nocc, nocc), dtype=np.float64)
    x64 += lib.einsum("ai,ja->ij", l1, t1)
    x65 += lib.einsum("ij->ij", x64)
    x66 += lib.einsum("ia,ij->ja", t1, x65)
    l1new += lib.einsum("ia,ji->aj", f.ov, x65) * -2
    del x65
    x70 += lib.einsum("ij->ij", x64) * 0.5
    x105 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x105 += lib.einsum("ij,kajb->ikab", x64, v.ovov)
    x115 += lib.einsum("ijab->ijab", x105)
    del x105
    x66 += lib.einsum("ia->ia", t1) * -1
    x67 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x67 -= lib.einsum("iajb->jiab", v.ovov)
    x67 += lib.einsum("iajb->jiba", v.ovov) * 2
    l1new += lib.einsum("ia,ijab->bj", x66, x67) * -2
    del x66
    del x67
    x68 += lib.einsum("ai,ib->ab", l1, t1)
    x69 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x69 += lib.einsum("iabc->ibac", v.ovvv) * 2
    x69 += lib.einsum("iabc->ibca", v.ovvv) * -1
    l1new += lib.einsum("ab,iacb->ci", x68, x69) * 2
    del x68
    del x69
    x71 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x71 += lib.einsum("ijka->ikja", v.ooov) * -1
    x71 += lib.einsum("ijka->kija", v.ooov) * 2
    l1new += lib.einsum("ij,kjia->ak", x70, x71) * -4
    del x70
    del x71
    x72 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x72 += lib.einsum("iabj->ijba", v.ovvo) * 2
    x72 -= lib.einsum("ijab->ijab", v.oovv)
    l1new += lib.einsum("ai,jiab->bj", l1, x72) * 2
    del x72
    x74 += lib.einsum("ab->ab", f.vv)
    l1new += lib.einsum("ai,ab->bi", l1, x74) * 2
    del x74
    x75 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x75 += lib.einsum("iajb->jiab", v.ovov) * 2
    x75 -= lib.einsum("iajb->jiba", v.ovov)
    x76 = np.zeros((nocc, nvir), dtype=np.float64)
    x76 += lib.einsum("ia,ijba->jb", t1, x75)
    x95 = np.zeros((nocc, nocc), dtype=np.float64)
    x95 += lib.einsum("ia,ja->ij", t1, x76)
    x96 = np.zeros((nocc, nocc), dtype=np.float64)
    x96 += lib.einsum("ij->ji", x95)
    del x95
    x99 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x99 += lib.einsum("ia,jkib->jkba", x76, x29)
    del x29
    x100 += lib.einsum("ijab->ijab", x99)
    del x99
    x100 -= lib.einsum("ai,jb->ijab", l1, x76)
    l1new -= lib.einsum("ij,ja->ai", x64, x76) * 2
    del x64
    del x76
    x77 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x77 += lib.einsum("ai,jikb->jkab", l1, v.ooov)
    x100 += lib.einsum("ijab->ijab", x77)
    del x77
    x81 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x81 -= lib.einsum("ijab->jiab", t2)
    x81 += lib.einsum("ijab->jiba", t2) * 2
    x82 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x82 += lib.einsum("ijab,ikbc->jkac", x75, x81)
    del x75
    x84 += lib.einsum("ijab->jiba", x82)
    del x82
    x88 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x88 += lib.einsum("iajb,ikac->jkbc", v.ovov, x81)
    del x81
    x89 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x89 += lib.einsum("ijab->jiba", x88)
    del x88
    x84 += lib.einsum("iabj->jiba", v.ovvo) * 2
    x84 -= lib.einsum("ijab->jiab", v.oovv)
    x85 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x85 += lib.einsum("abij,ikac->jkbc", l2, x84)
    del x84
    x100 -= lib.einsum("ijab->ijab", x85)
    del x85
    x86 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x86 += lib.einsum("ia,jbca->ijcb", t1, v.ovvv)
    x89 += lib.einsum("ijab->ijab", x86)
    del x86
    x87 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x87 += lib.einsum("ijab,kaic->jkbc", t2, v.ovov)
    x89 -= lib.einsum("ijab->ijab", x87)
    del x87
    x89 += lib.einsum("iabj->jiba", v.ovvo)
    x90 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x90 += lib.einsum("abij,ikbc->jkac", l2, x89)
    del x89
    x100 += lib.einsum("ijab->ijab", x90)
    del x90
    x93 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x93 -= lib.einsum("ijka->ikja", v.ooov)
    x93 += lib.einsum("ijka->kija", v.ooov) * 2
    x94 = np.zeros((nocc, nocc), dtype=np.float64)
    x94 += lib.einsum("ia,ijka->jk", t1, x93)
    del x93
    x96 += lib.einsum("ij->ij", x94)
    del x94
    x97 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x97 += lib.einsum("ij,abjk->kiab", x96, l2)
    del x96
    x100 += lib.einsum("ijab->ijba", x97)
    del x97
    x100 -= lib.einsum("ia,bj->ijab", f.ov, l1)
    l2new -= lib.einsum("ijab->abij", x100) * 4
    l2new += lib.einsum("ijab->baij", x100) * 2
    l2new += lib.einsum("ijab->abji", x100) * 2
    l2new -= lib.einsum("ijab->baji", x100) * 4
    del x100
    x101 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x101 += lib.einsum("ab,acij->jibc", f.vv, l2)
    x115 -= lib.einsum("ijab->ijab", x101)
    del x101
    x102 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x102 += lib.einsum("ai,jbac->ijbc", l1, v.ovvv)
    x115 -= lib.einsum("ijab->ijab", x102)
    del x102
    x109 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x109 += lib.einsum("ijab,kbic->jkac", t2, v.ovov)
    x110 -= lib.einsum("ijab->ijab", x109)
    del x109
    x110 += lib.einsum("ijab->jiab", v.oovv)
    x111 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x111 += lib.einsum("abij,ikbc->jkac", l2, x110)
    del x110
    x115 += lib.einsum("ijab->ijab", x111)
    del x111
    x112 = np.zeros((nocc, nocc), dtype=np.float64)
    x112 += lib.einsum("ia,ja->ij", f.ov, t1)
    x113 = np.zeros((nocc, nocc), dtype=np.float64)
    x113 += lib.einsum("ij->ij", x112)
    del x112
    x113 += lib.einsum("ij->ij", f.oo)
    x114 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x114 += lib.einsum("ij,abjk->kiab", x113, l2)
    del x113
    x115 += lib.einsum("ijab->jiba", x114)
    del x114
    l2new += lib.einsum("ijab->abij", x115) * 2
    l2new -= lib.einsum("ijab->baij", x115) * 4
    l2new -= lib.einsum("ijab->abji", x115) * 4
    l2new += lib.einsum("ijab->baji", x115) * 2
    del x115
    x130 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x130 += lib.einsum("abij,kjli->klba", l2, v.oooo)
    x132 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x132 += lib.einsum("ijab->jiba", x130) * 2
    del x130
    x131 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x131 += lib.einsum("abij,acbd->ijcd", l2, v.vvvv)
    x132 += lib.einsum("ijab->jiba", x131) * 2
    del x131
    l2new += lib.einsum("ijab->baij", x132) * -1
    l2new += lib.einsum("ijab->abij", x132) * 2
    del x132
    l1new += lib.einsum("ia->ai", f.ov) * 2
    l2new -= lib.einsum("iajb->abji", v.ovov) * 2
    l2new += lib.einsum("iajb->baji", v.ovov) * 4

    return {"l1new": l1new, "l2new": l2new}

def make_rdm1_f(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    # 1RDM
    x0 = np.zeros((nocc, nocc), dtype=np.float64)
    x0 += lib.einsum("ai,ja->ij", l1, t1)
    x6 = np.zeros((nocc, nocc), dtype=np.float64)
    x6 += lib.einsum("ij->ij", x0)
    rdm1_f_oo = np.zeros((nocc, nocc), dtype=np.float64)
    rdm1_f_oo -= lib.einsum("ij->ij", x0) * 2
    del x0
    x1 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("ijab->jiab", t2) * 2
    x1 += lib.einsum("ijab->jiba", t2) * -1
    rdm1_f_oo += lib.einsum("abij,ikba->jk", l2, x1) * -2
    del x1
    x2 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x2 += lib.einsum("ia,bajk->jkib", t1, l2)
    x3 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x3 += lib.einsum("ijka->ijka", x2) * 2
    x3 += lib.einsum("ijka->jika", x2) * -1
    del x2
    rdm1_f_vo = np.zeros((nvir, nocc), dtype=np.float64)
    rdm1_f_vo += lib.einsum("ijab,jikb->ak", t2, x3) * -2
    del x3
    x4 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x4 += lib.einsum("ijab->jiab", t2) * 2
    x4 -= lib.einsum("ijab->jiba", t2)
    rdm1_f_vo += lib.einsum("ai,ijba->bj", l1, x4) * 2
    del x4
    x5 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x5 += lib.einsum("ijab->jiab", t2) * -0.5
    x5 += lib.einsum("ijab->jiba", t2)
    x6 += lib.einsum("abij,ikab->jk", l2, x5) * 2
    del x5
    rdm1_f_vo += lib.einsum("ia,ij->aj", t1, x6) * -2
    del x6
    x7 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x7 += lib.einsum("abij->jiab", l2) * -0.5
    x7 += lib.einsum("abij->jiba", l2)
    rdm1_f_vv = np.zeros((nvir, nvir), dtype=np.float64)
    rdm1_f_vv += lib.einsum("ijab,ijcb->ac", t2, x7) * 4
    del x7
    rdm1_f_oo += lib.einsum("ij->ji", delta_oo) * 2
    rdm1_f_ov = np.zeros((nocc, nvir), dtype=np.float64)
    rdm1_f_ov += lib.einsum("ai->ia", l1) * 2
    rdm1_f_vo += lib.einsum("ia->ai", t1) * 2
    rdm1_f_vv += lib.einsum("ai,ib->ba", l1, t1) * 2

    rdm1_f = np.block([[rdm1_f_oo, rdm1_f_ov], [rdm1_f_vo, rdm1_f_vv]])

    return rdm1_f

def make_rdm2_f(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    # 2RDM
    x0 = np.zeros((nocc, nocc), dtype=np.float64)
    x0 += lib.einsum("ai,ja->ij", l1, t1)
    x8 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x8 += lib.einsum("ia,jk->jika", t1, x0)
    x15 = np.zeros((nocc, nvir), dtype=np.float64)
    x15 += lib.einsum("ia,ij->ja", t1, x0)
    x17 = np.zeros((nocc, nvir), dtype=np.float64)
    x17 += lib.einsum("ia->ia", x15)
    del x15
    x28 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x28 += lib.einsum("ij,kiab->jkab", x0, t2)
    x31 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x31 += lib.einsum("ijab->ijab", x28)
    del x28
    rdm2_f_oooo = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    rdm2_f_oooo -= lib.einsum("ij,kl->jilk", delta_oo, x0) * 4
    rdm2_f_oooo += lib.einsum("ij,kl->lijk", delta_oo, x0) * 2
    rdm2_f_oooo += lib.einsum("ij,kl->jkli", delta_oo, x0) * 2
    rdm2_f_oooo -= lib.einsum("ij,kl->lkji", delta_oo, x0) * 4
    del x0
    x1 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("ijab->jiab", t2) * -0.5
    x1 += lib.einsum("ijab->jiba", t2)
    x2 = np.zeros((nocc, nocc), dtype=np.float64)
    x2 += lib.einsum("abij,ikab->jk", l2, x1)
    del x1
    x20 = np.zeros((nocc, nvir), dtype=np.float64)
    x20 += lib.einsum("ia,ij->ja", t1, x2)
    x21 = np.zeros((nocc, nvir), dtype=np.float64)
    x21 += lib.einsum("ia->ia", x20)
    del x20
    x43 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x43 += lib.einsum("ij,ikab->kjab", x2, t2) * 8
    x44 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x44 += lib.einsum("ijab->ijba", x43)
    del x43
    rdm2_f_oooo += lib.einsum("ij,kl->jilk", delta_oo, x2) * -8
    rdm2_f_oooo += lib.einsum("ij,kl->jkli", delta_oo, x2) * 4
    rdm2_f_oooo += lib.einsum("ij,kl->ljik", delta_oo, x2) * 4
    rdm2_f_oooo += lib.einsum("ij,kl->lkij", delta_oo, x2) * -8
    rdm2_f_ooov = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    rdm2_f_ooov += lib.einsum("ia,jk->ijka", t1, x2) * 4
    rdm2_f_ooov += lib.einsum("ia,jk->kjia", t1, x2) * -8
    rdm2_f_ovoo = np.zeros((nocc, nvir, nocc, nocc), dtype=np.float64)
    rdm2_f_ovoo += lib.einsum("ia,jk->iakj", t1, x2) * -8
    rdm2_f_ovoo += lib.einsum("ia,jk->kaij", t1, x2) * 4
    del x2
    x3 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x3 += lib.einsum("abij,klba->ijlk", l2, t2)
    x14 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x14 += lib.einsum("ia,jikl->jkla", t1, x3)
    x45 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x45 += lib.einsum("ia,ijkb->kjba", t1, x14)
    x48 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x48 += lib.einsum("ijab->ijab", x45) * 4.000000000000003
    del x45
    rdm2_f_ooov += lib.einsum("ijka->jika", x14) * 4
    rdm2_f_ooov += lib.einsum("ijka->kija", x14) * -2
    rdm2_f_ovoo += lib.einsum("ijka->jaki", x14) * -2
    rdm2_f_ovoo += lib.einsum("ijka->kaji", x14) * 4
    del x14
    x46 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x46 += lib.einsum("ijkl->jilk", x3)
    rdm2_f_oooo += lib.einsum("ijkl->kjli", x3) * -2
    rdm2_f_oooo += lib.einsum("ijkl->ljki", x3) * 4
    del x3
    x4 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x4 += lib.einsum("ia,bajk->jkib", t1, l2)
    x5 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x5 += lib.einsum("ia,jkla->kjli", t1, x4)
    x10 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x10 += lib.einsum("ia,ijkl->jlka", t1, x5)
    x13 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x13 += lib.einsum("ijka->jika", x10)
    x35 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x35 += lib.einsum("ia,ijkb->jkab", t1, x10)
    del x10
    x37 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x37 += lib.einsum("ijab->ijab", x35)
    del x35
    x46 += lib.einsum("ijkl->ijkl", x5)
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += lib.einsum("ijab,ijkl->klab", t2, x46) * 4
    del x46
    x48 += lib.einsum("ijab->ijab", x47)
    del x47
    rdm2_f_ovov = np.zeros((nocc, nvir, nocc, nvir), dtype=np.float64)
    rdm2_f_ovov += lib.einsum("ijab->iajb", x48)
    rdm2_f_ovov += lib.einsum("ijab->ibja", x48) * -0.5
    del x48
    rdm2_f_oooo -= lib.einsum("ijkl->kjli", x5) * 2
    rdm2_f_oooo += lib.einsum("ijkl->ljki", x5) * 4
    del x5
    x7 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x7 += lib.einsum("ijab,kjla->klib", t2, x4)
    x8 -= lib.einsum("ijka->ijka", x7)
    x29 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x29 -= lib.einsum("ijka->ijka", x7)
    del x7
    x9 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x9 += lib.einsum("ijab,kjlb->klia", t2, x4)
    x13 += lib.einsum("ijka->jika", x9)
    x25 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x25 += lib.einsum("ijka->ijka", x9)
    del x9
    x18 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x18 += lib.einsum("ijka->ijka", x4)
    x18 += lib.einsum("ijka->jika", x4) * -0.5
    x19 = np.zeros((nocc, nvir), dtype=np.float64)
    x19 += lib.einsum("ijab,ijka->kb", t2, x18)
    del x18
    x21 += lib.einsum("ia->ia", x19)
    del x19
    x44 += lib.einsum("ia,jb->ijab", t1, x21) * 8.000000000000005
    rdm2_f_ooov += lib.einsum("ij,ka->jika", delta_oo, x21) * -8
    rdm2_f_ooov += lib.einsum("ij,ka->kjia", delta_oo, x21) * 4
    rdm2_f_ovoo += lib.einsum("ij,ka->jaki", delta_oo, x21) * 4
    rdm2_f_ovoo += lib.einsum("ij,ka->kaij", delta_oo, x21) * -8
    del x21
    x51 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x51 -= lib.einsum("ijka->ijka", x4)
    x51 += lib.einsum("ijka->jika", x4) * 2
    x52 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x52 += lib.einsum("ia,jikb->jkba", t1, x51)
    del x51
    rdm2_f_oovv = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    rdm2_f_oovv -= lib.einsum("ijab->jiab", x52) * 2
    rdm2_f_vvoo = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    rdm2_f_vvoo -= lib.einsum("ijab->abji", x52) * 2
    del x52
    x56 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x56 += lib.einsum("ijka->ijka", x4) * 2
    x56 -= lib.einsum("ijka->jika", x4)
    x57 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x57 += lib.einsum("ia,jikb->jkba", t1, x56)
    del x56
    rdm2_f_ovvo = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    rdm2_f_ovvo -= lib.einsum("ijab->jbai", x57) * 2
    rdm2_f_voov = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    rdm2_f_voov -= lib.einsum("ijab->aijb", x57) * 2
    del x57
    x62 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x62 += lib.einsum("ia,jikb->jkba", t1, x4)
    x63 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x63 += lib.einsum("ijab->ijab", x62)
    del x62
    x68 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x68 += lib.einsum("ijab,ijkc->kcab", t2, x4)
    rdm2_f_ovvv = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    rdm2_f_ovvv += lib.einsum("iabc->ibac", x68) * 2
    rdm2_f_ovvv += lib.einsum("iabc->icab", x68) * -4
    rdm2_f_vvov = np.zeros((nvir, nvir, nocc, nvir), dtype=np.float64)
    rdm2_f_vvov += lib.einsum("iabc->abic", x68) * -4
    rdm2_f_vvov += lib.einsum("iabc->acib", x68) * 2
    del x68
    rdm2_f_oovo = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    rdm2_f_oovo += lib.einsum("ijka->kiaj", x4) * 2
    rdm2_f_oovo -= lib.einsum("ijka->kjai", x4) * 4
    rdm2_f_vooo = np.zeros((nvir, nocc, nocc, nocc), dtype=np.float64)
    rdm2_f_vooo -= lib.einsum("ijka->aikj", x4) * 4
    rdm2_f_vooo += lib.einsum("ijka->ajki", x4) * 2
    x6 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x6 += lib.einsum("ai,jkba->ijkb", l1, t2)
    x8 += lib.einsum("ijka->ijka", x6)
    rdm2_f_ooov += lib.einsum("ijka->jika", x8) * 2
    rdm2_f_ooov -= lib.einsum("ijka->kija", x8) * 4
    rdm2_f_ovoo -= lib.einsum("ijka->jaki", x8) * 4
    rdm2_f_ovoo += lib.einsum("ijka->kaji", x8) * 2
    del x8
    x29 += lib.einsum("ijka->ijka", x6)
    del x6
    x30 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x30 += lib.einsum("ia,ijkb->jkba", t1, x29)
    del x29
    x31 += lib.einsum("ijab->ijba", x30)
    del x30
    rdm2_f_ovov += lib.einsum("ijab->iajb", x31) * 2
    rdm2_f_ovov -= lib.einsum("ijab->ibja", x31) * 4
    rdm2_f_ovov -= lib.einsum("ijab->jaib", x31) * 4
    rdm2_f_ovov += lib.einsum("ijab->jbia", x31) * 2
    del x31
    x11 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x11 += lib.einsum("ijab->jiab", t2) * 2
    x11 -= lib.einsum("ijab->jiba", t2)
    x12 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x12 += lib.einsum("ijab,iklb->jkla", x11, x4)
    del x4
    x13 -= lib.einsum("ijka->kjia", x12)
    x25 -= lib.einsum("ijka->jkia", x12)
    del x12
    x26 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x26 += lib.einsum("ia,ijkb->jkba", t1, x25)
    del x25
    x27 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x27 -= lib.einsum("ijab->ijba", x26)
    del x26
    x16 = np.zeros((nocc, nvir), dtype=np.float64)
    x16 += lib.einsum("ai,ijba->jb", l1, x11)
    x17 -= lib.einsum("ia->ia", x16)
    del x16
    x27 += lib.einsum("ia,jb->ijab", t1, x17)
    rdm2_f_ooov -= lib.einsum("ij,ka->jika", delta_oo, x17) * 4
    rdm2_f_ooov += lib.einsum("ij,ka->kjia", delta_oo, x17) * 2
    rdm2_f_ovoo += lib.einsum("ij,ka->jaki", delta_oo, x17) * 2
    rdm2_f_ovoo -= lib.einsum("ij,ka->kaij", delta_oo, x17) * 4
    del x17
    x49 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x49 += lib.einsum("abij,ikca->kjcb", l2, x11)
    x63 -= lib.einsum("ijab->jiba", x49)
    rdm2_f_oovv -= lib.einsum("ijab->ijba", x49) * 2
    del x49
    x13 += lib.einsum("ij,ka->jika", delta_oo, t1)
    rdm2_f_ooov += lib.einsum("ijka->ijka", x13) * 4
    rdm2_f_ooov -= lib.einsum("ijka->kjia", x13) * 2
    rdm2_f_ovoo -= lib.einsum("ijka->iakj", x13) * 2
    rdm2_f_ovoo += lib.einsum("ijka->kaij", x13) * 4
    del x13
    x22 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x22 += lib.einsum("abij->jiab", l2) * 2
    x22 -= lib.einsum("abij->jiba", l2)
    x23 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x23 += lib.einsum("ijab,ikca->kjcb", t2, x22)
    x24 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x24 += lib.einsum("ijab,ikbc->kjca", t2, x23)
    x27 += lib.einsum("ijab->ijab", x24)
    del x24
    rdm2_f_ovov -= lib.einsum("ijab->iajb", x27) * 4
    rdm2_f_ovov += lib.einsum("ijab->ibja", x27) * 2
    rdm2_f_ovov += lib.einsum("ijab->jaib", x27) * 2
    rdm2_f_ovov -= lib.einsum("ijab->jbia", x27) * 4
    del x27
    x36 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x36 += lib.einsum("ijab,ikac->kjcb", t2, x23)
    x37 += lib.einsum("ijab->ijab", x36) * 2
    del x36
    rdm2_f_vvoo -= lib.einsum("ijab->abji", x23) * 2
    del x23
    x55 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x55 += lib.einsum("ijab,ikcb->jkac", x11, x22)
    del x11
    del x22
    rdm2_f_ovvo += lib.einsum("ijab->iabj", x55) * 2
    rdm2_f_voov += lib.einsum("ijab->bjia", x55) * 2
    del x55
    x32 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x32 += lib.einsum("ijab->jiba", t2)
    x32 += lib.einsum("ia,jb->ijab", t1, t1)
    rdm2_f_ovov -= lib.einsum("ijab->ibja", x32) * 2
    rdm2_f_ovov += lib.einsum("ijab->iajb", x32) * 4
    del x32
    x33 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x33 += lib.einsum("abij,kjbc->ikac", l2, t2)
    x34 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x34 += lib.einsum("ijab,jkac->ikbc", t2, x33)
    del x33
    x37 += lib.einsum("ijab->ijab", x34)
    del x34
    rdm2_f_ovov += lib.einsum("ijab->iajb", x37) * 4
    rdm2_f_ovov -= lib.einsum("ijab->ibja", x37) * 2
    del x37
    x38 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x38 += lib.einsum("abij,kjac->ikbc", l2, t2)
    x39 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x39 += lib.einsum("ijab,jkac->ikbc", t2, x38)
    rdm2_f_ovov -= lib.einsum("ijab->iajb", x39) * 2
    rdm2_f_ovov += lib.einsum("ijab->ibja", x39) * 4
    del x39
    x66 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x66 += lib.einsum("ia,ijbc->jbac", t1, x38)
    del x38
    x67 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x67 -= lib.einsum("iabc->iabc", x66)
    del x66
    x40 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x40 += lib.einsum("abij->jiab", l2)
    x40 += lib.einsum("abij->jiba", l2) * -0.5
    x41 = np.zeros((nvir, nvir), dtype=np.float64)
    x41 += lib.einsum("ijab,ijca->cb", t2, x40)
    x42 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x42 += lib.einsum("ab,ijac->ijbc", x41, t2) * 8
    x44 += lib.einsum("ijab->jiba", x42)
    del x42
    rdm2_f_ovov += lib.einsum("ijab->iajb", x44) * -1
    rdm2_f_ovov += lib.einsum("ijab->ibja", x44) * 0.5
    rdm2_f_ovov += lib.einsum("ijab->jaib", x44) * 0.5
    rdm2_f_ovov += lib.einsum("ijab->jbia", x44) * -1
    del x44
    x54 = np.zeros((nvir, nvir), dtype=np.float64)
    x54 += lib.einsum("ab->ab", x41)
    rdm2_f_ovvv += lib.einsum("ia,bc->iabc", t1, x41) * 8
    rdm2_f_ovvv += lib.einsum("ia,bc->icba", t1, x41) * -4
    rdm2_f_vvov += lib.einsum("ia,bc->baic", t1, x41) * -4
    rdm2_f_vvov += lib.einsum("ia,bc->bcia", t1, x41) * 8
    del x41
    x58 = np.zeros((nvir, nvir), dtype=np.float64)
    x58 += lib.einsum("ijab,ijca->cb", t2, x40) * 2
    del x40
    x59 = np.zeros((nvir, nvir), dtype=np.float64)
    x59 += lib.einsum("ab->ab", x58)
    del x58
    x50 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x50 -= lib.einsum("ijab->jiab", t2)
    x50 += lib.einsum("ijab->jiba", t2) * 2
    rdm2_f_oovv -= lib.einsum("abij,ikcb->kjac", l2, x50) * 2
    del x50
    x53 = np.zeros((nvir, nvir), dtype=np.float64)
    x53 += lib.einsum("ai,ib->ab", l1, t1)
    x54 += lib.einsum("ab->ab", x53) * 0.5
    rdm2_f_oovv += lib.einsum("ij,ab->jiab", delta_oo, x54) * 8
    del x54
    x59 += lib.einsum("ab->ab", x53)
    rdm2_f_ovvo += lib.einsum("ij,ab->jbai", delta_oo, x59) * -2
    rdm2_f_voov += lib.einsum("ij,ab->aijb", delta_oo, x59) * -2
    rdm2_f_vvoo += lib.einsum("ij,ab->abji", delta_oo, x59) * 4
    del x59
    x67 += lib.einsum("ia,bc->ibac", t1, x53)
    del x53
    x60 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x60 -= lib.einsum("abij->jiab", l2)
    x60 += lib.einsum("abij->jiba", l2) * 2
    rdm2_f_vvoo -= lib.einsum("ijab,ikcb->cajk", t2, x60) * 2
    del x60
    x61 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x61 += lib.einsum("abij,kjca->ikbc", l2, t2)
    x63 += lib.einsum("ijab->ijab", x61)
    del x61
    x64 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x64 += lib.einsum("ia,ijbc->jbca", t1, x63)
    del x63
    rdm2_f_ovvv += lib.einsum("iabc->icab", x64) * 2
    rdm2_f_ovvv -= lib.einsum("iabc->ibac", x64) * 4
    rdm2_f_vvov -= lib.einsum("iabc->acib", x64) * 4
    rdm2_f_vvov += lib.einsum("iabc->abic", x64) * 2
    del x64
    x65 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x65 += lib.einsum("ai,jibc->jabc", l1, t2)
    x67 += lib.einsum("iabc->iabc", x65)
    del x65
    rdm2_f_ovvv += lib.einsum("iabc->ibac", x67) * 4
    rdm2_f_ovvv -= lib.einsum("iabc->icab", x67) * 2
    rdm2_f_vvov -= lib.einsum("iabc->abic", x67) * 2
    rdm2_f_vvov += lib.einsum("iabc->acib", x67) * 4
    del x67
    x69 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x69 += lib.einsum("ia,bcji->jbca", t1, l2)
    x71 = np.zeros((nvir, nvir, nvir, nvir), dtype=np.float64)
    x71 += lib.einsum("ia,ibcd->cbda", t1, x69)
    rdm2_f_vvvv = np.zeros((nvir, nvir, nvir, nvir), dtype=np.float64)
    rdm2_f_vvvv -= lib.einsum("abcd->bcad", x71) * 2
    rdm2_f_vvvv += lib.einsum("abcd->bdac", x71) * 4
    del x71
    rdm2_f_vovv = np.zeros((nvir, nocc, nvir, nvir), dtype=np.float64)
    rdm2_f_vovv += lib.einsum("iabc->aibc", x69) * 4
    rdm2_f_vovv -= lib.einsum("iabc->biac", x69) * 2
    rdm2_f_vvvo = np.zeros((nvir, nvir, nvir, nocc), dtype=np.float64)
    rdm2_f_vvvo -= lib.einsum("iabc->acbi", x69) * 2
    rdm2_f_vvvo += lib.einsum("iabc->bcai", x69) * 4
    del x69
    x70 = np.zeros((nvir, nvir, nvir, nvir), dtype=np.float64)
    x70 += lib.einsum("abij,ijcd->abcd", l2, t2)
    rdm2_f_vvvv += lib.einsum("abcd->bcad", x70) * -2
    rdm2_f_vvvv += lib.einsum("abcd->bdac", x70) * 4
    del x70
    rdm2_f_oooo += lib.einsum("ij,kl->jilk", delta_oo, delta_oo) * 4
    rdm2_f_oooo -= lib.einsum("ij,kl->ljik", delta_oo, delta_oo) * 2
    rdm2_f_oovo += lib.einsum("ij,ak->jiak", delta_oo, l1) * 4
    rdm2_f_oovo -= lib.einsum("ij,ak->jkai", delta_oo, l1) * 2
    rdm2_f_vooo -= lib.einsum("ij,ak->aijk", delta_oo, l1) * 2
    rdm2_f_vooo += lib.einsum("ij,ak->akji", delta_oo, l1) * 4
    rdm2_f_oovv -= lib.einsum("ai,jb->jiab", l1, t1) * 2
    rdm2_f_ovvo += lib.einsum("ai,jb->jbai", l1, t1) * 4
    rdm2_f_voov += lib.einsum("ai,jb->aijb", l1, t1) * 4
    rdm2_f_vvoo -= lib.einsum("ai,jb->abji", l1, t1) * 2
    rdm2_f_vovo = np.zeros((nvir, nocc, nvir, nocc), dtype=np.float64)
    rdm2_f_vovo -= lib.einsum("abij->ajbi", l2) * 2
    rdm2_f_vovo += lib.einsum("abij->bjai", l2) * 4

    rdm2_f = common.pack_2e(rdm2_f_oooo, rdm2_f_ooov, rdm2_f_oovo, rdm2_f_ovoo, rdm2_f_vooo, rdm2_f_oovv, rdm2_f_ovov, rdm2_f_ovvo, rdm2_f_voov, rdm2_f_vovo, rdm2_f_vvoo, rdm2_f_ovvv, rdm2_f_vovv, rdm2_f_vvov, rdm2_f_vvvo, rdm2_f_vvvv)

    return rdm2_f

def make_ip_mom_kets(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    ket2_o = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    ket1_o = np.zeros((nocc, nocc), dtype=np.float64)
    ket1_o += lib.einsum("ij->ji", delta_oo) * 2
    ket1_v = np.zeros((nocc, nvir), dtype=np.float64)
    ket1_v += lib.einsum("ia->ia", t1) * 2
    ket2_v = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    ket2_v += lib.einsum("ijab->jiab", t2) * 2
    ket2_v -= lib.einsum("ijab->jiba", t2) * 4

    ket1 = np.concatenate([ket1_o, ket1_v], axis=1)
    ket2 = np.concatenate([ket2_o, ket2_v], axis=3)

    return ket1, ket2

def make_ea_mom_kets(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    ket2_v = np.zeros((nvir, nvir, nocc, nvir), dtype=np.float64)
    ket1_o = np.zeros((nvir, nocc), dtype=np.float64)
    ket1_o -= lib.einsum("ia->ai", t1) * 2
    ket1_v = np.zeros((nvir, nvir), dtype=np.float64)
    ket1_v += lib.einsum("ab->ba", delta_vv) * 2
    ket2_o = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    ket2_o -= lib.einsum("ijab->abji", t2) * 2
    ket2_o += lib.einsum("ijab->baji", t2) * 4

    ket1 = np.concatenate([ket1_o, ket1_v], axis=1)
    ket2 = np.concatenate([ket2_o, ket2_v], axis=3)

    ket2 = ket2.swapaxes(0, 1)

    return ket1, ket2

def make_ip_mom_bras(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("ijab->jiab", t2) * -1
    x0 += lib.einsum("ijab->jiba", t2) * 2
    bra1_o = np.zeros((nocc, nocc), dtype=np.float64)
    bra1_o += lib.einsum("abij,ikab->kj", l2, x0) * -2
    del x0
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += lib.einsum("ia,bajk->jkib", t1, l2)
    bra2_o = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    bra2_o += lib.einsum("ijka->kija", x1) * 4
    bra2_o -= lib.einsum("ijka->kjia", x1) * 2
    del x1
    bra1_o += lib.einsum("ij->ji", delta_oo) * 2
    bra1_o -= lib.einsum("ai,ja->ji", l1, t1) * 2
    bra1_v = np.zeros((nvir, nocc), dtype=np.float64)
    bra1_v += lib.einsum("ai->ai", l1) * 2
    bra2_o += lib.einsum("ij,ak->jika", delta_oo, l1) * 2
    bra2_o -= lib.einsum("ij,ak->jkia", delta_oo, l1) * 4
    bra2_v = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    bra2_v -= lib.einsum("abij->ajib", l2) * 4
    bra2_v += lib.einsum("abij->bjia", l2) * 2

    bra1 = np.concatenate([bra1_o, bra1_v], axis=0)
    bra2 = np.concatenate([bra2_o, bra2_v], axis=0)

    return bra1, bra2

def make_ea_mom_bras(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("ijab->jiab", t2) * 2
    x0 += lib.einsum("ijab->jiba", t2) * -1
    bra1_v = np.zeros((nvir, nvir), dtype=np.float64)
    bra1_v += lib.einsum("abij,ijbc->ca", l2, x0) * -2
    del x0
    x1 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("ia,bcji->jbca", t1, l2)
    bra2_v = np.zeros((nvir, nvir, nvir, nocc), dtype=np.float64)
    bra2_v -= lib.einsum("iabc->cabi", x1) * 4
    bra2_v += lib.einsum("iabc->cbai", x1) * 2
    del x1
    bra1_o = np.zeros((nocc, nvir), dtype=np.float64)
    bra1_o -= lib.einsum("ai->ia", l1) * 2
    bra1_v -= lib.einsum("ai,ib->ba", l1, t1) * 2
    bra1_v += lib.einsum("ab->ba", delta_vv) * 2
    bra2_o = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    bra2_o -= lib.einsum("abij->jabi", l2) * 4
    bra2_o += lib.einsum("abij->jbai", l2) * 2
    bra2_v -= lib.einsum("ab,ci->baci", delta_vv, l1) * 2
    bra2_v += lib.einsum("ab,ci->bcai", delta_vv, l1) * 4

    bra1 = np.concatenate([bra1_o, bra1_v], axis=0)
    bra2 = np.concatenate([bra2_o, bra2_v], axis=0)

    return bra1, bra2

def hbar_diag_ip(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    r1 = np.zeros((nocc), dtype=np.float64)
    r1 += lib.einsum("ijab,ibka->j", t2, v.ovov)
    r1 += lib.einsum("ijab,iakb->j", t2, v.ovov) * -2
    r1 += lib.einsum("ia,jb,jakb->i", t1, t1, v.ovov)
    r1 += lib.einsum("ia,jb,jbka->i", t1, t1, v.ovov) * -2
    r1 += lib.einsum("ij->j", f.oo) * -1
    r1 += lib.einsum("ia,ijka->j", t1, v.ooov)
    r1 += lib.einsum("ia,iajk->k", t1, v.ovoo) * -2
    r1 += lib.einsum("ia,ja->j", f.ov, t1) * -1

    r2 = np.zeros((nocc,  nocc,  nvir), dtype=np.float64)
    r2 += lib.einsum("ij,klab,mbkc->jla", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,mcka->jlb", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,mckb->lja", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,makc->ljb", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,mckb->jla", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,makc->jlb", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,mbkc->lja", delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,klab,mcka->ljb", delta_oo, t2, v.ovov) * 8
    r2 += lib.einsum("ij,klab,mckb->jla", delta_oo, t2, v.ovov) * -1
    r2 += lib.einsum("ij,klab,makc->jlb", delta_oo, t2, v.ovov) * -1
    r2 += lib.einsum("ij,klab,mbkc->lja", delta_oo, t2, v.ovov) * -1
    r2 += lib.einsum("ij,klab,mbkc->jla", delta_oo, t2, v.ovov) * -1
    r2 += lib.einsum("ij,klab,mcka->ljb", delta_oo, t2, v.ovov) * -4
    r2 += lib.einsum("ij,klab,mcka->jlb", delta_oo, t2, v.ovov) * -4
    r2 += lib.einsum("ij,klab,mckb->lja", delta_oo, t2, v.ovov) * -4
    r2 += lib.einsum("ij,klab,makc->ljb", delta_oo, t2, v.ovov) * -4
    r2 += lib.einsum("ij,kl,ma,bamc->ljb", delta_oo, delta_oo, t1, v.vvov)
    r2 += lib.einsum("ij,ab,kc,lckm->jma", delta_oo, delta_vv, t1, v.ovoo) * 2
    r2 += lib.einsum("ij,ka,lb,mbkc->jla", delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,lmkc->mja", delta_oo, delta_vv, t1, v.ooov) * 2
    r2 += lib.einsum("ij,ka,lb,mckb->lja", delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,lmkc->jma", delta_oo, delta_vv, t1, v.ooov) * 2
    r2 += lib.einsum("ij,ka,lb,mckb->jla", delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,lckm->mja", delta_oo, delta_vv, t1, v.ovoo) * 2
    r2 += lib.einsum("ij,ka,lb,mbkc->lja", delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,kl,ma,bcma->jlb", delta_oo, delta_oo, t1, v.vvov) * 4
    r2 += lib.einsum("ij,ka,lb,mckb->jla", delta_oo, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,ab,kc,lckm->mja", delta_oo, delta_vv, t1, v.ovoo) * -1
    r2 += lib.einsum("ij,ka,lb,mbkc->lja", delta_oo, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,ab,kc,lckm->jma", delta_oo, delta_vv, t1, v.ovoo) * -1
    r2 += lib.einsum("ij,ka,lb,mbkc->jla", delta_oo, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,kl,ma,bamc->jlb", delta_oo, delta_oo, t1, v.vvov) * -2
    r2 += lib.einsum("ij,kl,ma,bcma->ljb", delta_oo, delta_oo, t1, v.vvov) * -2
    r2 += lib.einsum("ij,ab,kc,lmkc->jma", delta_oo, delta_vv, t1, v.ooov) * -4
    r2 += lib.einsum("ij,ab,kc,lmkc->mja", delta_oo, delta_vv, t1, v.ooov) * -4
    r2 += lib.einsum("ij,ka,lb,mckb->lja", delta_oo, t1, t1, v.ovov) * -4
    r2 += lib.einsum("ab,ijcd,kcld->ija", delta_vv, t2, v.ovov) * 2
    r2 += lib.einsum("ab,ijcd,kdlc->ija", delta_vv, t2, v.ovov) * -1
    r2 += lib.einsum("ab,ic,jd,kcld->ija", delta_vv, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ab,ic,jd,kdlc->ija", delta_vv, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,ab,klcd,mckd->jla", delta_oo, delta_vv, t2, v.ovov) * 2
    r2 += lib.einsum("ij,ab,klcd,mdkc->lja", delta_oo, delta_vv, t2, v.ovov) * 2
    r2 += lib.einsum("ij,ab,klcd,mdkc->jla", delta_oo, delta_vv, t2, v.ovov) * 2
    r2 += lib.einsum("ij,ab,klcd,mckd->lja", delta_oo, delta_vv, t2, v.ovov) * 2
    r2 += lib.einsum("ij,ab,klcd,mckd->lja", delta_oo, delta_vv, t2, v.ovov) * -1
    r2 += lib.einsum("ij,ab,klcd,mckd->jla", delta_oo, delta_vv, t2, v.ovov) * -1
    r2 += lib.einsum("ij,ab,klcd,mdkc->jla", delta_oo, delta_vv, t2, v.ovov) * -4
    r2 += lib.einsum("ij,ab,klcd,mdkc->lja", delta_oo, delta_vv, t2, v.ovov) * -4
    r2 += lib.einsum("ij,ab,kc,ld,mckd->jla", delta_oo, delta_vv, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,ld,mdkc->lja", delta_oo, delta_vv, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,ld,mdkc->jla", delta_oo, delta_vv, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,ld,mckd->lja", delta_oo, delta_vv, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,ab,kc,ld,mckd->lja", delta_oo, delta_vv, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,ab,kc,ld,mckd->jla", delta_oo, delta_vv, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,ab,kc,ld,mdkc->jla", delta_oo, delta_vv, t1, t1, v.ovov) * -4
    r2 += lib.einsum("ij,ab,kc,ld,mdkc->lja", delta_oo, delta_vv, t1, t1, v.ovov) * -4
    r2 += lib.einsum("ij,ka,lmkb->jma", delta_oo, t1, v.ooov) * 2
    r2 += lib.einsum("ij,ka,lbkm->mja", delta_oo, t1, v.ovoo) * 2
    r2 += lib.einsum("ij,ka,lbkm->jma", delta_oo, t1, v.ovoo) * 2
    r2 += lib.einsum("ij,ka,lmkb->mja", delta_oo, t1, v.ooov) * 2
    r2 += lib.einsum("ij,ka,lbkm->jma", delta_oo, t1, v.ovoo) * -1
    r2 += lib.einsum("ij,ka,lmkb->mja", delta_oo, t1, v.ooov) * -1
    r2 += lib.einsum("ij,ka,lmkb->jma", delta_oo, t1, v.ooov) * -1
    r2 += lib.einsum("ij,ka,lbkm->mja", delta_oo, t1, v.ovoo) * -4
    r2 += lib.einsum("ij,kl,ma,mb->ljb", delta_oo, delta_oo, f.ov, t1)
    r2 += lib.einsum("ij,kl,ma,mb->jlb", delta_oo, delta_oo, f.ov, t1) * -2
    r2 += lib.einsum("ij,kabl->jlb", delta_oo, v.ovvo)
    r2 += lib.einsum("ij,klab->lja", delta_oo, v.oovv)
    r2 += lib.einsum("ij,klab->jla", delta_oo, v.oovv)
    r2 += lib.einsum("ab,ijkl->jla", delta_vv, v.oooo) * 2
    r2 += lib.einsum("ij,kabl->ljb", delta_oo, v.ovvo) * 4
    r2 += lib.einsum("ab,ijkl->lja", delta_vv, v.oooo) * -1
    r2 += lib.einsum("ij,klab->jla", delta_oo, v.oovv) * -2
    r2 += lib.einsum("ij,kabl->ljb", delta_oo, v.ovvo) * -2
    r2 += lib.einsum("ij,kabl->jlb", delta_oo, v.ovvo) * -2
    r2 += lib.einsum("ij,klab->lja", delta_oo, v.oovv) * -2
    r2 += lib.einsum("ij,ab,kl->lja", delta_oo, delta_vv, f.oo)
    r2 += lib.einsum("ij,ab,kl->jla", delta_oo, delta_vv, f.oo)
    r2 += lib.einsum("ij,kl,ab->jla", delta_oo, delta_oo, f.vv) * 2
    r2 += lib.einsum("ij,kl,ab->lja", delta_oo, delta_oo, f.vv) * -1
    r2 += lib.einsum("ij,ab,kl->jla", delta_oo, delta_vv, f.oo) * -2
    r2 += lib.einsum("ij,ab,kl->lja", delta_oo, delta_vv, f.oo) * -2
    r2 += lib.einsum("ijab,kblc->ija", t2, v.ovov) * 2
    r2 += lib.einsum("ijab,kcla->ijb", t2, v.ovov) * 2
    r2 += lib.einsum("ijab,kalc->ijb", t2, v.ovov) * -1
    r2 += lib.einsum("ijab,kclb->ija", t2, v.ovov) * -4
    r2 += lib.einsum("ij,ka,lbca->jkc", delta_oo, t1, v.ovvv)
    r2 += lib.einsum("ij,ka,labc->kjb", delta_oo, t1, v.ovvv)
    r2 += lib.einsum("ij,ka,labc->jkb", delta_oo, t1, v.ovvv)
    r2 += lib.einsum("ab,ic,jckl->ila", delta_vv, t1, v.ovoo) * 2
    r2 += lib.einsum("ab,ic,jklc->kia", delta_vv, t1, v.ooov) * 2
    r2 += lib.einsum("ij,ka,lbca->kjc", delta_oo, t1, v.ovvv) * 4
    r2 += lib.einsum("ab,ic,jklc->ika", delta_vv, t1, v.ooov) * -1
    r2 += lib.einsum("ab,ic,jckl->lia", delta_vv, t1, v.ovoo) * -1
    r2 += lib.einsum("ij,ka,labc->jkb", delta_oo, t1, v.ovvv) * -2
    r2 += lib.einsum("ij,ka,lbca->kjc", delta_oo, t1, v.ovvv) * -2
    r2 += lib.einsum("ij,ka,lbca->jkc", delta_oo, t1, v.ovvv) * -2
    r2 += lib.einsum("ij,ka,labc->kjb", delta_oo, t1, v.ovvv) * -2
    r2 += lib.einsum("ij,ab,kc,lc->lja", delta_oo, delta_vv, f.ov, t1)
    r2 += lib.einsum("ij,ab,kc,lc->jla", delta_oo, delta_vv, f.ov, t1)
    r2 += lib.einsum("ij,ab,kc,lc->jla", delta_oo, delta_vv, f.ov, t1) * -2
    r2 += lib.einsum("ij,ab,kc,lc->lja", delta_oo, delta_vv, f.ov, t1) * -2
    r2 += lib.einsum("ij,kl,mnab,ncmb->jla", delta_oo, delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,kl,mnab,mcnb->lja", delta_oo, delta_oo, t2, v.ovov) * 2
    r2 += lib.einsum("ij,kl,mnab,ncmb->lja", delta_oo, delta_oo, t2, v.ovov) * -1
    r2 += lib.einsum("ij,kl,mnab,mcnb->jla", delta_oo, delta_oo, t2, v.ovov) * -4
    r2 += lib.einsum("ij,kl,ma,nb,ncmb->jla", delta_oo, delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,kl,ma,nb,mcnb->lja", delta_oo, delta_oo, t1, t1, v.ovov) * 2
    r2 += lib.einsum("ij,kl,ma,nb,ncmb->lja", delta_oo, delta_oo, t1, t1, v.ovov) * -1
    r2 += lib.einsum("ij,kl,ma,nb,mcnb->jla", delta_oo, delta_oo, t1, t1, v.ovov) * -4

    return r1, r2

def hbar_diag_ea(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    r1 = np.zeros((nvir), dtype=np.float64)
    r1 += lib.einsum("ia,ib->b", f.ov, t1) * -1
    r1 += lib.einsum("ab->a", f.vv)
    r1 += lib.einsum("ijab,jcib->a", t2, v.ovov)
    r1 += lib.einsum("ijab,icjb->a", t2, v.ovov) * -2
    r1 += lib.einsum("ia,jb,jcib->a", t1, t1, v.ovov)
    r1 += lib.einsum("ia,jb,icjb->a", t1, t1, v.ovov) * -2
    r1 += lib.einsum("ia,bcia->b", t1, v.vvov) * 2
    r1 += lib.einsum("ia,baic->b", t1, v.vvov) * -1

    r2 = np.zeros((nvir,  nvir,  nocc), dtype=np.float64)
    r2 += lib.einsum("ab,cd,ijef,ifke->daj", delta_vv, delta_vv, t2, v.ovov)
    r2 += lib.einsum("ab,cd,ijef,iekf->daj", delta_vv, delta_vv, t2, v.ovov) * 4
    r2 += lib.einsum("ab,cd,ijef,iekf->daj", delta_vv, delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,cd,ijef,ifke->daj", delta_vv, delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,cd,ie,jf,jekf->dai", delta_vv, delta_vv, t1, t1, v.ovov)
    r2 += lib.einsum("ab,cd,ie,jf,jfke->dai", delta_vv, delta_vv, t1, t1, v.ovov) * 4
    r2 += lib.einsum("ab,cd,ie,jf,jfke->dai", delta_vv, delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,cd,ie,jf,jekf->dai", delta_vv, delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,iekd->caj", delta_vv, t2, v.ovov)
    r2 += lib.einsum("ab,ijcd,idke->bcj", delta_vv, t2, v.ovov)
    r2 += lib.einsum("ab,ijcd,iekc->bdj", delta_vv, t2, v.ovov)
    r2 += lib.einsum("ab,ijcd,iekd->bcj", delta_vv, t2, v.ovov)
    r2 += lib.einsum("ab,ijcd,icke->daj", delta_vv, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ijcd,iekc->daj", delta_vv, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ijcd,idke->caj", delta_vv, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ijcd,icke->bdj", delta_vv, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ijcd,iekc->daj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,idke->caj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,iekd->caj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,iekd->bcj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,icke->bdj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,idke->bcj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,iekc->bdj", delta_vv, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ijcd,icke->daj", delta_vv, t2, v.ovov) * -8
    r2 += lib.einsum("ab,cd,ie,ijke->daj", delta_vv, delta_vv, t1, v.ooov)
    r2 += lib.einsum("ab,ic,jd,jekc->dai", delta_vv, t1, t1, v.ovov)
    r2 += lib.einsum("ab,ic,jd,jcke->bdi", delta_vv, t1, t1, v.ovov)
    r2 += lib.einsum("ab,ic,jd,jekc->bdi", delta_vv, t1, t1, v.ovov)
    r2 += lib.einsum("ab,ij,kc,dekc->dai", delta_vv, delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ij,kc,dcke->dai", delta_vv, delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ij,kc,dcke->bdi", delta_vv, delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ij,kc,dekc->bdi", delta_vv, delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ab,cd,ie,iejk->dak", delta_vv, delta_vv, t1, v.ovoo) * 4
    r2 += lib.einsum("ab,ic,jd,jcke->dai", delta_vv, t1, t1, v.ovov) * 4
    r2 += lib.einsum("ab,ij,kc,dcke->dai", delta_vv, delta_oo, t1, v.vvov) * -1
    r2 += lib.einsum("ab,ij,kc,dcke->bdi", delta_vv, delta_oo, t1, v.vvov) * -1
    r2 += lib.einsum("ab,cd,ie,iejk->dak", delta_vv, delta_vv, t1, v.ovoo) * -2
    r2 += lib.einsum("ab,ic,jd,jcke->dai", delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,cd,ie,ijke->daj", delta_vv, delta_vv, t1, v.ooov) * -2
    r2 += lib.einsum("ab,ic,jd,jekc->dai", delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ic,jd,jekc->bdi", delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ic,jd,jcke->bdi", delta_vv, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ij,kc,dekc->dai", delta_vv, delta_oo, t1, v.vvov) * -4
    r2 += lib.einsum("ab,ij,kc,dekc->bdi", delta_vv, delta_oo, t1, v.vvov) * -4
    r2 += lib.einsum("ab,ij,klcd,lekd->cai", delta_vv, delta_oo, t2, v.ovov)
    r2 += lib.einsum("ab,ij,klcd,lekd->bci", delta_vv, delta_oo, t2, v.ovov)
    r2 += lib.einsum("ab,ij,klcd,keld->cai", delta_vv, delta_oo, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ij,klcd,keld->bci", delta_vv, delta_oo, t2, v.ovov) * 4
    r2 += lib.einsum("ab,ij,klcd,keld->cai", delta_vv, delta_oo, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ij,klcd,lekd->cai", delta_vv, delta_oo, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ij,klcd,lekd->bci", delta_vv, delta_oo, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ij,klcd,keld->bci", delta_vv, delta_oo, t2, v.ovov) * -2
    r2 += lib.einsum("ab,ij,kc,ld,lekd->cai", delta_vv, delta_oo, t1, t1, v.ovov)
    r2 += lib.einsum("ab,ij,kc,ld,lekd->bci", delta_vv, delta_oo, t1, t1, v.ovov)
    r2 += lib.einsum("ab,ij,kc,ld,keld->cai", delta_vv, delta_oo, t1, t1, v.ovov) * 4
    r2 += lib.einsum("ab,ij,kc,ld,keld->bci", delta_vv, delta_oo, t1, t1, v.ovov) * 4
    r2 += lib.einsum("ab,ij,kc,ld,keld->cai", delta_vv, delta_oo, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ij,kc,ld,lekd->cai", delta_vv, delta_oo, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ij,kc,ld,lekd->bci", delta_vv, delta_oo, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ab,ij,kc,ld,keld->bci", delta_vv, delta_oo, t1, t1, v.ovov) * -2
    r2 += lib.einsum("ij,abcd->cai", delta_oo, v.vvvv)
    r2 += lib.einsum("ab,cijd->cai", delta_vv, v.voov) * 2
    r2 += lib.einsum("ab,cdij->caj", delta_vv, v.vvoo) * 2
    r2 += lib.einsum("ab,cdij->bcj", delta_vv, v.vvoo) * 2
    r2 += lib.einsum("ab,cijd->bci", delta_vv, v.voov) * 2
    r2 += lib.einsum("ab,cdij->caj", delta_vv, v.vvoo) * -1
    r2 += lib.einsum("ab,cijd->bci", delta_vv, v.voov) * -1
    r2 += lib.einsum("ab,cdij->bcj", delta_vv, v.vvoo) * -1
    r2 += lib.einsum("ij,abcd->cai", delta_oo, v.vvvv) * -2
    r2 += lib.einsum("ab,cijd->cai", delta_vv, v.voov) * -4
    r2 += lib.einsum("ab,ij,cd->cai", delta_vv, delta_oo, f.vv)
    r2 += lib.einsum("ab,ij,cd->bci", delta_vv, delta_oo, f.vv)
    r2 += lib.einsum("ab,cd,ij->daj", delta_vv, delta_vv, f.oo) * 2
    r2 += lib.einsum("ab,cd,ij->daj", delta_vv, delta_vv, f.oo) * -1
    r2 += lib.einsum("ab,ij,cd->cai", delta_vv, delta_oo, f.vv) * -2
    r2 += lib.einsum("ab,ij,cd->bci", delta_vv, delta_oo, f.vv) * -2
    r2 += lib.einsum("ab,ic,dcje->dai", delta_vv, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ic,dejc->dai", delta_vv, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ic,dejc->bdi", delta_vv, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ic,dcje->bdi", delta_vv, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ic,dejc->dai", delta_vv, t1, v.vvov) * -1
    r2 += lib.einsum("ab,ic,dcje->bdi", delta_vv, t1, v.vvov) * -1
    r2 += lib.einsum("ab,ic,dejc->bdi", delta_vv, t1, v.vvov) * -1
    r2 += lib.einsum("ab,ic,dcje->dai", delta_vv, t1, v.vvov) * -4
    r2 += lib.einsum("ab,cd,ie,je->daj", delta_vv, delta_vv, f.ov, t1) * 2
    r2 += lib.einsum("ab,cd,ie,je->daj", delta_vv, delta_vv, f.ov, t1) * -1
    r2 += lib.einsum("ijab,ickd->abj", t2, v.ovov)
    r2 += lib.einsum("ijab,ickd->baj", t2, v.ovov) * 4
    r2 += lib.einsum("ijab,ickd->baj", t2, v.ovov) * -2
    r2 += lib.einsum("ijab,ickd->abj", t2, v.ovov) * -2
    r2 += lib.einsum("ab,ic,idjk->cak", delta_vv, t1, v.ovoo)
    r2 += lib.einsum("ab,ic,ijkd->bcj", delta_vv, t1, v.ooov)
    r2 += lib.einsum("ab,ic,idjk->bck", delta_vv, t1, v.ovoo)
    r2 += lib.einsum("ij,ka,bckd->bai", delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ij,ka,bckd->abi", delta_oo, t1, v.vvov) * 2
    r2 += lib.einsum("ab,ic,ijkd->caj", delta_vv, t1, v.ooov) * 4
    r2 += lib.einsum("ij,ka,bckd->bai", delta_oo, t1, v.vvov) * -1
    r2 += lib.einsum("ij,ka,bckd->abi", delta_oo, t1, v.vvov) * -1
    r2 += lib.einsum("ab,ic,ijkd->caj", delta_vv, t1, v.ooov) * -2
    r2 += lib.einsum("ab,ic,idjk->cak", delta_vv, t1, v.ovoo) * -2
    r2 += lib.einsum("ab,ic,idjk->bck", delta_vv, t1, v.ovoo) * -2
    r2 += lib.einsum("ab,ic,ijkd->bcj", delta_vv, t1, v.ooov) * -2
    r2 += lib.einsum("ab,ij,kc,kd->dai", delta_vv, delta_oo, f.ov, t1) * 2
    r2 += lib.einsum("ab,ij,kc,kd->bdi", delta_vv, delta_oo, f.ov, t1) * 2
    r2 += lib.einsum("ab,ij,kc,kd->dai", delta_vv, delta_oo, f.ov, t1) * -1
    r2 += lib.einsum("ab,ij,kc,kd->bdi", delta_vv, delta_oo, f.ov, t1) * -1
    r2 += lib.einsum("ij,klab,kcld->bai", delta_oo, t2, v.ovov)
    r2 += lib.einsum("ij,klab,lckd->bai", delta_oo, t2, v.ovov) * -2
    r2 += lib.einsum("ij,ka,lb,kcld->bai", delta_oo, t1, t1, v.ovov)
    r2 += lib.einsum("ij,ka,lb,lckd->bai", delta_oo, t1, t1, v.ovov) * -2

    r2 = r2.swapaxes(0, 1)

    return r1, r2

def hbar_matvec_ip(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, r1=None, r2=None, **kwargs):
    x0 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("i,jaib->jab", r1, v.ovov)
    x1 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("iab->iab", x0) * 2
    x1 += lib.einsum("iab->iba", x0) * -1
    r1new = np.zeros((nocc), dtype=np.float64)
    r1new += lib.einsum("iab,ijab->j", x1, t2) * -1
    del x1
    x29 = np.zeros((nvir, nvir, nvir), dtype=np.float64)
    x29 += lib.einsum("ia,ibc->acb", t1, x0)
    del x0
    x30 = np.zeros((nvir, nvir, nvir), dtype=np.float64)
    x30 += lib.einsum("abc->abc", x29) * -1
    del x29
    x2 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x2 += lib.einsum("ija->ija", r2) * 2
    x2 += lib.einsum("i,ja->ija", r1, t1)
    x9 = np.zeros((nvir), dtype=np.float64)
    x9 += lib.einsum("ija,jbia->b", x2, v.ovov) * -0.5
    x96 = np.zeros((nvir), dtype=np.float64)
    x96 += lib.einsum("ija,jbia->b", x2, v.ovov)
    x97 = np.zeros((nvir), dtype=np.float64)
    x97 += lib.einsum("a->a", x96) * -1
    del x96
    r1new += lib.einsum("ija,jkia->k", x2, v.ooov)
    del x2
    x3 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x3 += lib.einsum("ija->ija", r2) * 0.5
    x3 += lib.einsum("i,ja->ija", r1, t1)
    x9 += lib.einsum("ija,jaib->b", x3, v.ovov)
    x95 = np.zeros((nvir), dtype=np.float64)
    x95 += lib.einsum("ija,jaib->b", x3, v.ovov) * 2
    x97 += lib.einsum("a->a", x95)
    del x95
    r1new += lib.einsum("ija,ikja->k", x3, v.ooov) * -2
    del x3
    x4 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x4 += lib.einsum("iajb->jiab", v.ovov)
    x4 += lib.einsum("iajb->jiba", v.ovov) * -0.5
    x5 = np.zeros((nocc, nvir), dtype=np.float64)
    x5 += lib.einsum("ia,ijba->jb", t1, x4) * 2
    x6 = np.zeros((nocc, nvir), dtype=np.float64)
    x6 += lib.einsum("ia->ia", x5)
    del x5
    x58 = np.zeros((nocc, nvir), dtype=np.float64)
    x58 += lib.einsum("ia,ijba->jb", t1, x4)
    del x4
    x59 = np.zeros((nocc, nvir), dtype=np.float64)
    x59 += lib.einsum("ia->ia", x58)
    del x58
    x6 += lib.einsum("ia->ia", f.ov)
    x92 = np.zeros((nvir, nvir), dtype=np.float64)
    x92 += lib.einsum("ia,ib->ab", t1, x6)
    x93 = np.zeros((nvir, nvir), dtype=np.float64)
    x93 += lib.einsum("ab->ab", x92)
    del x92
    x7 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x7 += lib.einsum("ija->ija", r2) * 2
    x7 += lib.einsum("ija->jia", r2) * -1
    r1new += lib.einsum("ia,ija->j", x6, x7) * -1
    del x6
    del x7
    x8 = np.zeros((nvir), dtype=np.float64)
    x8 += lib.einsum("i,ia->a", r1, f.ov)
    x9 += lib.einsum("a->a", x8) * 0.5
    r1new += lib.einsum("a,ia->i", x9, t1) * -2
    del x9
    x97 += lib.einsum("a->a", x8)
    del x8
    x98 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x98 += lib.einsum("a,ijab->ijb", x97, t2) * 2
    del x97
    x108 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x108 += lib.einsum("ija->jia", x98)
    del x98
    x10 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x10 += lib.einsum("ij,kia->jka", f.oo, r2)
    x73 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x73 += lib.einsum("ija->ija", x10)
    del x10
    x11 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x11 += lib.einsum("i,ijak->jka", r1, v.oovo)
    x73 += lib.einsum("ija->ija", x11) * -1
    del x11
    x12 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x12 += lib.einsum("ija,ikba->jkb", r2, v.oovv)
    x73 += lib.einsum("ija->ija", x12)
    del x12
    x13 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x13 += lib.einsum("i,jkia->jka", r1, v.ooov)
    x14 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x14 += lib.einsum("ija,kiab->kjb", x13, t2)
    del x13
    x73 += lib.einsum("ija->ija", x14)
    del x14
    x15 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x15 += lib.einsum("ia,jkla->ijlk", t1, v.ooov)
    x16 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x16 += lib.einsum("ija,kijl->kla", r2, x15)
    del x15
    x73 += lib.einsum("ija->ija", x16) * -1
    del x16
    x17 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x17 += lib.einsum("ija,ibka->jkb", r2, v.ovov)
    x20 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x20 += lib.einsum("ija->ija", x17) * -1
    x37 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x37 += lib.einsum("ija->ija", x17) * 0.5
    del x17
    x18 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x18 += lib.einsum("i,ja->ija", r1, t1) * 0.5
    x18 += lib.einsum("ija->ija", r2)
    x18 += lib.einsum("ija->jia", r2) * -0.5
    x19 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x19 += lib.einsum("ija,iakb->kjb", x18, v.ovov) * 2
    x20 += lib.einsum("ija->jia", x19)
    del x19
    x34 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x34 += lib.einsum("ija,klia->klj", x18, v.ooov) * 2
    x39 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x39 += lib.einsum("ijk->ijk", x34)
    del x34
    x42 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x42 += lib.einsum("ija,iabc->jbc", x18, v.ovvv) * 2
    del x18
    x43 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x43 += lib.einsum("iab->iab", x42)
    del x42
    x21 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x21 += lib.einsum("ijab->jiab", t2)
    x21 += lib.einsum("ijab->jiba", t2) * -0.5
    x22 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x22 += lib.einsum("ija,jkba->ikb", x20, x21) * 2
    del x20
    x73 += lib.einsum("ija->ija", x22) * -1
    del x22
    x23 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x23 += lib.einsum("i,ja->ija", r1, t1)
    x23 += lib.einsum("ija->ija", r2) * 2
    x23 += lib.einsum("ija->jia", r2) * -1
    x24 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x24 += lib.einsum("ija,iabk->kjb", x23, v.ovvo)
    del x23
    x73 += lib.einsum("ija->jia", x24) * -1
    del x24
    x25 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x25 += lib.einsum("ija->ija", r2)
    x25 += lib.einsum("i,ja->jia", r1, t1) * -1
    x26 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x26 += lib.einsum("ija,jbka->kib", x25, v.ovov)
    x27 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x27 += lib.einsum("ija,ikab->kjb", x26, t2)
    x73 += lib.einsum("ija->jia", x27) * -1
    del x27
    x81 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x81 += lib.einsum("ija,ikba->kjb", x26, t2) * 2
    del x26
    x108 += lib.einsum("ija->jia", x81)
    del x81
    x100 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x100 += lib.einsum("ija,jkba->kib", x25, v.oovv) * 2
    x108 += lib.einsum("ija->jia", x100) * -1
    del x100
    x103 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x103 += lib.einsum("ija,jkla->lki", x25, v.ooov)
    del x25
    x104 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x104 += lib.einsum("ijk->kij", x103)
    del x103
    x28 = np.zeros((nvir, nvir, nvir), dtype=np.float64)
    x28 += lib.einsum("i,iabc->bac", r1, v.ovvv)
    x30 += lib.einsum("abc->abc", x28)
    del x28
    x31 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x31 += lib.einsum("abc,ijcb->ija", x30, t2)
    del x30
    x73 += lib.einsum("ija->jia", x31) * -1
    del x31
    x32 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x32 += lib.einsum("i,jkil->jkl", r1, v.oooo)
    x39 += lib.einsum("ijk->ijk", x32)
    del x32
    x33 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x33 += lib.einsum("ija,ikla->jlk", r2, v.ooov)
    x39 += lib.einsum("ijk->jki", x33) * -1
    del x33
    x35 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x35 += lib.einsum("i,ja->ija", r1, t1) * 0.9999999999999996
    x35 += lib.einsum("ija->ija", r2) * 2
    x35 += lib.einsum("ija->jia", r2) * -1
    x36 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x36 += lib.einsum("ija,iakb->kjb", x35, v.ovov) * 0.5
    del x35
    x37 += lib.einsum("ija->jia", x36) * -1
    del x36
    x38 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x38 += lib.einsum("ia,jka->ijk", t1, x37) * 2
    del x37
    x39 += lib.einsum("ijk->kij", x38) * -1
    del x38
    x40 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x40 += lib.einsum("ia,ijk->jka", t1, x39)
    del x39
    x73 += lib.einsum("ija->jia", x40)
    del x40
    x41 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x41 += lib.einsum("ija,ibca->jcb", r2, v.ovvv)
    x43 += lib.einsum("iab->iab", x41) * -1
    del x41
    x44 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x44 += lib.einsum("ia,jba->ijb", t1, x43)
    del x43
    x73 += lib.einsum("ija->jia", x44) * -1
    del x44
    x45 = np.zeros((nocc, nocc), dtype=np.float64)
    x45 += lib.einsum("ia,ja->ij", f.ov, t1)
    x51 = np.zeros((nocc, nocc), dtype=np.float64)
    x51 += lib.einsum("ij->ij", x45)
    del x45
    x46 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x46 += lib.einsum("iajb->jiab", v.ovov) * -0.5
    x46 += lib.einsum("iajb->jiba", v.ovov)
    x63 = np.zeros((nocc, nocc), dtype=np.float64)
    x63 += lib.einsum("ijab,ikab->jk", t2, x46) * 2
    x67 = np.zeros((nocc, nocc), dtype=np.float64)
    x67 += lib.einsum("ij->ji", x63)
    del x63
    x89 = np.zeros((nvir, nvir), dtype=np.float64)
    x89 += lib.einsum("ijab,ijcb->ac", t2, x46) * 2
    x93 += lib.einsum("ab->ab", x89)
    del x89
    x47 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x47 += lib.einsum("ijab->jiba", t2)
    x47 += lib.einsum("ia,jb->ijab", t1, t1)
    x48 = np.zeros((nocc, nocc), dtype=np.float64)
    x48 += lib.einsum("ijab,ikab->jk", x46, x47) * 2
    del x46
    del x47
    x51 += lib.einsum("ij->ij", x48)
    del x48
    x49 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x49 += lib.einsum("ijka->ikja", v.ooov)
    x49 += lib.einsum("ijka->kija", v.ooov) * -0.5
    x50 = np.zeros((nocc, nocc), dtype=np.float64)
    x50 += lib.einsum("ia,jika->jk", t1, x49) * 2
    del x49
    x51 += lib.einsum("ij->ij", x50)
    x52 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x52 += lib.einsum("ij,ika->kja", x51, r2)
    x73 += lib.einsum("ija->ija", x52)
    del x52
    x99 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x99 += lib.einsum("ij,kia->kja", x51, r2) * 2
    del x51
    x108 += lib.einsum("ija->ija", x99) * -1
    del x99
    x67 += lib.einsum("ij->ij", x50)
    del x50
    x53 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x53 += lib.einsum("ia,jakb->ikjb", t1, v.ovov)
    x54 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x54 += lib.einsum("ijka->ijka", x53) * 2
    x54 += lib.einsum("ijka->ikja", x53) * -1
    x85 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x85 += lib.einsum("ijka->kjia", x53)
    del x53
    x54 += lib.einsum("ijka->jika", v.ooov) * -1
    x54 += lib.einsum("ijka->jkia", v.ooov) * 2
    x55 = np.zeros((nocc, nvir), dtype=np.float64)
    x55 += lib.einsum("ijab,kjib->ka", t2, x54)
    del x54
    x72 = np.zeros((nocc, nvir), dtype=np.float64)
    x72 += lib.einsum("ia->ia", x55) * -1
    del x55
    x56 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x56 += lib.einsum("iabc->ibac", v.ovvv) * -0.5
    x56 += lib.einsum("iabc->ibca", v.ovvv)
    x57 = np.zeros((nocc, nvir), dtype=np.float64)
    x57 += lib.einsum("ijab,icba->jc", t2, x56) * 2
    x72 += lib.einsum("ia->ia", x57)
    del x57
    x69 = np.zeros((nvir, nvir), dtype=np.float64)
    x69 += lib.einsum("ia,ibca->bc", t1, x56) * 2
    del x56
    x70 = np.zeros((nvir, nvir), dtype=np.float64)
    x70 += lib.einsum("ab->ab", x69)
    del x69
    x59 += lib.einsum("ia->ia", f.ov) * 0.5
    x60 = np.zeros((nocc, nvir), dtype=np.float64)
    x60 += lib.einsum("ia,ijba->jb", x59, x21) * 4
    del x59
    del x21
    x72 += lib.einsum("ia->ia", x60)
    del x60
    x61 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x61 += lib.einsum("iabj->ijba", v.ovvo)
    x61 += lib.einsum("ijab->ijab", v.oovv) * -0.5
    x62 = np.zeros((nocc, nvir), dtype=np.float64)
    x62 += lib.einsum("ia,ijba->jb", t1, x61) * 2
    del x61
    x72 += lib.einsum("ia->ia", x62)
    del x62
    x64 = np.zeros((nocc, nvir), dtype=np.float64)
    x64 += lib.einsum("ia,jaib->jb", t1, v.ovov)
    x65 = np.zeros((nocc, nvir), dtype=np.float64)
    x65 += lib.einsum("ia->ia", x64) * -0.9999999999999996
    del x64
    x65 += lib.einsum("ia->ia", f.ov)
    x66 = np.zeros((nocc, nocc), dtype=np.float64)
    x66 += lib.einsum("ia,ja->ij", t1, x65)
    del x65
    x67 += lib.einsum("ij->ji", x66)
    del x66
    x68 = np.zeros((nocc, nvir), dtype=np.float64)
    x68 += lib.einsum("ia,ij->ja", t1, x67)
    del x67
    x72 += lib.einsum("ia->ia", x68) * -1
    del x68
    x70 += lib.einsum("ab->ab", f.vv)
    x71 = np.zeros((nocc, nvir), dtype=np.float64)
    x71 += lib.einsum("ia,ba->ib", t1, x70)
    del x70
    x72 += lib.einsum("ia->ia", x71)
    del x71
    x73 += lib.einsum("i,ja->ija", r1, x72)
    del x72
    r2new = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    r2new += lib.einsum("ija->ija", x73)
    r2new += lib.einsum("ija->jia", x73) * -2
    del x73
    x74 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x74 += lib.einsum("ij,ika->jka", f.oo, r2)
    x108 += lib.einsum("ija->ija", x74) * -2
    del x74
    x75 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x75 += lib.einsum("i,ijka->kja", r1, v.ooov)
    x76 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x76 += lib.einsum("ija,kiab->kjb", x75, t2)
    del x75
    x108 += lib.einsum("ija->ija", x76) * -2
    del x76
    x77 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x77 += lib.einsum("ija,jbca->icb", r2, v.ovvv)
    x78 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x78 += lib.einsum("ia,jba->jib", t1, x77)
    del x77
    x108 += lib.einsum("ija->ija", x78) * -2
    del x78
    x79 = np.zeros((nvir, nvir, nvir), dtype=np.float64)
    x79 += lib.einsum("ija,ibjc->abc", r2, v.ovov)
    x80 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x80 += lib.einsum("abc,ijbc->ija", x79, t2)
    del x79
    x108 += lib.einsum("ija->ija", x80) * 2
    del x80
    x82 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x82 += lib.einsum("ijka->ikja", v.ooov) * -0.5
    x82 += lib.einsum("ijka->kija", v.ooov)
    x83 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x83 += lib.einsum("i,jika->jka", r1, x82)
    del x82
    x84 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x84 += lib.einsum("ija,ikab->kjb", x83, t2) * 4
    del x83
    x108 += lib.einsum("ija->ija", x84)
    del x84
    x85 += lib.einsum("ijka->ikja", v.ooov)
    x86 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x86 += lib.einsum("ia,jkla->ijkl", t1, x85)
    del x85
    x87 = np.zeros((nocc, nocc, nocc, nocc), dtype=np.float64)
    x87 += lib.einsum("ijkl->kjil", x86)
    del x86
    x87 += lib.einsum("ijkl->kilj", v.oooo)
    x88 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x88 += lib.einsum("ija,ijkl->kla", r2, x87) * 2
    del x87
    x108 += lib.einsum("ija->ija", x88)
    del x88
    x90 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x90 += lib.einsum("iabc->ibac", v.ovvv) * -1
    x90 += lib.einsum("iabc->ibca", v.ovvv) * 2
    x91 = np.zeros((nvir, nvir), dtype=np.float64)
    x91 += lib.einsum("ia,ibca->bc", t1, x90)
    del x90
    x93 += lib.einsum("ab->ab", x91) * -1
    del x91
    x93 += lib.einsum("ab->ab", f.vv) * -1
    x94 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x94 += lib.einsum("ab,ijb->ija", x93, r2) * 2
    del x93
    x108 += lib.einsum("ija->ija", x94) * -1
    del x94
    x101 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x101 += lib.einsum("ija,jbka->ikb", r2, v.ovov)
    x102 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x102 += lib.einsum("ia,jka->jik", t1, x101)
    del x101
    x104 += lib.einsum("ijk->ikj", x102)
    del x102
    x105 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x105 += lib.einsum("ia,jik->jka", t1, x104) * 2
    del x104
    x108 += lib.einsum("ija->ija", x105)
    del x105
    x106 = np.zeros((nocc, nvir), dtype=np.float64)
    x106 += lib.einsum("ij,ia->ja", f.oo, t1)
    x107 = np.zeros((nocc, nvir), dtype=np.float64)
    x107 += lib.einsum("ia->ia", x106) * -1
    del x106
    x107 += lib.einsum("ai->ia", f.vo)
    x108 += lib.einsum("i,ja->jia", r1, x107) * -2
    del x107
    r2new += lib.einsum("ija->ija", x108)
    r2new += lib.einsum("ija->jia", x108) * -0.5
    del x108
    x109 = np.zeros((nocc, nvir), dtype=np.float64)
    x109 += lib.einsum("ia,jbia->jb", t1, v.ovov)
    x110 = np.zeros((nocc, nocc), dtype=np.float64)
    x110 += lib.einsum("ia,ja->ij", t1, x109)
    del x109
    x111 = np.zeros((nocc, nvir), dtype=np.float64)
    x111 += lib.einsum("ia,ji->ja", t1, x110)
    del x110
    r2new += lib.einsum("i,ja->ija", r1, x111) * -1.9999999999999991
    r2new += lib.einsum("i,ja->jia", r1, x111) * 3.999999999999999
    del x111
    r1new += lib.einsum("i,ij->j", r1, f.oo) * -1

    return r1new, r2new

def hbar_matvec_ea(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, r1=None, r2=None, **kwargs):
    x0 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("abi->iab", r2) * 2
    x0 += lib.einsum("a,ib->iab", r1, t1) * -1
    x9 = np.zeros((nocc), dtype=np.float64)
    x9 += lib.einsum("iab,iajb->j", x0, v.ovov)
    x11 = np.zeros((nocc), dtype=np.float64)
    x11 += lib.einsum("i->i", x9)
    del x9
    r1new = np.zeros((nvir), dtype=np.float64)
    r1new += lib.einsum("iab,iacb->c", x0, v.ovvv)
    del x0
    x1 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("a,ib->iab", r1, t1)
    x1 += lib.einsum("abi->iab", r2) * -0.5
    x10 = np.zeros((nocc), dtype=np.float64)
    x10 += lib.einsum("iab,ibja->j", x1, v.ovov) * 2
    x11 += lib.einsum("i->i", x10)
    del x10
    r1new += lib.einsum("iab,ibca->c", x1, v.ovvv) * 2
    del x1
    x2 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x2 += lib.einsum("a,ibja->ijb", r1, v.ovov)
    x3 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x3 += lib.einsum("ija->ija", x2) * -1
    x3 += lib.einsum("ija->jia", x2) * 2
    r1new += lib.einsum("ija,ijba->b", x3, t2) * -1
    del x3
    x60 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x60 += lib.einsum("ia,jka->ikj", t1, x2)
    del x2
    x61 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x61 += lib.einsum("ijk,jkab->iab", x60, t2)
    x97 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x97 += lib.einsum("iab->iab", x61) * -1
    del x61
    x79 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x79 += lib.einsum("ia,jki->jka", t1, x60)
    del x60
    x80 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x80 += lib.einsum("ija->jia", x79) * -0.9999999999999996
    del x79
    x4 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x4 += lib.einsum("iajb->jiab", v.ovov)
    x4 += lib.einsum("iajb->jiba", v.ovov) * -0.5
    x5 = np.zeros((nocc, nvir), dtype=np.float64)
    x5 += lib.einsum("ia,ijba->jb", t1, x4) * 2
    del x4
    x6 = np.zeros((nocc, nvir), dtype=np.float64)
    x6 += lib.einsum("ia->ia", x5)
    del x5
    x6 += lib.einsum("ia->ia", f.ov)
    x37 = np.zeros((nvir, nvir), dtype=np.float64)
    x37 += lib.einsum("ia,ib->ab", t1, x6)
    x38 = np.zeros((nvir, nvir), dtype=np.float64)
    x38 += lib.einsum("ab->ab", x37)
    del x37
    x7 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x7 += lib.einsum("abi->iab", r2) * -0.5
    x7 += lib.einsum("abi->iba", r2)
    r1new += lib.einsum("ia,iba->b", x6, x7) * 2
    del x7
    x8 = np.zeros((nocc), dtype=np.float64)
    x8 += lib.einsum("a,ia->i", r1, f.ov)
    x11 += lib.einsum("i->i", x8)
    del x8
    x47 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x47 += lib.einsum("i,ijab->jab", x11, t2) * 2
    x55 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x55 += lib.einsum("iab->iba", x47) * -1
    del x47
    r1new += lib.einsum("i,ia->a", x11, t1) * -1
    del x11
    x12 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x12 += lib.einsum("ab,bci->iac", f.vv, r2)
    x55 += lib.einsum("iab->iab", x12) * 2
    del x12
    x13 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x13 += lib.einsum("a,bica->ibc", r1, v.vovv)
    x55 += lib.einsum("iab->iab", x13) * 2
    del x13
    x14 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x14 += lib.einsum("abi,cadb->icd", r2, v.vvvv)
    x55 += lib.einsum("iab->iab", x14) * 2
    del x14
    x15 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x15 += lib.einsum("a,iabc->ibc", r1, v.ovvv)
    x16 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x16 += lib.einsum("iab,jicb->jca", x15, t2)
    x55 += lib.einsum("iab->iab", x16) * -2
    del x16
    x59 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x59 += lib.einsum("iab,jibc->jca", x15, t2)
    x97 += lib.einsum("iab->iab", x59)
    del x59
    x78 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x78 += lib.einsum("ia,jba->ijb", t1, x15)
    del x15
    x80 += lib.einsum("ija->jia", x78)
    del x78
    x17 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x17 += lib.einsum("ia,jabc->ijbc", t1, v.ovvv)
    x21 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x21 += lib.einsum("ijab->ijab", x17)
    del x17
    x18 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x18 += lib.einsum("ia,jbka->ijkb", t1, v.ovov)
    x19 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x19 += lib.einsum("ijka->ijka", x18)
    x82 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x82 += lib.einsum("ijka->ijka", x18) * -0.5
    x82 += lib.einsum("ijka->ikja", x18)
    del x18
    x19 += lib.einsum("ijka->jkia", v.ooov)
    x20 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x20 += lib.einsum("ia,jikb->jkab", t1, x19)
    x21 += lib.einsum("ijab->ijab", x20) * -1
    del x20
    x70 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x70 += lib.einsum("ia,jkib->jkab", t1, x19)
    del x19
    x71 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x71 += lib.einsum("ijab->ijab", x70) * -1
    del x70
    x21 += lib.einsum("ijab->jiab", v.oovv)
    x22 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x22 += lib.einsum("abi,jicb->jac", r2, x21) * 2
    x55 += lib.einsum("iab->iab", x22) * -1
    del x22
    x73 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x73 += lib.einsum("abi,jica->jbc", r2, x21)
    del x21
    x97 += lib.einsum("iab->iab", x73)
    del x73
    x23 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x23 += lib.einsum("a,ibca->icb", r1, v.ovvv)
    x24 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x24 += lib.einsum("ia,jb->ijab", t1, t1)
    x24 += lib.einsum("ijab->jiab", t2) * -2
    x24 += lib.einsum("ijab->jiba", t2)
    x25 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x25 += lib.einsum("iab,ijcb->jac", x23, x24) * 2
    del x24
    del x23
    x55 += lib.einsum("iab->iba", x25) * -1
    del x25
    x26 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x26 += lib.einsum("a,ijka->ikj", r1, v.ooov)
    x28 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x28 += lib.einsum("ijk->ijk", x26)
    del x26
    x27 = np.zeros((nocc, nocc, nocc), dtype=np.float64)
    x27 += lib.einsum("abi,jakb->ijk", r2, v.ovov)
    x28 += lib.einsum("ijk->jki", x27)
    del x27
    x29 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x29 += lib.einsum("ijk,ijab->kab", x28, t2) * 2
    x55 += lib.einsum("iab->iab", x29)
    del x29
    x50 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x50 += lib.einsum("ia,jik->jka", t1, x28)
    del x28
    x51 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x51 += lib.einsum("ija->ija", x50) * -1
    del x50
    x30 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x30 += lib.einsum("abi->iab", r2)
    x30 += lib.einsum("a,ib->iba", r1, t1)
    x31 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x31 += lib.einsum("iab,icjb->jca", x30, v.ovov)
    del x30
    x32 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x32 += lib.einsum("iab,ijca->jcb", x31, t2) * 2
    x55 += lib.einsum("iab->iba", x32)
    del x32
    x74 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x74 += lib.einsum("iab,ijac->jcb", x31, t2)
    del x31
    x97 += lib.einsum("iab->iba", x74) * -1
    del x74
    x33 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x33 += lib.einsum("iajb->jiab", v.ovov) * -0.5
    x33 += lib.einsum("iajb->jiba", v.ovov)
    x34 = np.zeros((nvir, nvir), dtype=np.float64)
    x34 += lib.einsum("ijab,ijcb->ac", t2, x33) * 2
    x38 += lib.einsum("ab->ab", x34)
    del x34
    x90 = np.zeros((nocc, nocc), dtype=np.float64)
    x90 += lib.einsum("ijab,ikab->jk", t2, x33) * 2
    x94 = np.zeros((nocc, nocc), dtype=np.float64)
    x94 += lib.einsum("ij->ji", x90)
    del x90
    x35 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x35 += lib.einsum("iabc->ibac", v.ovvv) * 2
    x35 += lib.einsum("iabc->ibca", v.ovvv) * -1
    x36 = np.zeros((nvir, nvir), dtype=np.float64)
    x36 += lib.einsum("ia,ibac->bc", t1, x35)
    del x35
    x38 += lib.einsum("ab->ab", x36) * -1
    del x36
    x39 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x39 += lib.einsum("ab,cbi->ica", x38, r2) * 2
    x55 += lib.einsum("iab->iab", x39) * -1
    del x39
    x75 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x75 += lib.einsum("ab,bci->ica", x38, r2)
    del x38
    x97 += lib.einsum("iab->iab", x75)
    del x75
    x40 = np.zeros((nocc, nocc), dtype=np.float64)
    x40 += lib.einsum("ia,ja->ij", f.ov, t1)
    x45 = np.zeros((nocc, nocc), dtype=np.float64)
    x45 += lib.einsum("ij->ij", x40)
    del x40
    x41 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x41 += lib.einsum("ijab->jiba", t2)
    x41 += lib.einsum("ia,jb->ijab", t1, t1)
    x42 = np.zeros((nocc, nocc), dtype=np.float64)
    x42 += lib.einsum("ijab,ikab->jk", x33, x41) * 2
    del x33
    x45 += lib.einsum("ij->ij", x42)
    del x42
    x43 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x43 += lib.einsum("ijka->ikja", v.ooov) * -0.5
    x43 += lib.einsum("ijka->kija", v.ooov)
    x44 = np.zeros((nocc, nocc), dtype=np.float64)
    x44 += lib.einsum("ia,ijka->jk", t1, x43) * 2
    del x43
    x45 += lib.einsum("ij->ij", x44)
    x94 += lib.einsum("ij->ij", x44)
    del x44
    x45 += lib.einsum("ij->ij", f.oo)
    x46 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x46 += lib.einsum("ij,abi->jab", x45, r2) * 2
    del x45
    x55 += lib.einsum("iab->iab", x46) * -1
    del x46
    x48 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x48 += lib.einsum("a,ijba->ijb", r1, v.oovv)
    x51 += lib.einsum("ija->ija", x48)
    del x48
    x49 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x49 += lib.einsum("abi,jacb->ijc", r2, v.ovvv)
    x51 += lib.einsum("ija->jia", x49)
    del x49
    x52 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x52 += lib.einsum("ia,ijb->jab", t1, x51) * 2
    del x51
    x55 += lib.einsum("iab->iab", x52) * -1
    del x52
    x53 = np.zeros((nocc, nvir), dtype=np.float64)
    x53 += lib.einsum("ab,ib->ia", f.vv, t1)
    x54 = np.zeros((nocc, nvir), dtype=np.float64)
    x54 += lib.einsum("ia->ia", x53)
    del x53
    x54 += lib.einsum("ai->ia", f.vo)
    x55 += lib.einsum("a,ib->iba", r1, x54) * 2
    del x54
    r2new = np.zeros((nvir, nvir, nocc), dtype=np.float64)
    r2new += lib.einsum("iab->abi", x55) * -1
    r2new += lib.einsum("iab->bai", x55) * 0.5
    del x55
    x56 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x56 += lib.einsum("ab,cbi->iac", f.vv, r2)
    x97 += lib.einsum("iab->iab", x56) * -1
    del x56
    x57 = np.zeros((nvir, nvir, nvir), dtype=np.float64)
    x57 += lib.einsum("a,bacd->cbd", r1, v.vvvv)
    x58 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x58 += lib.einsum("ia,bca->icb", t1, x57)
    del x57
    x97 += lib.einsum("iab->iab", x58) * -1
    del x58
    x62 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x62 += lib.einsum("abi,icja->jbc", r2, v.ovov)
    x65 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x65 += lib.einsum("iab->iab", x62) * 0.5
    del x62
    x63 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x63 += lib.einsum("a,ib->iab", r1, t1)
    x63 += lib.einsum("abi->iab", r2) * -2
    x63 += lib.einsum("abi->iba", r2)
    x64 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x64 += lib.einsum("iab,iajc->jcb", x63, v.ovov) * 0.5
    del x63
    x65 += lib.einsum("iab->iba", x64)
    del x64
    x66 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x66 += lib.einsum("ijab->jiab", t2) * -0.5
    x66 += lib.einsum("ijab->jiba", t2)
    x67 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x67 += lib.einsum("iab,ijbc->jac", x65, x66) * 4
    del x65
    del x66
    x97 += lib.einsum("iab->iab", x67)
    del x67
    x68 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x68 += lib.einsum("abi->iab", r2) * -1
    x68 += lib.einsum("abi->iba", r2) * 2
    x69 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x69 += lib.einsum("ia,jbca->ijcb", t1, v.ovvv)
    x71 += lib.einsum("ijab->ijab", x69)
    del x69
    x71 += lib.einsum("iabj->jiba", v.ovvo)
    x72 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x72 += lib.einsum("iab,jicb->jac", x68, x71)
    del x68
    del x71
    x97 += lib.einsum("iab->iab", x72) * -1
    del x72
    x76 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x76 += lib.einsum("a,iabj->ijb", r1, v.ovvo)
    x80 += lib.einsum("ija->ija", x76)
    del x76
    x77 = np.zeros((nocc, nocc, nvir), dtype=np.float64)
    x77 += lib.einsum("abi,jbca->ijc", r2, v.ovvv)
    x80 += lib.einsum("ija->jia", x77)
    del x77
    x81 = np.zeros((nocc, nvir, nvir), dtype=np.float64)
    x81 += lib.einsum("ia,ijb->jab", t1, x80)
    del x80
    x97 += lib.einsum("iab->iab", x81)
    del x81
    x82 += lib.einsum("ijka->jika", v.ooov)
    x82 += lib.einsum("ijka->jkia", v.ooov) * -0.5
    x83 = np.zeros((nocc, nvir), dtype=np.float64)
    x83 += lib.einsum("ijab,kijb->ka", t2, x82) * 2
    del x82
    x96 = np.zeros((nocc, nvir), dtype=np.float64)
    x96 += lib.einsum("ia->ia", x83)
    del x83
    x84 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x84 += lib.einsum("iabc->ibac", v.ovvv) * -1
    x84 += lib.einsum("iabc->ibca", v.ovvv) * 2
    x85 = np.zeros((nocc, nvir), dtype=np.float64)
    x85 += lib.einsum("ijab,icba->jc", x41, x84)
    del x41
    del x84
    x96 += lib.einsum("ia->ia", x85) * -1
    del x85
    x86 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x86 += lib.einsum("ijab->jiab", t2) * -1
    x86 += lib.einsum("ijab->jiba", t2) * 2
    x87 = np.zeros((nocc, nvir), dtype=np.float64)
    x87 += lib.einsum("ia,ijab->jb", x6, x86)
    del x86
    del x6
    x96 += lib.einsum("ia->ia", x87) * -1
    del x87
    x88 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x88 += lib.einsum("iabj->ijba", v.ovvo) * 2
    x88 += lib.einsum("ijab->ijab", v.oovv) * -1
    x89 = np.zeros((nocc, nvir), dtype=np.float64)
    x89 += lib.einsum("ia,ijba->jb", t1, x88)
    del x88
    x96 += lib.einsum("ia->ia", x89) * -1
    del x89
    x91 = np.zeros((nocc, nvir), dtype=np.float64)
    x91 += lib.einsum("ia,jaib->jb", t1, v.ovov)
    x92 = np.zeros((nocc, nvir), dtype=np.float64)
    x92 += lib.einsum("ia->ia", x91) * -0.9999999999999996
    del x91
    x92 += lib.einsum("ia->ia", f.ov)
    x93 = np.zeros((nocc, nocc), dtype=np.float64)
    x93 += lib.einsum("ia,ja->ij", t1, x92)
    del x92
    x94 += lib.einsum("ij->ji", x93)
    del x93
    x94 += lib.einsum("ij->ij", f.oo)
    x95 = np.zeros((nocc, nvir), dtype=np.float64)
    x95 += lib.einsum("ia,ij->ja", t1, x94)
    del x94
    x96 += lib.einsum("ia->ia", x95)
    del x95
    x97 += lib.einsum("a,ib->iab", r1, x96)
    del x96
    r2new += lib.einsum("iab->abi", x97) * -1
    r2new += lib.einsum("iab->bai", x97) * 2
    del x97
    x98 = np.zeros((nocc, nvir), dtype=np.float64)
    x98 += lib.einsum("ia,jbia->jb", t1, v.ovov)
    x99 = np.zeros((nocc, nocc), dtype=np.float64)
    x99 += lib.einsum("ia,ja->ij", t1, x98)
    del x98
    x100 = np.zeros((nocc, nvir), dtype=np.float64)
    x100 += lib.einsum("ia,ji->ja", t1, x99)
    del x99
    r2new += lib.einsum("a,ib->abi", r1, x100) * -1.9999999999999991
    r2new += lib.einsum("a,ib->bai", r1, x100) * 3.999999999999999
    del x100
    r1new += lib.einsum("a,ba->b", r1, f.vv)

    r2new = r2new.swapaxes(0, 1)

    return r1new, r2new

def make_ip_mom_kets(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    ket2_o = np.zeros((nocc, nocc, nvir, nocc), dtype=np.float64)
    ket1_o = np.zeros((nocc, nocc), dtype=np.float64)
    ket1_o += lib.einsum("ij->ji", delta_oo) * 2
    ket1_v = np.zeros((nocc, nvir), dtype=np.float64)
    ket1_v += lib.einsum("ia->ia", t1) * 2
    ket2_v = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    #ket2_v += lib.einsum("ijab->jiab", t2) * 2
    #ket2_v -= lib.einsum("ijab->jiba", t2) * 4
    ket2_v -= lib.einsum("ijab->jiba", t2) * 2

    ket1 = np.concatenate([ket1_o, ket1_v], axis=1)
    ket2 = np.concatenate([ket2_o, ket2_v], axis=3)

    ket1 *= 0.5
    ket2 *= 0.5

    return ket1, ket2

def make_ea_mom_kets(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    ket2_v = np.zeros((nvir, nvir, nocc, nvir), dtype=np.float64)
    ket1_o = np.zeros((nvir, nocc), dtype=np.float64)
    ket1_o -= lib.einsum("ia->ai", t1) * 2
    ket1_v = np.zeros((nvir, nvir), dtype=np.float64)
    ket1_v += lib.einsum("ab->ba", delta_vv) * 2
    ket2_o = np.zeros((nvir, nvir, nocc, nocc), dtype=np.float64)
    ket2_o -= lib.einsum("ijab->abji", t2) * 2
    ket2_o += lib.einsum("ijab->baji", t2) * 4

    ket1 = np.concatenate([ket1_o, ket1_v], axis=1)
    ket2 = np.concatenate([ket2_o, ket2_v], axis=3)

    ket2 = ket2.swapaxes(0, 1)

    ket1 *= 0.5
    ket2 *= 0.5

    return ket1, ket2

def make_ip_mom_bras(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("ijab->jiab", t2) * 2
    x0 += lib.einsum("ijab->jiba", t2) * -1
    bra1_o = np.zeros((nocc, nocc), dtype=np.float64)
    bra1_o += lib.einsum("abij,ikba->kj", l2, x0) * -2
    del x0
    x1 = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    x1 += lib.einsum("ia,bajk->jkib", t1, l2)
    bra2_o = np.zeros((nocc, nocc, nocc, nvir), dtype=np.float64)
    bra2_o += lib.einsum("ijka->kija", x1) * 4
    bra2_o -= lib.einsum("ijka->kjia", x1) * 2
    del x1
    bra1_o -= lib.einsum("ai,ja->ji", l1, t1) * 2
    bra1_o += lib.einsum("ij->ji", delta_oo) * 2
    bra1_v = np.zeros((nvir, nocc), dtype=np.float64)
    bra1_v += lib.einsum("ai->ai", l1) * 2
    bra2_o += lib.einsum("ij,ak->jika", delta_oo, l1) * 2
    bra2_o -= lib.einsum("ij,ak->jkia", delta_oo, l1) * 4
    bra2_v = np.zeros((nvir, nocc, nocc, nvir), dtype=np.float64)
    bra2_v -= lib.einsum("abij->ajib", l2) * 4
    bra2_v += lib.einsum("abij->bjia", l2) * 2

    bra1 = np.concatenate([bra1_o, bra1_v], axis=0)
    bra2 = np.concatenate([bra2_o, bra2_v], axis=0)

    bra1 *= 0.5
    bra2 *= 0.5

    return bra1, bra2

def make_ea_mom_bras(f=None, v=None, nocc=None, nvir=None, t1=None, t2=None, l1=None, l2=None, **kwargs):
    delta_oo = np.eye(nocc)
    delta_vv = np.eye(nvir)

    x0 = np.zeros((nocc, nocc, nvir, nvir), dtype=np.float64)
    x0 += lib.einsum("ijab->jiab", t2) * -1
    x0 += lib.einsum("ijab->jiba", t2) * 2
    bra1_v = np.zeros((nvir, nvir), dtype=np.float64)
    bra1_v += lib.einsum("abij,ijcb->ca", l2, x0) * -2
    del x0
    x1 = np.zeros((nocc, nvir, nvir, nvir), dtype=np.float64)
    x1 += lib.einsum("ia,bcji->jbca", t1, l2)
    bra2_v = np.zeros((nvir, nvir, nvir, nocc), dtype=np.float64)
    bra2_v -= lib.einsum("iabc->cabi", x1) * 4
    bra2_v += lib.einsum("iabc->cbai", x1) * 2
    del x1
    bra1_o = np.zeros((nocc, nvir), dtype=np.float64)
    bra1_o -= lib.einsum("ai->ia", l1) * 2
    bra1_v += lib.einsum("ab->ba", delta_vv) * 2
    bra1_v -= lib.einsum("ai,ib->ba", l1, t1) * 2
    bra2_o = np.zeros((nocc, nvir, nvir, nocc), dtype=np.float64)
    bra2_o -= lib.einsum("abij->jabi", l2) * 4
    bra2_o += lib.einsum("abij->jbai", l2) * 2
    bra2_v -= lib.einsum("ab,ci->baci", delta_vv, l1) * 2
    bra2_v += lib.einsum("ab,ci->bcai", delta_vv, l1) * 4

    bra1 = np.concatenate([bra1_o, bra1_v], axis=0)
    bra2 = np.concatenate([bra2_o, bra2_v], axis=0)

    bra1 *= 0.5
    bra2 *= 0.5

    return bra1, bra2


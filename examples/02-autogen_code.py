import numpy as np
import math
import pyscf
from pyscf import ao2mo, gto, scf
from ebcc import ebccsd

# Set up ab initio system with random e-b couplings
mol = pyscf.M(
    atom = 'H 0 0 0; F 0 0 1.1',  # in Angstrom
    basis = '6-31G',
    symmetry = True,
    verbose=1
)

myhf = mol.RHF().run()
nmo = myhf.mo_coeff.shape[1]
nbos = 5
# Boson energies and couplings to AO density
gmat = np.random.random((nbos,nmo,nmo)) * 0.02
# Note that the optimized code only (I think) works with symmetric e-b couplings wrt fermionic indices
gmat = (gmat + gmat.transpose((0,2,1))) / 2.     
omega = np.random.random((nbos)) * 5.

# Options for thresholds, iterations and damping
options = {"ethresh":1e-10, 'tthresh':1e-9, 'max_iter':500, 'damp':0.3}

# Loop over different ebcc ansatz (rank of fermion operator, rank of boson operator, and rank of boson operator in the coupling to single excitations)
for rank in [(2,0,0), (2,1,1), (2,2,1), (2,2,2)]:
    for shift in [True, False]:
        # Loop over whether to evaluate in the bosonic basis or not (whether to remove couplings to MF density)
        cc = ebccsd.EBCCSD.fromUHFobj(myhf, options={'diis space': 8}, rank=rank, omega=omega, gmat=gmat, shift=shift, autogen_code=False)
        e_corr = cc.kernel()
        etot = e_corr + myhf.e_tot - cc.const
        print('EBCCSD correlation energy for rank {} and shift {}:   {}'.format(rank,shift,cc.e_corr))
        print('EBCCSD total energy', etot)
        
        # Compare results to unoptimized autogenerated code (and DIIS vs. non-diis)
        cc_autogen = ebccsd.EBCCSD.fromUHFobj(myhf, options=options, rank=rank, omega=omega, gmat=gmat, shift=shift,
                                   autogen_code=True)
        e_corr_auto = cc_autogen.kernel()
        etot_auto = e_corr_auto + myhf.e_tot - cc_autogen.const

        if np.allclose(cc.e_corr, cc_autogen.e_corr):
            print('**********************************************************************')
            print('EXCELLENT: CCSD correlation energies agree between autogenerated code and optimized code')
            print('**********************************************************************')
        else:
            print('Auto vs. non-auto code correlation energies do not agree...')
            assert(np.allclose(cc.e_corr, cc_autogen.e_corr))
